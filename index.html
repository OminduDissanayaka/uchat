<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UChat - Groups, Rooms & Direct</title>
    
    <!-- Scripts & Styles -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a',
                        darker: '#020617',
                        primary: '#6366f1',
                        secondary: '#1e293b',
                        accent: '#8b5cf6',
                        incoming: '#1f2937',
                        outgoing: '#4f46e5'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'zoom-in': 'zoomIn 0.2s ease-out forwards',
                        'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        zoomIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 10px; }
        body { -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .sidebar-glass { background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(16px); }
        .chat-bubble { box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* Video Grid Styling */
        .video-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 10px;
            width: 100%;
            height: 100%;
            overflow: auto;
        }
        .video-card {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
            flex: 1 1 300px; /* Responsive flex */
            max-width: 100%;
            aspect-ratio: 16/9;
        }
        .video-card video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror by default for cam */
        }
        /* Screen share shouldn't be mirrored */
        .video-card video.no-mirror {
            transform: scaleX(1);
        }
        
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        /* Play Icon Overlay for Video Previews */
        .play-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 40px; height: 40px;
            background: rgba(0,0,0,0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        /* Audio Player Styling */
        audio {
            height: 32px;
            max-width: 200px;
        }
        audio::-webkit-media-controls-panel {
            background-color: rgba(255, 255, 255, 0.8);
        }
        
        /* Hide input area elements when needed */
        .hide-input { display: none !important; }
    </style>
</head>
<body class="bg-darker text-gray-100 font-sans h-[100dvh] overflow-hidden flex flex-col md:flex-row">

    <!-- Media Modal (Images & Videos) -->
    <div id="media-modal" class="fixed inset-0 z-[100] bg-black/95 hidden flex flex-col items-center justify-center p-2 backdrop-blur-sm" onclick="closeMediaModal()">
        <button class="absolute top-4 right-4 text-white bg-black/50 rounded-full w-10 h-10 flex items-center justify-center z-[101] hover:bg-red-600 transition"><i class="fas fa-times"></i></button>
        
        <!-- Image Container -->
        <img id="modal-image" src="" class="hidden max-w-full max-h-[80vh] object-contain rounded-lg animate-zoom-in" onclick="event.stopPropagation()">
        
        <!-- Video Container -->
        <video id="modal-video" src="" controls class="hidden max-w-full max-h-[80vh] rounded-lg animate-zoom-in" onclick="event.stopPropagation()"></video>

        <a id="modal-download" href="#" download class="mt-4 bg-gray-800 text-white px-6 py-2 rounded-full flex items-center gap-2 hover:bg-primary transition" onclick="event.stopPropagation()"><i class="fas fa-download"></i> Save</a>
    </div>

    <!-- Toast -->
    <div id="toast-container" class="fixed top-20 right-5 left-5 md:left-auto md:w-auto z-[60] flex flex-col gap-2 pointer-events-none"></div>

    <!-- Sidebar Backdrop -->
    <div id="sidebar-backdrop" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 z-20 hidden md:hidden backdrop-blur-sm"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-[85%] max-w-sm md:w-80 sidebar-glass border-r border-gray-700/50 flex flex-col transform -translate-x-full md:translate-x-0 md:relative transition-transform duration-300 shadow-2xl">
        <div class="p-5 border-b border-gray-700/50 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-accent flex items-center justify-center shadow-lg"><i class="fas fa-bolt text-white"></i></div>
                <div>
                    <h1 class="text-xl font-bold text-white">UChat</h1>
                    <p class="text-[10px] text-gray-400 font-medium tracking-widest">CONNECT FREELY</p>
                </div>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden w-10 h-10 flex items-center justify-center text-gray-400 bg-white/5 rounded-full"><i class="fas fa-chevron-left"></i></button>
        </div>

        <div class="p-5 flex-1 overflow-y-auto space-y-6">
            <!-- Profile -->
            <div class="bg-secondary/50 p-4 rounded-2xl border border-gray-700/50">
                <label class="text-[10px] text-gray-400 font-bold mb-2 block">YOUR PROFILE</label>
                <input type="text" id="my-name-input" value="User" class="w-full bg-dark/50 text-white p-2 rounded-lg text-sm mb-3 focus:outline-none border border-gray-600/30" onblur="updateMyName()">
                <div class="flex items-center justify-between bg-dark/80 p-3 rounded-xl cursor-pointer hover:bg-dark border border-primary/20" onclick="copyId()">
                    <div class="overflow-hidden mr-2">
                        <p class="text-[10px] text-gray-500 font-bold">YOUR ID</p>
                        <p id="my-id" class="text-lg text-primary font-mono truncate font-bold tracking-widest">--- ---</p>
                    </div>
                    <i class="far fa-copy text-primary"></i>
                </div>
            </div>

            <!-- Host Actions --> 
            <div>
                <label class="text-[10px] text-gray-400 font-bold mb-2 block">HOST A SESSION</label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setMode('room')" id="btn-create-room" class="p-3 rounded-xl bg-gray-800 hover:bg-gray-700 border border-gray-700 flex flex-col items-center gap-1 transition">
                        <i class="fas fa-video text-pink-400 text-lg"></i>
                        <span class="text-xs font-bold">Host Room</span>
                    </button>
                    <button onclick="setMode('group')" id="btn-create-group" class="p-3 rounded-xl bg-gray-800 hover:bg-gray-700 border border-gray-700 flex flex-col items-center gap-1 transition">
                        <i class="fas fa-users text-blue-400 text-lg"></i>
                        <span class="text-xs font-bold">Host Group</span>
                    </button>
                </div>
            </div>

            <!-- Connect Form -->
            <div>
                <label class="text-[10px] text-gray-400 font-bold mb-2 block">CONNECT TO ID</label>
                <div class="flex flex-col gap-3">
                    <div class="relative">
                        <i class="fas fa-fingerprint absolute left-3 top-3.5 text-gray-500"></i>
                        <input type="number" id="remote-id" placeholder="Enter 6-digit ID" class="w-full bg-dark/50 border border-gray-700 rounded-xl py-3 pl-10 pr-3 text-sm focus:border-primary focus:outline-none tracking-widest font-mono">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="connectDirect()" id="btn-direct" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl transition shadow-lg flex flex-col items-center justify-center">
                            <i class="fas fa-user-friends mb-1"></i>
                            <span class="text-[10px]">1v1 DIRECT</span>
                        </button>
                        <button onclick="joinPeer()" id="btn-join" class="bg-primary hover:bg-blue-600 text-white font-bold py-3 rounded-xl transition shadow-lg flex flex-col items-center justify-center">
                            <i class="fas fa-sign-in-alt mb-1"></i>
                            <span class="text-[10px]">JOIN HOST</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Status -->
            <div id="status-card" class="hidden p-4 rounded-xl bg-green-500/10 border border-green-500/20">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center border border-gray-600">
                        <i id="status-icon" class="fas fa-check text-green-400"></i>
                    </div>
                    <div>
                        <p class="text-sm font-bold text-white" id="connection-mode-display">Connected</p>
                        <p class="text-[10px] text-green-400 font-medium"><span id="peer-count">1</span> Connection(s)</p>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative h-full z-10 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] bg-fixed">
        
        <!-- Navbar -->
        <header class="h-16 glass flex items-center justify-between px-4 z-20 shadow-md">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="md:hidden text-gray-300 text-xl"><i class="fas fa-bars"></i></button>
                <div>
                    <h2 class="font-bold text-white text-base truncate" id="header-title">UChat</h2>
                    <div class="flex items-center gap-1.5">
                        <div id="header-status-dot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                        <span class="text-[10px] text-gray-400 font-medium" id="header-status-text">Disconnected</span>
                    </div>
                </div>
            </div>
            
            <!-- Controls (Visible in Room & Direct Mode) -->
            <div id="media-controls" class="hidden flex gap-2">
                <button onclick="toggleAudio()" id="btn-mic" class="w-10 h-10 rounded-full bg-gray-800 text-white border border-white/10 flex items-center justify-center hover:bg-gray-700 transition relative">
                    <i class="fas fa-microphone-slash"></i>
                </button>
                <button onclick="toggleVideo()" id="btn-cam" class="w-10 h-10 rounded-full bg-gray-800 text-white border border-white/10 flex items-center justify-center hover:bg-gray-700 transition relative">
                    <i class="fas fa-video-slash"></i>
                </button>
                <button onclick="toggleScreenShare()" id="btn-screen" class="w-10 h-10 rounded-full bg-gray-800 text-white border border-white/10 flex items-center justify-center hover:bg-gray-700 transition relative" title="Share Screen">
                    <i class="fas fa-desktop"></i>
                </button>
                <button onclick="leaveSession()" class="w-10 h-10 rounded-full bg-red-600 text-white flex items-center justify-center hover:bg-red-700 transition shadow-lg"><i class="fas fa-phone-slash"></i></button>
            </div>
        </header>

        <!-- Video Grid (Room & Direct Only) -->
        <div id="video-area" class="hidden flex-1 p-2 bg-black/40 backdrop-blur-sm relative transition-all duration-300">
            <div id="video-grid" class="video-grid">
                <!-- Local Video -->
                <div class="video-card hidden" id="local-video-card">
                    <video id="local-video" autoplay muted playsinline></video>
                    <div class="absolute bottom-2 left-2 bg-black/60 px-2 py-1 rounded text-[10px] text-white flex items-center gap-1"><i class="fas fa-user"></i> You</div>
                </div>
                <!-- Remote videos will be added here -->
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-3 scroll-smooth pb-20">
            <div class="flex flex-col items-center justify-center h-[80%] text-gray-600 opacity-40 select-none px-6 text-center">
                <i class="fas fa-paper-plane text-4xl mb-3"></i>
                <h3 class="text-lg font-bold">Ready to Connect</h3>
                <p class="text-xs">Create a Room/Group or Enter ID to Direct Connect.</p>
            </div>
        </div>

        <!-- Attachment Menu -->
        <div id="attachment-overlay" class="fixed inset-0 bg-black/50 z-20 hidden backdrop-blur-sm" onclick="toggleAttachmentMenu()"></div>
        <div id="attachment-menu" class="hidden absolute bottom-20 left-4 bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl p-2 flex flex-col gap-1 w-64 animate-fade-in z-30">
            <button onclick="triggerFileSelect('media')" class="flex items-center gap-3 p-3 hover:bg-gray-700 rounded-xl text-left transition"><i class="fas fa-photo-video text-purple-400"></i> <span class="text-sm font-bold text-gray-200">Media (Img/Vid)</span></button>
            <button onclick="triggerFileSelect('file')" class="flex items-center gap-3 p-3 hover:bg-gray-700 rounded-xl text-left transition"><i class="fas fa-file-alt text-blue-400"></i> <span class="text-sm font-bold text-gray-200">File (5GB)</span></button>
        </div>

        <!-- Input Area -->
        <div class="p-2 md:p-4 bg-darker/90 backdrop-blur-md border-t border-gray-800 z-20 flex-shrink-0 safe-area-bottom">
            <div id="typing-indicator" class="hidden text-[10px] text-primary ml-12 mb-1 font-medium">Someone is typing <span class="typing-dot">.</span><span class="typing-dot">.</span><span class="typing-dot">.</span></div>
            <div class="flex items-end gap-2 max-w-5xl mx-auto">
                <button onclick="toggleAttachmentMenu()" class="w-11 h-11 rounded-full bg-gray-800 text-gray-400 hover:text-white transition flex-shrink-0" id="btn-attach"><i class="fas fa-plus transform transition-transform" id="plus-icon"></i></button>
                <input type="file" id="file-input-media" accept="image/*,video/*" class="hidden" onchange="handleFileSelect(this, 'media')">
                <input type="file" id="file-input-doc" class="hidden" onchange="handleFileSelect(this, 'file')">
                
                <!-- Main Input Container -->
                <div class="flex-1 bg-gray-800 rounded-3xl border border-gray-700/50 flex items-center px-4 py-1.5 focus-within:border-primary/50 transition relative overflow-hidden h-[46px]">
                    
                    <!-- Text Area (Visible when not recording) -->
                    <textarea id="msg-input" rows="1" placeholder="Type a message..." class="w-full bg-transparent text-white resize-none focus:outline-none max-h-32 min-h-[40px] text-sm py-2.5" oninput="autoResize(this); handleTyping()" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>

                    <!-- Recording UI (Visible when recording) -->
                    <div id="recording-ui" class="hidden absolute inset-0 bg-gray-800 z-50 flex items-center justify-between px-2 w-full h-full">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse-slow"></div>
                            <span class="text-white text-sm font-mono" id="rec-time">00:00</span>
                        </div>
                        <span class="text-xs text-gray-400 animate-pulse hidden md:block">Recording Audio...</span>
                        <div class="flex items-center gap-2">
                             <button onclick="cancelRecording()" class="w-8 h-8 rounded-full bg-gray-700 text-white hover:bg-red-600 transition flex items-center justify-center" title="Cancel"><i class="fas fa-trash"></i></button>
                             <button onclick="stopAndSendRecording()" class="w-8 h-8 rounded-full bg-primary text-white hover:bg-blue-600 transition flex items-center justify-center" title="Send"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Record Button -->
                <button id="btn-record-toggle" onclick="startRecording()" class="w-11 h-11 rounded-full bg-gray-800 text-gray-400 hover:text-red-500 transition shadow-lg flex-shrink-0"><i class="fas fa-microphone"></i></button>

                <!-- Send Button (Initially Hidden if using mic as primary, or visible) -->
                <button id="btn-send-text" onclick="sendMessage()" class="w-11 h-11 rounded-full bg-primary hover:bg-blue-600 text-white transition shadow-lg flex-shrink-0"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </main>

    <script>
        // --- Configuration & State ---
        const MAX_FILE_SIZE = 5 * 1024 * 1024 * 1024; // 5GB
        let peer, localStream;
        let myName = localStorage.getItem('uchat_name') || "User";
        let myMode = 'idle'; 
        let connections = []; // For Host: Array of clients. For Direct: [connection].
        let hostConn = null; // For Client: Connection to host.
        let calls = []; // Stores MediaConnections
        let isHost = false;

        // Media State
        let isScreenSharing = false;
        let camStream = null; 

        // Recording State
        let mediaRecorder;
        let audioChunks = [];
        let recordingInterval;
        let recordingStartTime;
        let isRecordingCancelled = false;

        // --- Init ---
        window.onload = () => {
            document.getElementById('my-name-input').value = myName;
            initPeer();
        };

        function initPeer() {
            // Generate a random 6-digit ID
            const randomId = Math.floor(100000 + Math.random() * 900000).toString();
            
            peer = new Peer(randomId, { debug: 1 });
            
            peer.on('open', (id) => {
                document.getElementById('my-id').innerText = id;
                showToast(`Your ID: ${id}`, "success");
            });
            peer.on('connection', handleIncomingConnection);
            peer.on('call', handleIncomingCall);
            peer.on('error', (err) => {
                if(err.type === 'unavailable-id') {
                    initPeer(); 
                } else {
                    showToast("Error: " + err.type, "error");
                }
            });
        }

        // --- Mode Handling ---
        
        function setMode(mode) {
            if (connections.length > 0 || hostConn) {
                if(!confirm("Start new session? Current connections will be lost.")) return;
                resetSession();
            }
            
            isHost = true;
            myMode = mode === 'room' ? 'host-room' : 'host-group';
            
            updateUIForMode(myMode);
            showToast(`${mode === 'room' ? 'Room' : 'Group'} Created! Share your ID.`, "success");
            
            if(myMode === 'host-room') startLocalVideo();
        }

        function joinPeer() {
            const id = document.getElementById('remote-id').value.trim();
            if(!id || id.length !== 6) return showToast("Enter valid 6-digit ID", "error");
            if(id === peer.id) return showToast("Cannot join self", "error");

            if(connections.length > 0 || hostConn) resetSession();

            isHost = false;
            document.getElementById('btn-join').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            hostConn = peer.connect(id, { metadata: { type: 'join-request' } });
            setupDataConnection(hostConn);
        }

        function connectDirect() {
            const id = document.getElementById('remote-id').value.trim();
            if(!id || id.length !== 6) return showToast("Enter 6-digit Peer ID", "error");
            if(id === peer.id) return showToast("Cannot connect to self", "error");

            if(connections.length > 0 || hostConn) resetSession();

            isHost = false; 
            myMode = 'direct';
            
            document.getElementById('btn-direct').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            const conn = peer.connect(id, { metadata: { type: 'direct' } });
            setupDataConnection(conn);
            connections.push(conn);
            
            updateUIForMode('direct');
        }

        // --- Connection Logic ---
        function handleIncomingConnection(conn) {
            const meta = conn.metadata || {};

            if (isHost) {
                if (myMode === 'host-room' && connections.length >= 4) { 
                    conn.on('open', () => { conn.send({type:'system', msg:'Room Full'}); setTimeout(()=>conn.close(),500); });
                    return;
                }
                setupDataConnection(conn);
            } 
            else if (meta.type === 'direct') {
                if (myMode !== 'idle' && myMode !== 'direct') {
                    conn.on('open', () => { conn.send({type:'system', msg:'User busy'}); setTimeout(()=>conn.close(),500); });
                    return;
                }
                
                if(confirm(`Incoming Direct Chat from ${conn.peer}. Accept?`)) {
                    resetSession(); 
                    myMode = 'direct';
                    isHost = false;
                    connections.push(conn); 
                    setupDataConnection(conn);
                    updateUIForMode('direct');
                } else {
                    conn.on('open', () => conn.close());
                }
            }
            else {
                conn.on('open', () => conn.close());
            }
        }

        function setupDataConnection(conn) {
            conn.on('open', () => {
                const isStored = connections.find(c => c.peer === conn.peer);
                if((isHost || myMode === 'direct') && !isStored) connections.push(conn);
                
                conn.send({ type: 'meta', sub: 'handshake', name: myName, mode: myMode }); 

                updateConnectionStatus();
                
                if(isHost) {
                    broadcastData({ type: 'system', msg: 'New user joined' }, conn.peer);
                    if(myMode === 'host-room') {
                        const peerList = connections.map(c => c.peer).filter(id => id !== conn.peer);
                        conn.send({ type: 'meta', sub: 'peer-list', peers: peerList });
                    }
                }
                if(myMode === 'direct') {
                     showToast("Direct Connection Established", "success");
                     document.getElementById('btn-direct').innerHTML = '<i class="fas fa-user-friends mb-1"></i><span class="text-[10px]">1v1 DIRECT</span>';
                }
            });

            conn.on('data', (data) => handleData(data, conn));
            conn.on('close', () => handleDisconnect(conn.peer));
            conn.on('error', () => showToast("Connection Error", "error"));
        }

        function handleDisconnect(peerId) {
            connections = connections.filter(c => c.peer !== peerId);
            if(hostConn && hostConn.peer === peerId) hostConn = null;

            removeRemoteVideo(peerId);

            if(isHost) broadcastData({ type: 'system', msg: 'User disconnected' });
            else if (myMode === 'direct') {
                showToast("User Disconnected", "warning");
                resetSession();
            } else {
                showToast("Host Disconnected", "error");
                resetSession();
            }
            updateConnectionStatus();
        }

        // --- Data Handling ---
        function handleData(data, conn) {
            if (isHost) broadcastData(data, conn.peer); 

            switch (data.type) {
                case 'text':
                    appendMessage(data.content, 'in', data.sender);
                    break;
                case 'file':
                    handleIncomingFile(data);
                    break;
                case 'meta':
                    if(data.sub === 'handshake') {
                        if(myMode === 'idle' && !isHost && !connections.length) { 
                            if(data.mode === 'host-room') myMode = 'client-room';
                            else if(data.mode === 'host-group') myMode = 'client-group';
                            
                            updateUIForMode(myMode);
                            if(myMode === 'client-room') startLocalVideo();
                            showToast(`Joined ${data.name}`, "success");
                            document.getElementById('btn-join').innerHTML = '<i class="fas fa-sign-in-alt mb-1"></i><span class="text-[10px]">JOIN HOST</span>';
                        }
                    } else if (data.sub === 'peer-list') {
                        if(myMode === 'client-room') connectToPeersForVideo(data.peers);
                    }
                    break;
                case 'system':
                    showToast(data.msg, "info");
                    break;
            }
        }

        function broadcastData(data, excludePeerId = null) {
            connections.forEach(c => {
                if (c.peer !== excludePeerId && c.open) c.send(data);
            });
        }

        function sendMessage() {
            const text = document.getElementById('msg-input').value.trim();
            if(!text) return;
            
            const payload = { type: 'text', content: text, sender: myName };
            
            if (isHost || myMode === 'direct') broadcastData(payload); 
            else if (hostConn && hostConn.open) hostConn.send(payload); 
            else return showToast("Not connected", "error");
            
            appendMessage(text, 'out', 'Me');
            document.getElementById('msg-input').value = '';
        }

        // --- Voice Recording (FIXED) ---
        function startRecording() {
            if (!isHost && (!hostConn || !hostConn.open) && myMode !== 'direct') return showToast("Connect to someone first!", "error");
            
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    // Supported mime types check
                    let mimeType = 'audio/webm';
                    if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                        mimeType = 'audio/webm;codecs=opus';
                    } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                        mimeType = 'audio/mp4'; // Safari
                    }

                    mediaRecorder = new MediaRecorder(stream, { mimeType });
                    audioChunks = [];
                    isRecordingCancelled = false;
                    
                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = () => {
                        // Stop all tracks
                        stream.getTracks().forEach(track => track.stop());
                        clearInterval(recordingInterval);

                        if (isRecordingCancelled) {
                            audioChunks = [];
                            return; // Don't send
                        }

                        if (audioChunks.length === 0) return;

                        const audioBlob = new Blob(audioChunks, { type: mimeType });
                        // Add proper extension based on type
                        const ext = mimeType.includes('mp4') ? 'mp4' : 'webm';
                        const voiceFile = new File([audioBlob], `voice_${Date.now()}.${ext}`, { type: mimeType });
                        
                        const payload = {
                            type: 'file',
                            file: voiceFile,
                            filename: voiceFile.name,
                            filetype: voiceFile.type,
                            filesize: voiceFile.size,
                            previewType: 'voice',
                            sender: myName
                        };

                        if(isHost || myMode === 'direct') broadcastData(payload);
                        else if(hostConn) hostConn.send(payload);

                        const url = URL.createObjectURL(audioBlob);
                        appendVoiceMessage(url, 'out', 'Me');
                    };

                    mediaRecorder.start();
                    
                    // UI Update: Show recording UI overlay absolute over input
                    const recUI = document.getElementById('recording-ui');
                    const msgInput = document.getElementById('msg-input');
                    
                    recUI.classList.remove('hidden');
                    msgInput.classList.add('opacity-0'); // Hide text but keep layout space if needed, or simply overlay
                    
                    // Disable other buttons
                    document.getElementById('btn-record-toggle').classList.add('text-red-500', 'animate-pulse');
                    
                    recordingStartTime = Date.now();
                    recordingInterval = setInterval(() => {
                        const diff = Date.now() - recordingStartTime;
                        const seconds = Math.floor((diff / 1000) % 60);
                        const minutes = Math.floor((diff / 1000 / 60));
                        document.getElementById('rec-time').innerText = 
                            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }, 1000);
                }).catch(err => {
                    console.error(err);
                    showToast("Microphone access denied", "error");
                });
        }

        function stopAndSendRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                isRecordingCancelled = false;
                mediaRecorder.stop();
                resetRecordingUI();
            }
        }

        function cancelRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                isRecordingCancelled = true;
                mediaRecorder.stop();
                resetRecordingUI();
                showToast("Recording cancelled", "info");
            }
        }

        function resetRecordingUI() {
            const recUI = document.getElementById('recording-ui');
            const msgInput = document.getElementById('msg-input');
            
            recUI.classList.add('hidden');
            msgInput.classList.remove('opacity-0');
            
            document.getElementById('rec-time').innerText = "00:00";
            document.getElementById('btn-record-toggle').classList.remove('text-red-500', 'animate-pulse');
        }

        // --- File Handling ---
        function handleIncomingFile(data) {
            const blob = new Blob([data.file], {type: data.filetype});
            const url = URL.createObjectURL(blob);
            
            if (data.previewType === 'image') appendImageMessage(url, 'in', data.sender, data.filename);
            else if (data.previewType === 'video') appendVideoMessage(url, 'in', data.sender, data.filename);
            else if (data.previewType === 'voice') appendVoiceMessage(url, 'in', data.sender);
            else appendFileMessage(data.filename, data.filesize, 'in', url, data.filetype, data.sender);
        }

        function triggerFileSelect(mode) {
            toggleAttachmentMenu();
            document.getElementById(mode === 'media' ? 'file-input-media' : 'file-input-doc').click();
        }

        function handleFileSelect(input, mode) {
            const file = input.files[0];
            if(!file) return;
            if(file.size > MAX_FILE_SIZE) { alert("File too large (>5GB)"); return; }
            if(file.size > 500*1024*1024 && !confirm("Large file. Continue?")) return;

            showToast("Sending file...", "info");
            
            let previewType = null;
            if (mode === 'media') {
                if (file.type.startsWith('image/')) previewType = 'image';
                else if (file.type.startsWith('video/')) previewType = 'video';
            }

            const payload = {
                type: 'file',
                file: file,
                filename: file.name,
                filetype: file.type,
                filesize: file.size,
                previewType: previewType,
                sender: myName
            };

            if(isHost || myMode === 'direct') broadcastData(payload);
            else if(hostConn) hostConn.send(payload);

            const url = URL.createObjectURL(file);
            if (previewType === 'image') appendImageMessage(url, 'out', 'Me', file.name);
            else if (previewType === 'video') appendVideoMessage(url, 'out', 'Me', file.name);
            else appendFileMessage(file.name, file.size, 'out', url, file.type, 'Me');

            input.value = '';
        }

        // --- Video/Screen/Audio Logic ---
        async function startLocalVideo() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                camStream = localStream; // Store reference to camera
                
                const videoEl = document.getElementById('local-video');
                videoEl.srcObject = localStream;
                videoEl.classList.remove('no-mirror'); // Mirror cam by default
                document.getElementById('local-video-card').classList.remove('hidden');
                
                setVideoLayout(true);
                updateMediaIcons(true, true, false);

                if(!isHost && hostConn && myMode === 'client-room') {
                    const call = peer.call(hostConn.peer, localStream);
                    handleCall(call);
                }
                if(myMode === 'direct' && connections.length > 0) {
                     const call = peer.call(connections[0].peer, localStream);
                     handleCall(call);
                }
            } catch (e) {
                console.error(e);
                showToast("Camera/Mic access denied", "error");
            }
        }

        async function toggleScreenShare() {
            if(!localStream) {
                 showToast("Start video first", "error");
                 return;
            }

            if(isScreenSharing) {
                // Stop screen share -> switch back to cam
                stopScreenShare();
            } else {
                // Start screen share
                try {
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    const screenTrack = screenStream.getVideoTracks()[0];
                    
                    // Handle user clicking "Stop sharing" via browser UI
                    screenTrack.onended = () => stopScreenShare();

                    // Replace track in localStream
                    const videoSender = localStream.getVideoTracks()[0];
                    localStream.removeTrack(videoSender);
                    localStream.addTrack(screenTrack);
                    
                    // Update local video element
                    const videoEl = document.getElementById('local-video');
                    videoEl.srcObject = null; // Reset to force update
                    videoEl.srcObject = localStream;
                    videoEl.classList.add('no-mirror'); // Don't mirror screen

                    // Replace track for all active calls
                    calls.forEach(call => {
                        const sender = call.peerConnection.getSenders().find(s => s.track.kind === 'video');
                        if(sender) sender.replaceTrack(screenTrack);
                    });

                    isScreenSharing = true;
                    updateMediaIcons(localStream.getAudioTracks()[0].enabled, true, true);

                } catch(e) {
                    console.error("Screen share error", e);
                }
            }
        }

        function stopScreenShare() {
             if(!isScreenSharing || !camStream) return;
             
             // Get original cam track
             const camTrack = camStream.getVideoTracks()[0];
             
             // Remove screen track
             const screenTrack = localStream.getVideoTracks()[0];
             screenTrack.stop(); // Stop the screen stream
             localStream.removeTrack(screenTrack);
             localStream.addTrack(camTrack);
             
             // Update local UI
             const videoEl = document.getElementById('local-video');
             videoEl.srcObject = null;
             videoEl.srcObject = localStream;
             videoEl.classList.remove('no-mirror');

             // Update peers
             calls.forEach(call => {
                const sender = call.peerConnection.getSenders().find(s => s.track.kind === 'video');
                if(sender) sender.replaceTrack(camTrack);
             });

             isScreenSharing = false;
             updateMediaIcons(localStream.getAudioTracks()[0].enabled, true, false);
        }

        function connectToPeersForVideo(peerList) {
            peerList.forEach(pid => {
                if(pid !== peer.id) {
                    const call = peer.call(pid, localStream);
                    handleCall(call);
                }
            });
        }

        function handleIncomingCall(call) {
            if (myMode.includes('room') || myMode === 'direct') {
                setVideoLayout(true);

                if(!localStream) {
                     call.answer(); 
                     handleCall(call);
                     showToast("Incoming Video/Audio...", "info");
                } else {
                    call.answer(localStream);
                    handleCall(call);
                }
            } else {
                call.close(); 
            }
        }

        function handleCall(call) {
            calls.push(call);
            const videoId = `video-${call.peer}`;
            if(!document.getElementById(videoId)) addRemoteVideoElement(videoId, call.peer);

            call.on('stream', (remoteStream) => {
                const vid = document.getElementById(videoId);
                if(vid) vid.srcObject = remoteStream;
            });

            call.on('close', () => removeRemoteVideo(call.peer));
        }

        function addRemoteVideoElement(id, peerId) {
            const container = document.getElementById('video-grid');
            const card = document.createElement('div');
            card.className = "video-card animate-zoom-in";
            card.id = `card-${peerId}`;
            
            card.innerHTML = `
                <video id="${id}" autoplay playsinline></video>
                <div class="absolute bottom-2 left-2 bg-black/60 px-2 py-1 rounded text-[10px] text-white flex items-center gap-1"><i class="fas fa-user-circle"></i> Remote</div>
            `;
            container.appendChild(card);
            setVideoLayout(true);
        }

        function removeRemoteVideo(peerId) {
            const card = document.getElementById(`card-${peerId}`);
            if(card) card.remove();
        }

        function setVideoLayout(showVideo) {
            const videoArea = document.getElementById('video-area');
            const chatBox = document.getElementById('chat-box');

            if(showVideo) {
                videoArea.classList.remove('hidden');
                chatBox.style.height = "50%"; 
            } else {
                videoArea.classList.add('hidden');
                chatBox.style.height = "auto"; 
            }
        }

        function toggleAudio() {
            if(!localStream) { startLocalVideo(); return; }
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            updateMediaIcons(track.enabled, localStream.getVideoTracks()[0].enabled, isScreenSharing);
        }

        function toggleVideo() {
            if(!localStream) { startLocalVideo(); return; }
            if(isScreenSharing) { showToast("Stop screen share to toggle camera", "warning"); return; }
            
            const track = localStream.getVideoTracks()[0];
            track.enabled = !track.enabled;
            updateMediaIcons(localStream.getAudioTracks()[0].enabled, track.enabled, isScreenSharing);
        }
        
        function updateMediaIcons(audioOn, videoOn, screenOn) {
            const btnMic = document.getElementById('btn-mic');
            const btnCam = document.getElementById('btn-cam');
            const btnScreen = document.getElementById('btn-screen');
            
            if(audioOn) {
                btnMic.classList.remove('bg-gray-800', 'text-white');
                btnMic.classList.add('bg-white', 'text-black');
                btnMic.innerHTML = '<i class="fas fa-microphone"></i>';
            } else {
                btnMic.classList.add('bg-gray-800', 'text-white');
                btnMic.classList.remove('bg-white', 'text-black');
                btnMic.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            }
            
            if(videoOn) {
                btnCam.classList.remove('bg-gray-800', 'text-white');
                btnCam.classList.add('bg-white', 'text-black');
                btnCam.innerHTML = '<i class="fas fa-video"></i>';
            } else {
                btnCam.classList.add('bg-gray-800', 'text-white');
                btnCam.classList.remove('bg-white', 'text-black');
                btnCam.innerHTML = '<i class="fas fa-video-slash"></i>';
            }

            if(screenOn) {
                btnScreen.classList.remove('bg-gray-800', 'text-white');
                btnScreen.classList.add('bg-green-500', 'text-white');
            } else {
                btnScreen.classList.add('bg-gray-800', 'text-white');
                btnScreen.classList.remove('bg-green-500');
            }
        }

        function leaveSession() {
            if(confirm("Disconnect Session?")) resetSession();
        }

        // --- UI Updates ---
        function updateUIForMode(mode) {
            const title = document.getElementById('header-title');
            const mediaControls = document.getElementById('media-controls');
            
            mediaControls.classList.add('hidden');
            setVideoLayout(false); 
            
            updateMediaIcons(false, false, false);
            document.getElementById('local-video-card').classList.add('hidden');

            if (mode.includes('room')) {
                title.innerText = isHost ? "My Room (Host)" : "In Room";
                mediaControls.classList.remove('hidden');
                setVideoLayout(true); 
            } else if (mode.includes('group')) {
                title.innerText = isHost ? "My Group (Admin)" : "In Group";
            } else if (mode === 'direct') {
                title.innerText = "1v1 Direct Chat";
                mediaControls.classList.remove('hidden');
            }
            
            updateConnectionStatus();
        }

        function updateConnectionStatus() {
            let count = 0;
            if(myMode === 'direct') count = connections.length > 0 ? 1 : 0;
            else if(isHost) count = connections.length;
            else count = (hostConn && hostConn.open) ? 1 : 0; 

            document.getElementById('peer-count').innerText = count + (isHost || myMode === 'direct' ? 1 : 1); // + Me
            
            const dot = document.getElementById('header-status-dot');
            const txt = document.getElementById('header-status-text');
            
            if (myMode !== 'idle') {
                dot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_#22c55e]";
                txt.innerText = "Online";
                document.getElementById('status-card').classList.remove('hidden');
            } else {
                dot.className = "w-2 h-2 rounded-full bg-red-500";
                txt.innerText = "Disconnected";
                document.getElementById('status-card').classList.add('hidden');
            }
        }

        function resetSession() {
            connections.forEach(c => c.close());
            connections = [];
            if(hostConn) hostConn.close();
            hostConn = null;
            calls.forEach(c => c.close());
            calls = [];
            
            if(localStream) {
                localStream.getTracks().forEach(t => t.stop());
                localStream = null;
            }
            isScreenSharing = false;
            
            document.getElementById('video-grid').innerHTML = `
                <div class="video-card hidden" id="local-video-card">
                    <video id="local-video" autoplay muted playsinline></video>
                    <div class="absolute bottom-2 left-2 bg-black/60 px-2 py-1 rounded text-[10px] text-white flex items-center gap-1"><i class="fas fa-user"></i> You</div>
                </div>`;
            document.getElementById('chat-box').innerHTML = `
            <div class="flex flex-col items-center justify-center h-[80%] text-gray-600 opacity-40 select-none px-6 text-center">
                <i class="fas fa-paper-plane text-4xl mb-3"></i>
                <h3 class="text-lg font-bold">Ready to Connect</h3>
                <p class="text-xs">Create a Room/Group or Enter ID to Direct Connect.</p>
            </div>`;
            
            setVideoLayout(false); 
            document.getElementById('media-controls').classList.add('hidden');
            document.getElementById('btn-join').innerHTML = '<i class="fas fa-sign-in-alt mb-1"></i><span class="text-[10px]">JOIN HOST</span>';
            document.getElementById('btn-direct').innerHTML = '<i class="fas fa-user-friends mb-1"></i><span class="text-[10px]">1v1 DIRECT</span>';
            
            isHost = false;
            myMode = 'idle';
            document.getElementById('header-title').innerText = "UChat";
            updateConnectionStatus();
        }
        
        // --- Helper Builders (Messages) ---
        function appendMessage(text, dir, sender) {
            const chatBox = document.getElementById('chat-box');
            if(chatBox.querySelector('h3')) chatBox.innerHTML = '';

            const div = document.createElement('div');
            div.className = `flex w-full ${dir === 'out' ? 'justify-end' : 'justify-start'} animate-fade-in`;
            const bg = dir === 'out' ? 'bg-outgoing text-white rounded-br-none' : 'bg-incoming text-gray-200 rounded-bl-none';
            div.innerHTML = `
                <div class="max-w-[85%] flex flex-col ${dir === 'out' ? 'items-end' : 'items-start'}">
                    <span class="text-[9px] text-gray-500 mb-1 px-1">${sender}</span>
                    <div class="${bg} px-4 py-2.5 rounded-2xl shadow-sm chat-bubble text-[15px] break-words">${linkify(text)}</div>
                    <span class="text-[9px] text-gray-600 mt-1 px-1">${getTime()}</span>
                </div>`;
            chatBox.appendChild(div);
            scrollToBottom();
        }

        function appendImageMessage(url, dir, sender, filename) {
             const chatBox = document.getElementById('chat-box');
            if(chatBox.querySelector('h3')) chatBox.innerHTML = '';
            
            const div = document.createElement('div');
            div.className = `flex w-full ${dir === 'out' ? 'justify-end' : 'justify-start'} animate-fade-in`;
            div.innerHTML = `
                <div class="max-w-[70%] flex flex-col ${dir === 'out' ? 'items-end' : 'items-start'}">
                    <span class="text-[9px] text-gray-500 mb-1 px-1">${sender}</span>
                    <div class="bg-gray-800 p-1 rounded-2xl shadow-md border border-gray-700/50" onclick="openMediaModal('${url}', 'image', '${filename}')">
                        <img src="${url}" class="rounded-xl w-full h-auto max-h-64 object-cover bg-black cursor-pointer">
                    </div>
                </div>`;
            chatBox.appendChild(div);
            scrollToBottom();
        }
        
        function appendVideoMessage(url, dir, sender, filename) {
            const chatBox = document.getElementById('chat-box');
            if(chatBox.querySelector('h3')) chatBox.innerHTML = '';

            const div = document.createElement('div');
            div.className = `flex w-full ${dir === 'out' ? 'justify-end' : 'justify-start'} animate-fade-in`;
            div.innerHTML = `
                <div class="max-w-[70%] flex flex-col ${dir === 'out' ? 'items-end' : 'items-start'}">
                    <span class="text-[9px] text-gray-500 mb-1 px-1">${sender}</span>
                    <div class="bg-gray-800 p-1 rounded-2xl shadow-md border border-gray-700/50 relative cursor-pointer" onclick="openMediaModal('${url}', 'video', '${filename}')">
                          <video src="${url}" class="rounded-xl w-full h-auto max-h-64 object-cover bg-black"></video>
                          <div class="play-overlay"><i class="fas fa-play text-white text-xl ml-1"></i></div>
                    </div>
                </div>`;
            chatBox.appendChild(div);
            scrollToBottom();
        }
        
        function appendVoiceMessage(url, dir, sender) {
            const chatBox = document.getElementById('chat-box');
            if(chatBox.querySelector('h3')) chatBox.innerHTML = '';
            
            const div = document.createElement('div');
            div.className = `flex w-full ${dir === 'out' ? 'justify-end' : 'justify-start'} animate-fade-in`;
            const bg = dir === 'out' ? 'bg-outgoing text-white' : 'bg-incoming text-gray-200';
            
            div.innerHTML = `
                <div class="max-w-[85%] flex flex-col ${dir === 'out' ? 'items-end' : 'items-start'}">
                    <span class="text-[9px] text-gray-500 mb-1 px-1">${sender}</span>
                    <div class="${bg} p-2 rounded-2xl shadow-sm chat-bubble flex items-center gap-2">
                         <div class="w-8 h-8 rounded-full bg-black/20 flex items-center justify-center flex-shrink-0"><i class="fas fa-microphone"></i></div>
                         <audio controls src="${url}"></audio>
                    </div>
                    <span class="text-[9px] text-gray-600 mt-1 px-1">${getTime()}</span>
                </div>`;
            chatBox.appendChild(div);
            scrollToBottom();
        }

        function appendFileMessage(name, size, dir, url, type, sender) {
            const chatBox = document.getElementById('chat-box');
            if(chatBox.querySelector('h3')) chatBox.innerHTML = '';

            const div = document.createElement('div');
            div.className = `flex w-full ${dir === 'out' ? 'justify-end' : 'justify-start'} animate-fade-in`;
            const bg = dir === 'out' ? 'bg-outgoing' : 'bg-incoming';
            div.innerHTML = `
                <div class="max-w-[85%] flex flex-col ${dir === 'out' ? 'items-end' : 'items-start'}">
                      <span class="text-[9px] text-gray-500 mb-1 px-1">${sender}</span>
                      <div class="${bg} p-3 rounded-2xl text-white shadow-md flex items-center gap-3 w-full border border-white/5 cursor-pointer" onclick="directDownload('${url}', '${name}')">
                        <div class="w-10 h-10 bg-black/20 rounded-lg flex items-center justify-center flex-shrink-0"><i class="fas fa-file-alt text-xl"></i></div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-sm truncate">${name}</h4>
                            <p class="text-[10px] opacity-80">${formatBytes(size)}</p>
                        </div>
                        ${dir === 'in' ? `<button class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center"><i class="fas fa-arrow-down text-xs"></i></button>` : ''}
                      </div>
                </div>`;
            chatBox.appendChild(div);
            scrollToBottom();
        }

        // --- Utils ---
        function toggleSidebar() { 
            const sb = document.getElementById('sidebar');
            const bd = document.getElementById('sidebar-backdrop');
            const closed = sb.classList.contains('-translate-x-full');
            if(closed) { sb.classList.remove('-translate-x-full'); bd.classList.remove('hidden'); }
            else { sb.classList.add('-translate-x-full'); bd.classList.add('hidden'); }
        }
        function toggleAttachmentMenu() {
            const menu = document.getElementById('attachment-menu');
            const overlay = document.getElementById('attachment-overlay');
            const icon = document.getElementById('plus-icon');
            if(menu.classList.contains('hidden')) { menu.classList.remove('hidden'); overlay.classList.remove('hidden'); icon.classList.add('rotate-45'); }
            else { menu.classList.add('hidden'); overlay.classList.add('hidden'); icon.classList.remove('rotate-45'); }
        }
        function openMediaModal(url, type, filename) {
            const modal = document.getElementById('media-modal');
            const img = document.getElementById('modal-image');
            const vid = document.getElementById('modal-video');
            const dlBtn = document.getElementById('modal-download');
            
            if(type === 'image') {
                img.src = url; img.classList.remove('hidden');
                vid.src = ""; vid.classList.add('hidden');
            } else {
                vid.src = url; vid.classList.remove('hidden');
                img.src = ""; img.classList.add('hidden');
                vid.play().catch(e => console.log('Autoplay blocked')); 
            }
            dlBtn.href = url;
            dlBtn.download = filename || 'download';
            modal.classList.remove('hidden');
        }
        function closeMediaModal() {
             const modal = document.getElementById('media-modal');
             const vid = document.getElementById('modal-video');
             vid.pause(); 
             modal.classList.add('hidden');
        }
        function directDownload(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
        function scrollToBottom() { const b = document.getElementById('chat-box'); b.scrollTop = b.scrollHeight; }
        function getTime() { return new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }
        function linkify(t) { return t.replace(/(https?:\/\/[^\s]+)/g, url => `<a href="${url}" target="_blank" class="text-blue-300 underline">${url}</a>`); }
        function updateMyName() { myName = document.getElementById('my-name-input').value; localStorage.setItem('uchat_name', myName); }
        function copyId() { navigator.clipboard.writeText(document.getElementById('my-id').innerText); showToast("Copied ID!", "success"); }
        function formatBytes(bytes) { if(bytes===0) return '0 B'; const i = Math.floor(Math.log(bytes)/Math.log(1024)); return parseFloat((bytes/Math.pow(1024, i)).toFixed(2)) + ' ' + ['B','KB','MB','GB'][i]; }
        function handleTyping() { } 
        function showToast(msg, type) {
            const colors = { error: 'bg-red-500/90 text-white', success: 'bg-green-600/90 text-white', info: 'bg-blue-600/90 text-white', warning: 'bg-yellow-600/90 text-white' };
            const t = document.createElement('div');
            t.className = `px-4 py-3 rounded-xl border backdrop-blur-md text-sm font-medium shadow-2xl mb-2 animate-fade-in flex items-center gap-2 ${colors[type] || colors.info}`;
            t.innerHTML = msg;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>
</html>
