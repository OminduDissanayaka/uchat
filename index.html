<!DOCTYPE html>
<html lang="en" data-theme="midnight">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- SEO Meta Tags -->
    <title>UChat - Secure P2P Video Chat & Messaging | Free End-to-End Encrypted Communication</title>
    <meta name="description" content="UChat is a free, secure peer-to-peer video calling and messaging platform. No servers, no tracking - just direct encrypted communication. Create rooms, group chats, or 1-on-1 calls instantly.">
    <meta name="keywords" content="video chat, P2P messaging, secure chat, encrypted video call, free video conferencing, WebRTC chat, peer to peer chat, private messaging, group video call, screen sharing">
    <meta name="author" content="UChat Team">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    <meta name="revisit-after" content="7 days">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://u-chat.app/">
    <meta property="og:title" content="UChat - Secure P2P Video Chat & Messaging">
    <meta property="og:description" content="Free, secure peer-to-peer video calling and messaging. No servers, no tracking - just direct encrypted communication.">
    <meta property="og:image" content="https://u-chat.app/og-image.png">
    <meta property="og:site_name" content="UChat">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://u-chat.app/">
    <meta name="twitter:title" content="UChat - Secure P2P Video Chat & Messaging">
    <meta name="twitter:description" content="Free, secure peer-to-peer video calling and messaging. No servers, no tracking.">
    <meta name="twitter:image" content="https://u-chat.app/twitter-image.png">
    
    <!-- PWA & Mobile -->
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="UChat">
    <meta name="application-name" content="UChat">
    <meta name="msapplication-TileColor" content="#6366f1">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí¨</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí¨</text></svg>">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://u-chat.app/">
    
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "UChat",
        "description": "Free, secure peer-to-peer video calling and messaging platform",
        "url": "https://u-chat.app",
        "applicationCategory": "CommunicationApplication",
        "operatingSystem": "Any",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "featureList": [
            "End-to-End Encryption",
            "P2P Video Calls",
            "Group Messaging",
            "Screen Sharing",
            "File Transfer",
            "Voice Messages"
        ]
    }
    </script>
    
    <!-- Preconnect for Performance -->
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <!-- Scripts & Styles -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: 'var(--color-dark)',
                        darker: 'var(--color-darker)',
                        primary: 'var(--color-primary)',
                        secondary: 'var(--color-secondary)',
                        accent: 'var(--color-accent)',
                        incoming: 'var(--color-incoming)',
                        outgoing: 'var(--color-outgoing)',
                        surface: 'var(--color-surface)',
                        textPrimary: 'var(--color-text-primary)',
                        textSecondary: 'var(--color-text-secondary)'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-in': 'slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'zoom-in': 'zoomIn 0.2s ease-out forwards',
                        'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-in': 'bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards',
                        'shake': 'shake 0.5s ease-in-out',
                        'glow': 'glow 2s ease-in-out infinite alternate'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideIn: { '0%': { opacity: '0', transform: 'translateY(-20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        zoomIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        bounceIn: { '0%': { transform: 'scale(0)' }, '50%': { transform: 'scale(1.1)' }, '100%': { transform: 'scale(1)' } },
                        shake: { '0%, 100%': { transform: 'translateX(0)' }, '25%': { transform: 'translateX(-5px)' }, '75%': { transform: 'translateX(5px)' } },
                        glow: { '0%': { boxShadow: '0 0 5px var(--color-primary)' }, '100%': { boxShadow: '0 0 20px var(--color-primary), 0 0 30px var(--color-accent)' } }
                    }
                }
            }
        }
    </script>
    <style>
        /* ===== PROFESSIONAL THEMES ===== */
        
        /* 1. Midnight Blue - Professional Dark Theme */
        :root, [data-theme="midnight"] {
            --color-dark: #0a0f1a;
            --color-darker: #050810;
            --color-primary: #3b82f6;
            --color-secondary: #1e293b;
            --color-accent: #60a5fa;
            --color-incoming: #1a2332;
            --color-outgoing: #2563eb;
            --color-surface: #111827;
            --color-text-primary: #f8fafc;
            --color-text-secondary: #94a3b8;
            --color-border: rgba(59, 130, 246, 0.15);
            --gradient-bg: linear-gradient(135deg, #0a0f1a 0%, #111827 50%, #0f172a 100%);
            --theme-name: 'Midnight Blue';
        }

        /* 2. Pearl White - Clean Light Theme */
        [data-theme="pearl"] {
            --color-dark: #ffffff;
            --color-darker: #f8fafc;
            --color-primary: #2563eb;
            --color-secondary: #f1f5f9;
            --color-accent: #3b82f6;
            --color-incoming: #f1f5f9;
            --color-outgoing: #2563eb;
            --color-surface: #ffffff;
            --color-text-primary: #0f172a;
            --color-text-secondary: #64748b;
            --color-border: rgba(0,0,0,0.08);
            --gradient-bg: linear-gradient(135deg, #ffffff 0%, #f8fafc 50%, #f1f5f9 100%);
            --theme-name: 'Pearl White';
        }

        /* 3. Emerald Pro - Green Professional Theme */
        [data-theme="emerald"] {
            --color-dark: #022c22;
            --color-darker: #011a14;
            --color-primary: #10b981;
            --color-secondary: #064e3b;
            --color-accent: #34d399;
            --color-incoming: #064e3b;
            --color-outgoing: #059669;
            --color-surface: #065f46;
            --color-text-primary: #ecfdf5;
            --color-text-secondary: #a7f3d0;
            --color-border: rgba(16, 185, 129, 0.2);
            --gradient-bg: linear-gradient(135deg, #011a14 0%, #022c22 50%, #064e3b 100%);
            --theme-name: 'Emerald Pro';
        }

        /* 4. Royal Purple - Elegant Purple Theme */
        [data-theme="royal"] {
            --color-dark: #1e1033;
            --color-darker: #0f0818;
            --color-primary: #8b5cf6;
            --color-secondary: #312e81;
            --color-accent: #a78bfa;
            --color-incoming: #2e1065;
            --color-outgoing: #7c3aed;
            --color-surface: #3b0764;
            --color-text-primary: #faf5ff;
            --color-text-secondary: #c4b5fd;
            --color-border: rgba(139, 92, 246, 0.2);
            --gradient-bg: linear-gradient(135deg, #0f0818 0%, #1e1033 50%, #2e1065 100%);
            --theme-name: 'Royal Purple';
        }

        /* 5. Coral Sunset - Warm Professional Theme */
        [data-theme="coral"] {
            --color-dark: #1f1315;
            --color-darker: #0f0a0b;
            --color-primary: #f43f5e;
            --color-secondary: #4c1d24;
            --color-accent: #fb7185;
            --color-incoming: #3f1219;
            --color-outgoing: #e11d48;
            --color-surface: #881337;
            --color-text-primary: #fff1f2;
            --color-text-secondary: #fecdd3;
            --color-border: rgba(244, 63, 94, 0.2);
            --gradient-bg: linear-gradient(135deg, #0f0a0b 0%, #1f1315 50%, #3f1219 100%);
            --theme-name: 'Coral Sunset';
        }

        * { box-sizing: border-box; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--color-primary); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-accent); }
        
        body { 
            -webkit-tap-highlight-color: transparent; 
            background: var(--gradient-bg);
            color: var(--color-text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        .glass { 
            background: rgba(30, 41, 59, 0.85); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--color-border); 
        }
        
        [data-theme="pearl"] .glass {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        
        .sidebar-glass { 
            background: rgba(15, 23, 42, 0.98); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
        }
        
        [data-theme="pearl"] .sidebar-glass {
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 2px 0 20px rgba(0,0,0,0.05);
        }
        
        .modal-glass { 
            background: rgba(15, 23, 42, 0.95); 
            backdrop-filter: blur(24px); 
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--color-border); 
        }
        
        [data-theme="pearl"] .modal-glass {
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        /* View Once Media Styles */
        .view-once-container {
            position: relative;
            cursor: pointer;
        }
        
        .view-once-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .view-once-overlay:hover {
            transform: scale(1.02);
        }
        
        .view-once-icon {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .view-once-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            color: white;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .view-once-expired {
            opacity: 0.5;
            filter: blur(2px);
        }
        
        /* View Once Privacy Protection */
        #view-once-modal {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        
        #view-once-modal img,
        #view-once-modal video {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
            -webkit-touch-callout: none;
            pointer-events: none;
        }
        
        /* Delete Modal Styles */
        .delete-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 16px;
        }
        
        .delete-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--color-border);
        }
        
        .delete-option:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(4px);
        }
        
        .delete-option.danger {
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .delete-option.danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }
        
        .deleted-message {
            font-style: italic;
            opacity: 0.6;
        }
        
        .chat-bubble { 
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            transition: transform 0.2s ease;
        }
        .chat-bubble:hover { transform: scale(1.01); }
        
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
            width: 100%;
            height: 100%;
            padding: 8px;
            overflow: auto;
        }
        
        @media (max-width: 640px) {
            .video-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }
        
        .video-card {
            position: relative;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid var(--color-border);
            transition: all 0.3s ease;
            aspect-ratio: 16/9;
            min-height: 180px;
        }
        
        .video-card:hover {
            border-color: var(--color-primary);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }
        
        .video-card video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-card video.mirror { transform: scaleX(-1); }
        
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        .play-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 50px; height: 50px;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .video-card:hover .play-overlay {
            background: var(--color-primary);
            transform: translate(-50%, -50%) scale(1.1);
        }

        audio { 
            height: 36px; 
            max-width: 220px; 
            border-radius: 20px;
        }
        audio::-webkit-media-controls-panel { 
            background: linear-gradient(135deg, var(--color-surface), var(--color-secondary));
            border-radius: 20px;
        }
        
        .hide-input { display: none !important; }
        
        /* Emoji Picker Styles */
        .emoji-picker {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            max-height: 200px;
            overflow-y: auto;
            padding: 8px;
        }
        
        .emoji-btn {
            font-size: 20px;
            padding: 6px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .emoji-btn:hover {
            background: var(--color-primary);
            transform: scale(1.2);
        }
        
        /* Theme Selector */
        .theme-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .theme-btn:hover, .theme-btn.active {
            transform: scale(1.15);
            border-color: white;
            box-shadow: 0 0 10px currentColor;
        }
        
        /* Connection Quality Indicator */
        .quality-indicator {
            display: flex;
            gap: 2px;
            align-items: flex-end;
        }
        
        .quality-bar {
            width: 3px;
            background: var(--color-text-secondary);
            border-radius: 2px;
            transition: all 0.3s;
        }
        
        .quality-bar.active { background: #22c55e; }
        .quality-bar.warning { background: #eab308; }
        .quality-bar.poor { background: #ef4444; }
        
        /* Message Reactions */
        .reaction-bar {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }
        
        .reaction {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .reaction:hover {
            background: var(--color-primary);
            transform: scale(1.1);
        }
        
        /* Responsive Improvements */
        @media (max-width: 768px) {
            .emoji-picker { grid-template-columns: repeat(6, 1fr); }
        }
        
        @media (max-width: 480px) {
            .emoji-picker { grid-template-columns: repeat(5, 1fr); }
            .video-card { min-height: 150px; }
        }
        
        /* Network Stats Panel */
        .stats-panel {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 12px;
            font-size: 11px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        /* Pulse Ring Animation */
        .pulse-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid var(--color-primary);
            animation: pulseRing 1.5s ease-out infinite;
        }
        
        @keyframes pulseRing {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        /* Safe Area for Mobile */
        .safe-area-bottom {
            padding-bottom: max(8px, env(safe-area-inset-bottom));
        }
        
        .safe-area-top {
            padding-top: max(8px, env(safe-area-inset-top));
        }
        
        /* Link Preview Card */
        .link-preview {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            overflow: hidden;
            max-width: 300px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .link-preview:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border-color: var(--color-primary);
        }
        
        .link-preview-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            background: var(--color-dark);
        }
        
        .link-preview-content {
            padding: 10px 12px;
        }
        
        .link-preview-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .link-preview-description {
            font-size: 11px;
            color: var(--color-text-secondary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 6px;
        }
        
        .link-preview-domain {
            font-size: 10px;
            color: var(--color-primary);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Participants Panel */
        .participants-panel {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            overflow: hidden;
        }
        
        .participant-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            transition: all 0.2s;
            border-bottom: 1px solid var(--color-border);
        }
        
        .participant-item:last-child {
            border-bottom: none;
        }
        
        .participant-item:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .participant-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: white;
            flex-shrink: 0;
        }
        
        .participant-info {
            flex: 1;
            min-width: 0;
        }
        
        .participant-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .participant-status {
            font-size: 10px;
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .online-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s infinite;
        }
        
        /* Profile Avatar */
        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            margin: 0 auto 12px;
            position: relative;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }
        
        .profile-avatar::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #22c55e;
            border: 2px solid var(--color-surface);
        }
        
        /* File Transfer Progress */
        .file-transfer-progress {
            background: var(--color-surface);
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }
        
        .progress-bar-container {
            height: 6px;
            background: var(--color-dark);
            border-radius: 3px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-accent));
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        /* Media Stream Badges */
        .stream-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            color: white;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .stream-quality-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--color-primary);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 9px;
            font-weight: bold;
            color: white;
        }
        
        /* Video Card Enhancements */
        .video-card .video-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 50%);
            pointer-events: none;
        }
        
        /* Animated Gradient Border */
        @keyframes gradientBorder {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .gradient-border {
            background: linear-gradient(90deg, var(--color-primary), var(--color-accent), var(--color-primary));
            background-size: 200% 200%;
            animation: gradientBorder 3s ease infinite;
        }
        
        /* Message Reactions */
        .message-reactions {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }
        
        .reaction-badge {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .reaction-badge:hover {
            background: var(--color-primary);
            transform: scale(1.1);
        }
        
        .reaction-badge.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
        }
        
        /* Reply Preview */
        .reply-preview {
            background: rgba(99, 102, 241, 0.1);
            border-left: 3px solid var(--color-primary);
            padding: 8px 12px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 8px;
            font-size: 12px;
            max-width: 100%;
        }
        
        .reply-preview-text {
            color: var(--color-text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        /* Search Box */
        .search-box {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            width: 90%;
            max-width: 500px;
        }
        
        .search-results {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .search-result-item {
            padding: 10px 12px;
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .search-result-item:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .search-highlight {
            background: var(--color-primary);
            color: white;
            padding: 0 2px;
            border-radius: 2px;
        }
        
        /* Drag & Drop Overlay */
        .drag-overlay {
            position: fixed;
            inset: 0;
            background: rgba(99, 102, 241, 0.9);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .drag-overlay.active {
            opacity: 1;
        }
        
        .drag-icon {
            width: 80px;
            height: 80px;
            border: 3px dashed white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            animation: bounce 1s infinite;
        }
        
        /* Voice Activity Visualizer */
        .voice-visualizer {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 20px;
        }
        
        .voice-bar {
            width: 3px;
            background: var(--color-primary);
            border-radius: 2px;
            transition: height 0.1s ease;
        }
        
        /* Context Menu */
        .context-menu {
            position: fixed;
            z-index: 1000;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 6px 0;
            min-width: 160px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .context-menu-item {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 13px;
            color: var(--color-text-primary);
        }
        
        .context-menu-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .context-menu-item i {
            width: 16px;
            text-align: center;
            color: var(--color-text-secondary);
        }
        
        .context-menu-divider {
            height: 1px;
            background: var(--color-border);
            margin: 4px 0;
        }
        
        /* Read Receipts */
        .read-receipt {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            font-size: 10px;
            margin-left: 6px;
        }
        
        .read-receipt i {
            font-size: 10px;
        }
        
        .read-receipt.sent { color: var(--color-text-secondary); }
        .read-receipt.delivered { color: var(--color-text-secondary); }
        .read-receipt.read { color: #22c55e; }
        
        /* GIF Picker */
        .gif-picker {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            max-height: 250px;
            overflow-y: auto;
            padding: 8px;
        }
        
        .gif-item {
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
            aspect-ratio: 16/9;
        }
        
        .gif-item:hover {
            transform: scale(1.05);
        }
        
        .gif-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* PiP Button */
        .pip-btn {
            position: absolute;
            top: 8px;
            right: 50px;
            background: rgba(0,0,0,0.7);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pip-btn:hover {
            background: var(--color-primary);
            transform: scale(1.1);
        }
        
        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 18px;
            height: 18px;
            background: #ef4444;
            border-radius: 50%;
            font-size: 10px;
            font-weight: bold;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--color-darker);
        }
        
        /* Smooth scrollbar for messages */
        #chat-box {
            scroll-behavior: smooth;
        }
        
        /* Message highlight animation */
        @keyframes messageHighlight {
            0%, 100% { background: transparent; }
            50% { background: rgba(99, 102, 241, 0.2); }
        }
        
        .message-highlight {
            animation: messageHighlight 1s ease-in-out 2;
        }
    </style>
</head>
<body class="font-sans h-[100dvh] overflow-hidden flex flex-col md:flex-row transition-colors duration-300">

    <!-- Drag & Drop Overlay -->
    <div id="drag-overlay" class="drag-overlay">
        <div class="drag-icon">
            <i class="fas fa-cloud-upload-alt text-white text-3xl"></i>
        </div>
        <h3 class="text-white text-xl font-bold">Drop files here</h3>
        <p class="text-white/70 text-sm">Release to upload</p>
    </div>

    <!-- Search Modal -->
    <div id="search-modal" class="fixed inset-0 z-[105] hidden" onclick="closeSearchModal()">
        <div class="search-box modal-glass rounded-2xl shadow-2xl overflow-hidden animate-slide-in" onclick="event.stopPropagation()">
            <div class="flex items-center gap-3 p-3 border-b" style="border-color: var(--color-border)">
                <i class="fas fa-search" style="color: var(--color-text-secondary)"></i>
                <input type="text" id="search-input" placeholder="Search messages..." class="flex-1 bg-transparent focus:outline-none text-sm" style="color: var(--color-text-primary)" oninput="searchMessages(this.value)">
                <button onclick="closeSearchModal()" class="w-8 h-8 rounded-full hover:bg-white/10 transition"><i class="fas fa-times" style="color: var(--color-text-secondary)"></i></button>
            </div>
            <div id="search-results" class="search-results">
                <p class="text-center py-6 text-sm" style="color: var(--color-text-secondary)">Type to search...</p>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu" class="context-menu hidden">
        <div class="context-menu-item" onclick="replyToMessage()"><i class="fas fa-reply"></i> Reply</div>
        <div class="context-menu-item" onclick="copyMessageText()"><i class="fas fa-copy"></i> Copy</div>
        <div class="context-menu-item" onclick="addReactionFromMenu()"><i class="fas fa-smile"></i> React</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="forwardMessage()"><i class="fas fa-share"></i> Forward</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="deleteForMe()"><i class="fas fa-user-times"></i> Delete for me</div>
        <div id="delete-everyone-option" class="context-menu-item hidden" style="color: #ef4444" onclick="showDeleteForEveryoneConfirm()"><i class="fas fa-trash-alt"></i> Delete for everyone</div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 z-[115] bg-black/80 hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="modal-glass p-6 rounded-2xl w-full max-w-sm shadow-2xl animate-zoom-in">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background: rgba(239, 68, 68, 0.2)">
                    <i class="fas fa-trash-alt text-red-400 text-xl"></i>
                </div>
                <h3 class="text-lg font-bold" style="color: var(--color-text-primary)">Delete Message</h3>
            </div>
            <p class="text-sm mb-4" style="color: var(--color-text-secondary)">Choose how you want to delete this message:</p>
            <div class="delete-options">
                <div class="delete-option" onclick="deleteForMe()">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: var(--color-surface)">
                        <i class="fas fa-user" style="color: var(--color-text-secondary)"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-sm" style="color: var(--color-text-primary)">Delete for me</p>
                        <p class="text-[11px]" style="color: var(--color-text-secondary)">Only removes from your view</p>
                    </div>
                </div>
                <div class="delete-option danger" onclick="deleteForEveryone()">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(239, 68, 68, 0.2)">
                        <i class="fas fa-users text-red-400"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-sm text-red-400">Delete for everyone</p>
                        <p class="text-[11px]" style="color: var(--color-text-secondary)">Removes for all participants</p>
                    </div>
                </div>
            </div>
            <button onclick="closeDeleteModal()" class="w-full mt-4 py-2.5 rounded-xl text-sm font-medium" style="background: var(--color-surface); color: var(--color-text-secondary)">Cancel</button>
        </div>
    </div>

    <!-- View Once Modal - Privacy Protected -->
    <div id="view-once-modal" class="fixed inset-0 z-[120] bg-black hidden flex flex-col items-center justify-center p-4 select-none" 
         oncontextmenu="return false;" 
         ondragstart="return false;" 
         oncopy="return false;"
         oncut="return false;">
        <!-- Watermark overlay for screenshot deterrent -->
        <div class="absolute inset-0 pointer-events-none z-[121] opacity-10" style="background: repeating-linear-gradient(45deg, transparent, transparent 100px, rgba(255,255,255,0.03) 100px, rgba(255,255,255,0.03) 200px);">
            <div class="absolute inset-0 flex items-center justify-center">
                <p class="text-white text-6xl font-bold opacity-20 rotate-[-30deg]">VIEW ONCE</p>
            </div>
        </div>
        <div class="absolute top-4 left-4 flex items-center gap-2 text-white z-[122]">
            <i class="fas fa-eye-slash"></i>
            <span class="text-sm font-medium">View Once - <span id="view-once-timer">5</span>s remaining</span>
        </div>
        <div class="absolute top-4 right-1/2 translate-x-1/2 flex items-center gap-2 text-yellow-400 z-[122]">
            <i class="fas fa-shield-alt"></i>
            <span class="text-xs font-medium">Screenshot Protected</span>
        </div>
        <button onclick="closeViewOnceModal()" class="absolute top-4 right-4 text-white bg-white/20 rounded-full w-12 h-12 flex items-center justify-center hover:bg-red-600 transition z-[122]">
            <i class="fas fa-times text-lg"></i>
        </button>
        <div class="relative z-[122]" style="-webkit-user-select: none; user-select: none; pointer-events: none;">
            <img id="view-once-image" src="" class="hidden max-w-full max-h-[80vh] object-contain rounded-2xl animate-zoom-in shadow-2xl" 
                 draggable="false" 
                 oncontextmenu="return false;"
                 style="-webkit-user-drag: none; -webkit-touch-callout: none;">
            <video id="view-once-video" src="" class="hidden max-w-full max-h-[80vh] rounded-2xl animate-zoom-in shadow-2xl" 
                   autoplay 
                   disablepictureinpicture 
                   controlslist="nodownload nofullscreen noremoteplayback"
                   oncontextmenu="return false;"
                   style="-webkit-user-drag: none; -webkit-touch-callout: none;"></video>
        </div>
        <p class="text-white/60 text-sm mt-4 z-[122]"><i class="fas fa-lock mr-2"></i>This media is protected and will disappear after viewing</p>
    </div>

    <!-- Reaction Picker (Quick) -->
    <div id="reaction-picker" class="fixed hidden z-[106] modal-glass rounded-full px-3 py-2 shadow-2xl animate-zoom-in">
        <div class="flex gap-1">
            <span class="reaction-quick-btn text-xl cursor-pointer hover:scale-125 transition" onclick="addReaction('üëç')">üëç</span>
            <span class="reaction-quick-btn text-xl cursor-pointer hover:scale-125 transition" onclick="addReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
            <span class="reaction-quick-btn text-xl cursor-pointer hover:scale-125 transition" onclick="addReaction('üòÇ')">üòÇ</span>
            <span class="reaction-quick-btn text-xl cursor-pointer hover:scale-125 transition" onclick="addReaction('üòÆ')">üòÆ</span>
            <span class="reaction-quick-btn text-xl cursor-pointer hover:scale-125 transition" onclick="addReaction('üò¢')">üò¢</span>
            <span class="reaction-quick-btn text-xl cursor-pointer hover:scale-125 transition" onclick="addReaction('üî•')">üî•</span>
        </div>
    </div>

    <!-- GIF Picker Modal -->
    <div id="gif-modal" class="fixed inset-0 z-[95] hidden" onclick="closeGifPicker()">
        <div class="absolute bottom-24 left-4 right-4 md:left-auto md:right-20 md:w-96 modal-glass rounded-2xl shadow-2xl p-2 animate-slide-up" onclick="event.stopPropagation()">
            <div class="flex items-center gap-3 p-2 border-b" style="border-color: var(--color-border)">
                <i class="fas fa-search" style="color: var(--color-text-secondary)"></i>
                <input type="text" id="gif-search" placeholder="Search GIFs..." class="flex-1 bg-transparent focus:outline-none text-sm" style="color: var(--color-text-primary)" oninput="searchGifs(this.value)">
                <button onclick="closeGifPicker()" class="w-8 h-8 rounded-full hover:bg-white/10 transition"><i class="fas fa-times" style="color: var(--color-text-secondary)"></i></button>
            </div>
            <div class="gif-picker" id="gif-grid">
                <!-- GIFs loaded via JS -->
            </div>
        </div>
    </div>

    <!-- Custom Alert/Confirm Modal -->
    <div id="custom-modal" class="fixed inset-0 z-[110] bg-black/80 hidden flex items-center justify-center p-4 backdrop-blur-md opacity-0 transition-opacity duration-300">
        <div class="modal-glass p-6 rounded-2xl w-full max-w-sm shadow-2xl transform scale-95 transition-transform duration-300" id="modal-content">
            <div class="flex items-center gap-3 mb-4">
                <div id="modal-icon-bg" class="w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center">
                    <i id="modal-icon" class="fas fa-info-circle text-primary text-xl"></i>
                </div>
                <h3 id="modal-title" class="text-lg font-bold" style="color: var(--color-text-primary)">Alert</h3>
            </div>
            <p id="modal-message" class="text-sm mb-6 leading-relaxed" style="color: var(--color-text-secondary)">Message goes here...</p>
            <div class="flex justify-end gap-3" id="modal-actions">
                <button id="modal-cancel" onclick="closeCustomModal()" class="px-4 py-2.5 rounded-xl text-sm font-medium hover:bg-white/10 transition" style="color: var(--color-text-secondary)">Cancel</button>
                <button id="modal-confirm" class="px-5 py-2.5 rounded-xl text-sm font-bold text-white shadow-lg transition" style="background: var(--color-primary)">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Media Modal -->
    <div id="media-modal" class="fixed inset-0 z-[100] bg-black/95 hidden flex flex-col items-center justify-center p-2 backdrop-blur-md" onclick="closeMediaModal()">
        <button class="absolute top-4 right-4 text-white bg-black/50 rounded-full w-12 h-12 flex items-center justify-center z-[101] hover:bg-red-600 transition-all hover:scale-110"><i class="fas fa-times text-lg"></i></button>
        <img id="modal-image" src="" class="hidden max-w-full max-h-[85vh] object-contain rounded-2xl animate-zoom-in shadow-2xl" onclick="event.stopPropagation()">
        <video id="modal-video" src="" controls class="hidden max-w-full max-h-[85vh] rounded-2xl animate-zoom-in shadow-2xl" onclick="event.stopPropagation()"></video>
        <a id="modal-download" href="#" download class="mt-4 px-6 py-3 rounded-full flex items-center gap-2 transition-all hover:scale-105 font-medium" style="background: var(--color-primary); color: white" onclick="event.stopPropagation()"><i class="fas fa-download"></i> Download</a>
    </div>

    <!-- Emoji Picker Modal -->
    <div id="emoji-modal" class="fixed inset-0 z-[95] hidden" onclick="closeEmojiPicker()">
        <div class="absolute bottom-24 left-4 right-4 md:left-auto md:right-20 md:w-80 modal-glass rounded-2xl shadow-2xl p-2 animate-slide-up" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between p-2 border-b" style="border-color: var(--color-border)">
                <span class="text-sm font-bold" style="color: var(--color-text-primary)">Emojis</span>
                <button onclick="closeEmojiPicker()" class="w-8 h-8 rounded-full hover:bg-white/10 transition"><i class="fas fa-times" style="color: var(--color-text-secondary)"></i></button>
            </div>
            <div class="emoji-picker" id="emoji-grid">
                <!-- Emojis loaded via JS -->
            </div>
        </div>
    </div>

    <!-- Network Stats Modal -->
    <div id="stats-modal" class="fixed inset-0 z-[95] hidden" onclick="closeStatsModal()">
        <div class="absolute top-20 right-4 w-72 modal-glass rounded-2xl shadow-2xl p-4 animate-slide-in" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-3">
                <span class="text-sm font-bold" style="color: var(--color-text-primary)"><i class="fas fa-chart-line mr-2"></i>Network Stats</span>
                <button onclick="closeStatsModal()" class="w-8 h-8 rounded-full hover:bg-white/10 transition"><i class="fas fa-times" style="color: var(--color-text-secondary)"></i></button>
            </div>
            <div class="stats-panel space-y-2" id="network-stats">
                <div class="stat-row"><span style="color: var(--color-text-secondary)">Connection</span><span id="stat-connection" style="color: var(--color-text-primary)">--</span></div>
                <div class="stat-row"><span style="color: var(--color-text-secondary)">Latency</span><span id="stat-latency" style="color: var(--color-text-primary)">-- ms</span></div>
                <div class="stat-row"><span style="color: var(--color-text-secondary)">Bitrate</span><span id="stat-bitrate" style="color: var(--color-text-primary)">-- kbps</span></div>
                <div class="stat-row"><span style="color: var(--color-text-secondary)">Resolution</span><span id="stat-resolution" style="color: var(--color-text-primary)">--</span></div>
                <div class="stat-row"><span style="color: var(--color-text-secondary)">Frame Rate</span><span id="stat-fps" style="color: var(--color-text-primary)">-- fps</span></div>
            </div>
        </div>
    </div>

    <!-- Participants Modal -->
    <div id="participants-modal" class="fixed inset-0 z-[95] hidden" onclick="closeParticipantsModal()">
        <div class="absolute top-20 left-4 md:left-auto md:right-20 w-80 modal-glass rounded-2xl shadow-2xl p-4 animate-slide-in" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-3">
                <span class="text-sm font-bold" style="color: var(--color-text-primary)"><i class="fas fa-users mr-2"></i>Participants <span id="participants-count" class="ml-1 px-2 py-0.5 rounded-full text-xs" style="background: var(--color-primary); color: white">0</span></span>
                <button onclick="closeParticipantsModal()" class="w-8 h-8 rounded-full hover:bg-white/10 transition"><i class="fas fa-times" style="color: var(--color-text-secondary)"></i></button>
            </div>
            <div id="participants-list" class="max-h-80 overflow-y-auto space-y-1">
                <!-- Participants inserted via JS -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/70 backdrop-blur-sm" onclick="closeSettingsModal()">
        <div class="w-[95%] max-w-md max-h-[90vh] modal-glass rounded-2xl shadow-2xl animate-zoom-in overflow-hidden" onclick="event.stopPropagation()">
            <!-- Header -->
            <div class="p-4 flex items-center justify-between" style="border-bottom: 1px solid var(--color-border)">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, var(--color-primary), var(--color-accent))">
                        <i class="fas fa-cog text-white"></i>
                    </div>
                    <div>
                        <h2 class="text-base font-bold" style="color: var(--color-text-primary)">Settings</h2>
                        <p class="text-[10px]" style="color: var(--color-text-secondary)">Account, Privacy & Security</p>
                    </div>
                </div>
                <button onclick="closeSettingsModal()" class="w-9 h-9 rounded-full hover:bg-white/10 transition flex items-center justify-center">
                    <i class="fas fa-times" style="color: var(--color-text-secondary)"></i>
                </button>
            </div>
            
            <!-- Settings Content -->
            <div class="p-4 space-y-4 overflow-y-auto" style="max-height: calc(90vh - 140px)">
                
                <!-- Account Section -->
                <div class="space-y-2">
                    <p class="text-[10px] font-bold px-1" style="color: var(--color-text-secondary)">ACCOUNT</p>
                    
                    <div class="p-3 rounded-xl" style="background: var(--color-surface); border: 1px solid var(--color-border)">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-user-shield text-lg" style="color: var(--color-primary)"></i>
                                <div>
                                    <p class="text-sm font-medium" style="color: var(--color-text-primary)">Public Account</p>
                                    <p class="text-[10px]" style="color: var(--color-text-secondary)">Enable to join UChat All global chat</p>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="settings-public-toggle" class="sr-only peer" onchange="toggleSettingPublic()">
                                <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                            </label>
                        </div>
                        <div id="account-type-info" class="mt-2 p-2 rounded-lg text-[10px]" style="background: rgba(239, 68, 68, 0.1); color: #fca5a5">
                            <i class="fas fa-lock mr-1"></i> Private: Only direct connections with ID sharing
                        </div>
                    </div>
                </div>
                
                <!-- Privacy & Security Section -->
                <div class="space-y-2">
                    <p class="text-[10px] font-bold px-1" style="color: var(--color-text-secondary)">PRIVACY & SECURITY</p>
                    
                    <div class="p-3 rounded-xl" style="background: var(--color-surface); border: 1px solid var(--color-border)">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-user-slash" style="color: #ef4444"></i>
                                <div>
                                    <p class="text-xs font-medium" style="color: var(--color-text-primary)">Block Unknown</p>
                                    <p class="text-[9px]" style="color: var(--color-text-secondary)">Only allow saved friends</p>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="setting-block-unknown" class="sr-only peer" onchange="updatePrivacySetting('blockUnknown', this.checked)">
                                <div class="w-10 h-5 bg-gray-600 rounded-full peer peer-checked:after:translate-x-5 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-500"></div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="p-3 rounded-xl" style="background: var(--color-surface); border: 1px solid var(--color-border)">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-check-double" style="color: #f59e0b"></i>
                                <div>
                                    <p class="text-xs font-medium" style="color: var(--color-text-primary)">Require Approval</p>
                                    <p class="text-[9px]" style="color: var(--color-text-secondary)">Approve incoming connections</p>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="setting-require-approval" class="sr-only peer" onchange="updatePrivacySetting('requireApproval', this.checked)" checked>
                                <div class="w-10 h-5 bg-gray-600 rounded-full peer peer-checked:after:translate-x-5 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-amber-500"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Privacy Options -->
                <div class="space-y-2">
                    <p class="text-[10px] font-bold px-1" style="color: var(--color-text-secondary)">PRIVACY OPTIONS</p>
                    
                    <div class="p-3 rounded-xl" style="background: var(--color-surface); border: 1px solid var(--color-border)">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-eye-slash" style="color: #8b5cf6"></i>
                                <div>
                                    <p class="text-xs font-medium" style="color: var(--color-text-primary)">Hide Online Status</p>
                                    <p class="text-[9px]" style="color: var(--color-text-secondary)">Others won't see when you're online</p>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="setting-hide-online" class="sr-only peer" onchange="updatePrivacySetting('hideOnlineStatus', this.checked)">
                                <div class="w-10 h-5 bg-gray-600 rounded-full peer peer-checked:after:translate-x-5 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-purple-500"></div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="p-3 rounded-xl" style="background: var(--color-surface); border: 1px solid var(--color-border)">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-clock" style="color: #6366f1"></i>
                                <div>
                                    <p class="text-xs font-medium" style="color: var(--color-text-primary)">Hide Last Seen</p>
                                    <p class="text-[9px]" style="color: var(--color-text-secondary)">Don't show your last activity</p>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="setting-hide-lastseen" class="sr-only peer" onchange="updatePrivacySetting('hideLastSeen', this.checked)">
                                <div class="w-10 h-5 bg-gray-600 rounded-full peer peer-checked:after:translate-x-5 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-500"></div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="p-3 rounded-xl" style="background: var(--color-surface); border: 1px solid var(--color-border)">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-check-circle" style="color: #3b82f6"></i>
                                <div>
                                    <p class="text-xs font-medium" style="color: var(--color-text-primary)">Disable Read Receipts</p>
                                    <p class="text-[9px]" style="color: var(--color-text-secondary)">Don't send "seen" status</p>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="setting-no-read" class="sr-only peer" onchange="updatePrivacySetting('disableReadReceipts', this.checked)">
                                <div class="w-10 h-5 bg-gray-600 rounded-full peer peer-checked:after:translate-x-5 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-500"></div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="p-3 rounded-xl" style="background: var(--color-surface); border: 1px solid var(--color-border)">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-keyboard" style="color: #10b981"></i>
                                <div>
                                    <p class="text-xs font-medium" style="color: var(--color-text-primary)">Disable Typing Indicator</p>
                                    <p class="text-[9px]" style="color: var(--color-text-secondary)">Don't show when you're typing</p>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="setting-no-typing" class="sr-only peer" onchange="updatePrivacySetting('disableTypingIndicator', this.checked)">
                                <div class="w-10 h-5 bg-gray-600 rounded-full peer peer-checked:after:translate-x-5 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-emerald-500"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Media Security -->
                <div class="space-y-2">
                    <p class="text-[10px] font-bold px-1" style="color: var(--color-text-secondary)">MEDIA SECURITY</p>
                    
                    <div class="p-3 rounded-xl" style="background: var(--color-surface); border: 1px solid var(--color-border)">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-camera-slash" style="color: #ec4899"></i>
                                <div>
                                    <p class="text-xs font-medium" style="color: var(--color-text-primary)">Block Screenshots</p>
                                    <p class="text-[9px]" style="color: var(--color-text-secondary)">Extra protection for media</p>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="setting-block-ss" class="sr-only peer" onchange="updatePrivacySetting('blockScreenshots', this.checked)">
                                <div class="w-10 h-5 bg-gray-600 rounded-full peer peer-checked:after:translate-x-5 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-pink-500"></div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="p-3 rounded-xl" style="background: var(--color-surface); border: 1px solid var(--color-border)">
                        <div class="flex items-center gap-3 mb-2">
                            <i class="fas fa-trash-alt" style="color: #f43f5e"></i>
                            <div>
                                <p class="text-xs font-medium" style="color: var(--color-text-primary)">Auto-Delete Messages</p>
                                <p class="text-[9px]" style="color: var(--color-text-secondary)">Automatically delete after time</p>
                            </div>
                        </div>
                        <select id="setting-auto-delete" onchange="updatePrivacySetting('autoDeleteMessages', this.value)" class="w-full p-2 rounded-lg text-xs focus:outline-none" style="background: var(--color-dark); color: var(--color-text-primary); border: 1px solid var(--color-border)">
                            <option value="never">Never</option>
                            <option value="1h">After 1 Hour</option>
                            <option value="24h">After 24 Hours</option>
                            <option value="7d">After 7 Days</option>
                            <option value="30d">After 30 Days</option>
                        </select>
                    </div>
                </div>

                <!-- Info -->
                <div class="p-3 rounded-xl flex items-start gap-3" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3)">
                    <i class="fas fa-info-circle text-blue-400 mt-0.5"></i>
                    <p class="text-[10px]" style="color: var(--color-text-secondary)">
                        <strong style="color: var(--color-text-primary)">Note:</strong> Private accounts cannot join UChat All. Some settings may affect your ability to receive messages from others.
                    </p>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="p-4 flex justify-end gap-2" style="border-top: 1px solid var(--color-border)">
                <button onclick="resetPrivacySettings()" class="px-4 py-2 rounded-lg text-xs font-medium transition hover:opacity-80" style="background: var(--color-surface); color: var(--color-text-primary)">
                    Reset to Default
                </button>
                <button onclick="closeSettingsModal()" class="px-4 py-2 rounded-lg text-xs font-medium text-white transition hover:opacity-80" style="background: var(--color-primary)">
                    Done
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed top-20 right-0 left-0 md:left-auto md:right-6 z-[90] flex flex-col items-center md:items-end gap-2 pointer-events-none px-4 md:px-0"></div>

    <!-- Sidebar Backdrop -->
    <div id="sidebar-backdrop" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 z-20 hidden md:hidden backdrop-blur-md"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-[85%] max-w-sm md:w-80 lg:w-96 sidebar-glass flex flex-col transform -translate-x-full md:translate-x-0 md:relative transition-transform duration-300 shadow-2xl" style="border-right: 1px solid var(--color-border)">
        <div class="p-4 lg:p-5 flex items-center justify-between safe-area-top" style="border-bottom: 1px solid var(--color-border)">
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 rounded-xl flex items-center justify-center shadow-lg relative overflow-hidden" style="background: linear-gradient(135deg, var(--color-primary), var(--color-accent))">
                    <i class="fas fa-bolt text-white text-lg"></i>
                    <div class="pulse-ring"></div>
                </div>
                <div>
                    <h1 class="text-xl font-bold" style="color: var(--color-text-primary)">UChat</h1>
                    <p class="text-[10px] font-semibold tracking-widest" style="color: var(--color-text-secondary)">CONNECT FREELY</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="openThemeModal()" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-white/10 transition" title="Change Theme">
                    <i class="fas fa-palette" style="color: var(--color-text-secondary)"></i>
                </button>
                <button onclick="toggleSidebar()" class="md:hidden w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/10 transition" style="color: var(--color-text-secondary)">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
        </div>

        <!-- Theme Selector -->
        <div id="theme-selector" class="hidden p-4 border-b animate-fade-in" style="border-color: var(--color-border); background: var(--color-surface)">
            <label class="text-[10px] font-bold mb-3 block" style="color: var(--color-text-secondary)">SELECT THEME</label>
            <div class="flex items-center justify-between gap-2">
                <button onclick="setTheme('midnight')" class="theme-btn" style="background: linear-gradient(135deg, #3b82f6, #1e40af)" title="Midnight Blue"></button>
                <button onclick="setTheme('pearl')" class="theme-btn" style="background: linear-gradient(135deg, #f8fafc, #e2e8f0)" title="Pearl White"></button>
                <button onclick="setTheme('emerald')" class="theme-btn" style="background: linear-gradient(135deg, #10b981, #059669)" title="Emerald Pro"></button>
                <button onclick="setTheme('royal')" class="theme-btn" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed)" title="Royal Purple"></button>
                <button onclick="setTheme('coral')" class="theme-btn" style="background: linear-gradient(135deg, #f43f5e, #e11d48)" title="Coral Sunset"></button>
            </div>
            <p class="text-[10px] text-center mt-2" style="color: var(--color-text-secondary)" id="theme-name-display">Current: Midnight Blue</p>
        </div>

        <div class="p-4 lg:p-5 flex-1 overflow-y-auto space-y-5">
            <!-- Profile -->
            <div class="p-4 rounded-2xl" style="background: var(--color-surface); border: 1px solid var(--color-border)">
                <div class="profile-avatar" id="profile-avatar">U</div>
                <input type="text" id="my-name-input" value="User" class="w-full p-2.5 rounded-xl text-sm mb-3 focus:outline-none transition text-center font-bold" style="background: var(--color-dark); color: var(--color-text-primary); border: 1px solid var(--color-border)" onblur="updateMyName()" oninput="updateProfileAvatar()" onfocus="this.select()">
                <p class="text-[10px] text-center mb-3" style="color: var(--color-text-secondary)">Your display name visible to others</p>
                <div class="flex items-center justify-between p-3 rounded-xl cursor-pointer hover:opacity-80 transition" style="background: var(--color-dark); border: 1px solid var(--color-primary)" onclick="copyId()">
                    <div class="overflow-hidden mr-2">
                        <p class="text-[10px] font-bold" style="color: var(--color-text-secondary)">YOUR FIXED ID</p>
                        <p id="my-id" class="text-lg font-mono truncate font-bold tracking-widest" style="color: var(--color-primary)">--- ---</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="quality-indicator" id="quality-indicator">
                            <div class="quality-bar h-2"></div>
                            <div class="quality-bar h-3"></div>
                            <div class="quality-bar h-4"></div>
                            <div class="quality-bar h-5"></div>
                        </div>
                        <i class="far fa-copy" style="color: var(--color-primary)"></i>
                    </div>
                </div>
                <button onclick="resetId()" class="mt-2 text-[10px] text-red-400 hover:text-red-300 underline w-full text-right transition">Reset ID</button>
            </div>

            <!-- Settings Button -->
            <button onclick="openSettingsModal()" class="w-full p-4 rounded-2xl flex items-center justify-between transition hover:opacity-90" style="background: var(--color-surface); border: 1px solid var(--color-border)">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, var(--color-primary), var(--color-accent))">
                        <i class="fas fa-cog text-white"></i>
                    </div>
                    <div class="text-left">
                        <span class="text-xs font-bold block" style="color: var(--color-text-primary)">Settings</span>
                        <span class="text-[9px]" style="color: var(--color-text-secondary)">Account, Privacy & Security</span>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span id="privacy-badge" class="px-2 py-0.5 rounded-full text-[9px] font-bold" style="background: rgba(239, 68, 68, 0.2); color: #ef4444">PRIVATE</span>
                    <i class="fas fa-chevron-right text-xs" style="color: var(--color-text-secondary)"></i>
                </div>
            </button>

            <!-- UChat All - Global Room (Only visible for Public accounts) -->
            <div id="uchat-all-section" class="hidden p-4 rounded-2xl" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1)); border: 1px solid rgba(99, 102, 241, 0.3)">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, #6366f1, #a855f7)">
                            <i class="fas fa-globe text-white text-sm"></i>
                        </div>
                        <div>
                            <span class="text-xs font-bold" style="color: var(--color-text-primary)">UChat All</span>
                            <p class="text-[9px]" style="color: var(--color-text-secondary)">Global Public Chat</p>
                        </div>
                    </div>
                    <div id="global-online-badge" class="hidden px-2 py-0.5 rounded-full text-[9px] font-bold animate-pulse" style="background: rgba(34, 197, 94, 0.2); color: #22c55e">
                        <i class="fas fa-circle text-[6px] mr-1"></i><span id="global-online-count">0</span> Online
                    </div>
                </div>
                <p class="text-[10px] mb-3" style="color: var(--color-text-secondary)">Join the global chat room. Text only - no video/voice calls. Chat with everyone!</p>
                <button onclick="joinGlobalRoom()" id="btn-global-room" class="w-full py-3 rounded-xl text-white font-bold text-sm transition-all hover:scale-[1.02] shadow-lg flex items-center justify-center gap-2" style="background: linear-gradient(135deg, #6366f1, #a855f7)">
                    <i class="fas fa-door-open"></i>
                    <span>Join UChat All</span>
                </button>
            </div>

            <!-- Host Actions --> 
            <div>
                <label class="text-[10px] font-bold mb-2 block" style="color: var(--color-text-secondary)">HOST A SESSION</label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setMode('room')" id="btn-create-room" class="p-3 rounded-xl hover:scale-[1.02] flex flex-col items-center gap-2 transition-all" style="background: var(--color-surface); border: 1px solid var(--color-border)">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, #ec4899, #f43f5e)">
                            <i class="fas fa-video text-white"></i>
                        </div>
                        <span class="text-xs font-bold" style="color: var(--color-text-primary)">Host Room</span>
                        <span class="text-[9px]" style="color: var(--color-text-secondary)">Video Chat</span>
                    </button>
                    <button onclick="setMode('group')" id="btn-create-group" class="p-3 rounded-xl hover:scale-[1.02] flex flex-col items-center gap-2 transition-all" style="background: var(--color-surface); border: 1px solid var(--color-border)">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, #3b82f6, #6366f1)">
                            <i class="fas fa-users text-white"></i>
                        </div>
                        <span class="text-xs font-bold" style="color: var(--color-text-primary)">Host Group</span>
                        <span class="text-[9px]" style="color: var(--color-text-secondary)">Text Only</span>
                    </button>
                </div>
            </div>

            <!-- Connect Form -->
            <div>
                <label class="text-[10px] font-bold mb-2 block" style="color: var(--color-text-secondary)">CONNECT TO PEER</label>
                <div class="flex flex-col gap-3">
                    <div class="relative">
                        <i class="fas fa-fingerprint absolute left-3.5 top-3.5" style="color: var(--color-text-secondary)"></i>
                        <input type="number" id="remote-id" placeholder="Enter Peer ID" class="w-full py-3 pl-10 pr-3 text-sm focus:outline-none tracking-widest font-mono rounded-xl transition" style="background: var(--color-surface); color: var(--color-text-primary); border: 1px solid var(--color-border)" onfocus="this.style.borderColor='var(--color-primary)'" onblur="this.style.borderColor='var(--color-border)'">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="connectDirect()" id="btn-direct" class="text-white font-bold py-3 rounded-xl transition-all hover:scale-[1.02] shadow-lg flex flex-col items-center justify-center gap-1" style="background: linear-gradient(135deg, #10b981, #059669)">
                            <i class="fas fa-comment-dots"></i>
                            <span class="text-[10px]">CHAT ONLY</span>
                        </button>
                        <button onclick="joinPeer()" id="btn-join" class="text-white font-bold py-3 rounded-xl transition-all hover:scale-[1.02] shadow-lg flex flex-col items-center justify-center gap-1" style="background: linear-gradient(135deg, var(--color-primary), var(--color-accent))">
                            <i class="fas fa-sign-in-alt"></i>
                            <span class="text-[10px]">JOIN HOST</span>
                        </button>
                    </div>
                    
                    <!-- Voice & Video Call Buttons -->
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="startVoiceCallDirect()" id="btn-voice-call" class="text-white font-bold py-3 rounded-xl transition-all hover:scale-[1.02] shadow-lg flex flex-col items-center justify-center gap-1" style="background: linear-gradient(135deg, #f59e0b, #d97706)">
                            <i class="fas fa-phone-alt"></i>
                            <span class="text-[10px]">VOICE CALL</span>
                        </button>
                        <button onclick="startVideoCallDirect()" id="btn-video-call" class="text-white font-bold py-3 rounded-xl transition-all hover:scale-[1.02] shadow-lg flex flex-col items-center justify-center gap-1" style="background: linear-gradient(135deg, #ec4899, #be185d)">
                            <i class="fas fa-video"></i>
                            <span class="text-[10px]">VIDEO CALL</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Video Quality Selector -->
            <div>
                <label class="text-[10px] font-bold mb-2 block" style="color: var(--color-text-secondary)">VIDEO QUALITY</label>
                <div class="flex gap-2">
                    <button onclick="setVideoQuality('low')" id="quality-low" class="flex-1 py-2 rounded-lg text-xs font-medium transition" style="background: var(--color-surface); color: var(--color-text-secondary); border: 1px solid var(--color-border)">
                        <i class="fas fa-signal mr-1" style="opacity: 0.3"></i> Low
                    </button>
                    <button onclick="setVideoQuality('medium')" id="quality-medium" class="flex-1 py-2 rounded-lg text-xs font-medium transition" style="background: var(--color-primary); color: white; border: 1px solid var(--color-primary)">
                        <i class="fas fa-signal mr-1" style="opacity: 0.6"></i> Medium
                    </button>
                    <button onclick="setVideoQuality('high')" id="quality-high" class="flex-1 py-2 rounded-lg text-xs font-medium transition" style="background: var(--color-surface); color: var(--color-text-secondary); border: 1px solid var(--color-border)">
                        <i class="fas fa-signal mr-1"></i> HD
                    </button>
                </div>
            </div>

            <!-- Friends List -->
            <div class="pt-4" style="border-top: 1px solid var(--color-border)">
                <div class="flex items-center justify-between mb-2">
                    <label class="text-[10px] font-bold" style="color: var(--color-text-secondary)">SAVED FRIENDS</label>
                    <button onclick="toggleFriendForm()" class="text-xs font-medium transition hover:scale-105" style="color: var(--color-primary)"><i class="fas fa-plus"></i> Add</button>
                </div>

                <!-- Add Friend Form (Hidden) -->
                <div id="friend-form" class="hidden p-3 rounded-xl mb-3 animate-fade-in" style="background: var(--color-surface); border: 1px solid var(--color-border)">
                    <input type="text" id="friend-name" placeholder="Nickname" class="w-full text-xs p-2.5 rounded-lg mb-2 focus:outline-none transition" style="background: var(--color-dark); color: var(--color-text-primary); border: 1px solid var(--color-border)">
                    <input type="number" id="friend-id" placeholder="Peer ID" class="w-full text-xs p-2.5 rounded-lg mb-3 focus:outline-none transition" style="background: var(--color-dark); color: var(--color-text-primary); border: 1px solid var(--color-border)">
                    <div class="flex gap-2">
                        <button onclick="saveFriend()" class="flex-1 text-xs py-2 rounded-lg text-white font-medium transition hover:opacity-90" style="background: #22c55e">Save</button>
                        <button onclick="toggleFriendForm()" class="flex-1 text-xs py-2 rounded-lg font-medium transition hover:opacity-90" style="background: var(--color-secondary); color: var(--color-text-primary)">Cancel</button>
                    </div>
                </div>

                <div id="friends-list" class="space-y-2 max-h-40 overflow-y-auto pr-1">
                    <!-- Friends inserted via JS -->
                    <p class="text-xs text-center py-3" style="color: var(--color-text-secondary)">No friends saved yet.</p>
                </div>
            </div>
            
             <!-- Status -->
             <div id="status-card" class="hidden mt-4 p-4 rounded-xl animate-bounce-in" style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3)">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center relative" style="background: var(--color-surface); border: 2px solid #22c55e">
                        <i id="status-icon" class="fas fa-check text-green-400 text-lg"></i>
                        <div class="absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center">
                            <span id="peer-count" class="text-[9px] text-white font-bold">0</span>
                        </div>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <p class="text-sm font-bold" id="connection-mode-display" style="color: var(--color-text-primary)">Connected</p>
                        <p class="text-[10px] truncate" style="color: var(--color-text-secondary)">Session Active</p>
                    </div>
                    <button onclick="copyInviteLink()" class="w-10 h-10 rounded-full flex items-center justify-center transition hover:scale-110" style="background: rgba(34, 197, 94, 0.2); color: #22c55e" title="Copy Invite Link">
                        <i class="fas fa-share-alt"></i>
                    </button>
                </div>
            </div>

        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative h-full z-10 transition-colors duration-300">
        
        <!-- Navbar -->
        <header class="h-16 glass flex items-center justify-between px-3 md:px-4 z-20 shadow-lg safe-area-top">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="md:hidden text-xl w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/10 transition" style="color: var(--color-text-secondary)">
                    <i class="fas fa-bars"></i>
                </button>
                <div>
                    <h2 class="font-bold text-base truncate max-w-[120px] md:max-w-none" id="header-title" style="color: var(--color-text-primary)">UChat</h2>
                    <div class="flex items-center gap-1.5">
                        <div id="header-status-dot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                        <span class="text-[10px] font-medium" id="header-status-text" style="color: var(--color-text-secondary)">Disconnected</span>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="openSearchModal()" id="btn-search" class="w-9 h-9 md:w-10 md:h-10 rounded-full flex items-center justify-center transition hover:scale-105" style="background: var(--color-surface); color: var(--color-text-secondary); border: 1px solid var(--color-border)" title="Search Messages (Ctrl+F)">
                    <i class="fas fa-search text-sm"></i>
                </button>
                <button onclick="openParticipantsModal()" id="btn-participants" class="hidden w-9 h-9 md:w-10 md:h-10 rounded-full flex items-center justify-center transition hover:scale-105" style="background: var(--color-surface); color: var(--color-text-secondary); border: 1px solid var(--color-border)" title="Participants">
                    <i class="fas fa-users text-sm"></i>
                </button>
                <button onclick="openStatsModal()" id="btn-stats" class="hidden w-9 h-9 md:w-10 md:h-10 rounded-full flex items-center justify-center transition hover:scale-105" style="background: var(--color-surface); color: var(--color-text-secondary); border: 1px solid var(--color-border)" title="Network Stats">
                    <i class="fas fa-chart-line text-sm"></i>
                </button>
                <div id="media-controls" class="hidden flex gap-1 md:gap-2">
                    <button onclick="toggleAudio()" id="btn-mic" class="w-9 h-9 md:w-10 md:h-10 rounded-full flex items-center justify-center transition-all hover:scale-105" style="background: var(--color-surface); color: var(--color-text-primary); border: 1px solid var(--color-border)">
                        <i class="fas fa-microphone-slash"></i>
                    </button>
                    <button onclick="toggleVideo()" id="btn-cam" class="w-9 h-9 md:w-10 md:h-10 rounded-full flex items-center justify-center transition-all hover:scale-105" style="background: var(--color-surface); color: var(--color-text-primary); border: 1px solid var(--color-border)">
                        <i class="fas fa-video-slash"></i>
                    </button>
                    <button onclick="toggleScreenShare()" id="btn-screen" class="hidden md:flex w-10 h-10 rounded-full items-center justify-center transition-all hover:scale-105" style="background: var(--color-surface); color: var(--color-text-primary); border: 1px solid var(--color-border)" title="Share Screen">
                        <i class="fas fa-desktop"></i>
                    </button>
                    <button onclick="togglePiP()" id="btn-pip" class="hidden md:flex w-10 h-10 rounded-full items-center justify-center transition-all hover:scale-105" style="background: var(--color-surface); color: var(--color-text-primary); border: 1px solid var(--color-border)" title="Picture in Picture">
                        <i class="fas fa-external-link-square-alt"></i>
                    </button>
                    <button onclick="leaveSession()" class="w-9 h-9 md:w-10 md:h-10 rounded-full bg-red-600 text-white flex items-center justify-center hover:bg-red-700 transition-all hover:scale-105 shadow-lg">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Video Grid -->
        <div id="video-area" class="hidden flex-1 p-2 md:p-3 relative transition-all duration-300" style="background: rgba(0,0,0,0.4); backdrop-filter: blur(8px)">
            <div id="video-grid" class="video-grid">
                <div class="video-card hidden" id="local-video-card">
                    <video id="local-video" autoplay muted playsinline></video>
                    <div class="video-overlay"></div>
                    <button class="pip-btn" onclick="togglePiP()" title="Picture in Picture"><i class="fas fa-external-link-square-alt"></i></button>
                    <div class="stream-badge">
                        <div class="online-dot"></div>
                        <span>LIVE</span>
                        <div class="voice-visualizer" id="local-voice-viz">
                            <div class="voice-bar" style="height: 4px"></div>
                            <div class="voice-bar" style="height: 8px"></div>
                            <div class="voice-bar" style="height: 4px"></div>
                            <div class="voice-bar" style="height: 12px"></div>
                            <div class="voice-bar" style="height: 6px"></div>
                        </div>
                    </div>
                    <div class="stream-quality-badge" id="local-quality-badge">HD</div>
                    <div class="absolute bottom-2 left-2 bg-black/70 px-3 py-1.5 rounded-lg text-[11px] text-white flex items-center gap-2 backdrop-blur-sm">
                        <i class="fas fa-user"></i> <span id="local-video-name">You</span>
                        <div id="local-mic-indicator" class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chat-box" class="flex-1 overflow-y-auto p-3 md:p-4 space-y-3 scroll-smooth pb-24">
            <div class="flex flex-col items-center justify-center h-[80%] select-none px-6 text-center" style="color: var(--color-text-secondary); opacity: 0.5">
                <div class="w-20 h-20 rounded-full flex items-center justify-center mb-4" style="background: var(--color-surface)">
                    <i class="fas fa-paper-plane text-3xl" style="color: var(--color-primary)"></i>
                </div>
                <h3 class="text-lg font-bold mb-1" style="color: var(--color-text-primary)">Ready to Connect</h3>
                <p class="text-xs max-w-xs">Select a friend, enter an ID, or create a room to start chatting.</p>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-2 md:p-3 z-20 flex-shrink-0 safe-area-bottom" style="background: var(--color-darker); border-top: 1px solid var(--color-border)">
            <div id="attachment-menu" class="hidden absolute bottom-20 left-4 right-4 md:left-4 md:right-auto md:w-72 rounded-2xl shadow-2xl p-2 flex flex-col gap-1 animate-slide-up z-30" style="background: var(--color-surface); border: 1px solid var(--color-border)">
                <button onclick="triggerFileSelect('media')" class="flex items-center gap-3 p-3 hover:bg-white/10 rounded-xl text-left transition">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, #a855f7, #ec4899)">
                        <i class="fas fa-photo-video text-white"></i>
                    </div>
                    <div>
                        <span class="text-sm font-bold" style="color: var(--color-text-primary)">Media</span>
                        <p class="text-[10px]" style="color: var(--color-text-secondary)">Images & Videos</p>
                    </div>
                </button>
                <button onclick="triggerFileSelect('file')" class="flex items-center gap-3 p-3 hover:bg-white/10 rounded-xl text-left transition">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, #3b82f6, #06b6d4)">
                        <i class="fas fa-file-alt text-white"></i>
                    </div>
                    <div>
                        <span class="text-sm font-bold" style="color: var(--color-text-primary)">Document</span>
                        <p class="text-[10px]" style="color: var(--color-text-secondary)">Unlimited Size (Chunked)</p>
                    </div>
                </button>
                <button onclick="triggerFileSelect('viewonce')" class="flex items-center gap-3 p-3 hover:bg-white/10 rounded-xl text-left transition">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, #f59e0b, #ef4444)">
                        <i class="fas fa-eye-slash text-white"></i>
                    </div>
                    <div>
                        <span class="text-sm font-bold" style="color: var(--color-text-primary)">View Once</span>
                        <p class="text-[10px]" style="color: var(--color-text-secondary)">Photo/Video disappears after viewing</p>
                    </div>
                </button>
            </div>
            <div id="attachment-overlay" class="fixed inset-0 z-10 hidden backdrop-blur-sm" style="background: rgba(0,0,0,0.5)" onclick="toggleAttachmentMenu()"></div>

            <!-- Reply Preview Bar -->
            <div id="reply-bar" class="hidden mx-4 mb-2 animate-fade-in">
                <div class="reply-preview flex items-center justify-between">
                    <div class="flex items-center gap-2 overflow-hidden">
                        <i class="fas fa-reply" style="color: var(--color-primary)"></i>
                        <div class="overflow-hidden">
                            <p class="text-[10px] font-bold" style="color: var(--color-primary)" id="reply-to-name">Replying to User</p>
                            <p class="reply-preview-text" id="reply-to-text">Message text...</p>
                        </div>
                    </div>
                    <button onclick="cancelReply()" class="w-6 h-6 rounded-full hover:bg-white/10 transition flex items-center justify-center"><i class="fas fa-times text-xs" style="color: var(--color-text-secondary)"></i></button>
                </div>
            </div>

            <div id="typing-indicator" class="hidden text-[10px] ml-14 mb-1 font-medium animate-fade-in" style="color: var(--color-primary)">
                <i class="fas fa-comment-dots mr-1"></i>Someone is typing 
                <span class="typing-dot">.</span><span class="typing-dot">.</span><span class="typing-dot">.</span>
            </div>
            <div class="flex items-end gap-2 max-w-5xl mx-auto relative z-20">
                <button onclick="toggleAttachmentMenu()" class="w-10 h-10 md:w-11 md:h-11 rounded-full transition-all hover:scale-105 flex-shrink-0 flex items-center justify-center" style="background: var(--color-surface); color: var(--color-text-secondary); border: 1px solid var(--color-border)" id="btn-attach">
                    <i class="fas fa-plus transform transition-transform" id="plus-icon"></i>
                </button>
                <button onclick="openEmojiPicker()" class="w-10 h-10 md:w-11 md:h-11 rounded-full transition-all hover:scale-105 flex-shrink-0 flex items-center justify-center" style="background: var(--color-surface); color: var(--color-text-secondary); border: 1px solid var(--color-border)" title="Emoji">
                    <i class="fas fa-smile"></i>
                </button>
                <button onclick="openGifPicker()" class="hidden md:flex w-10 h-10 md:w-11 md:h-11 rounded-full transition-all hover:scale-105 flex-shrink-0 items-center justify-center" style="background: var(--color-surface); color: var(--color-text-secondary); border: 1px solid var(--color-border)" title="GIF">
                    <span class="text-[10px] font-bold">GIF</span>
                </button>
                <input type="file" id="file-input-media" accept="image/*,video/*" class="hidden" onchange="handleFileSelect(this, 'media')">
                <input type="file" id="file-input-doc" class="hidden" onchange="handleFileSelect(this, 'file')">
                <input type="file" id="file-input-viewonce" accept="image/*,video/*" class="hidden" onchange="handleFileSelect(this, 'viewonce')">
                
                <div class="flex-1 rounded-2xl flex flex-col transition relative overflow-hidden min-h-[44px] md:min-h-[46px]" style="background: var(--color-surface); border: 1px solid var(--color-border)">
                    <textarea id="msg-input" rows="1" placeholder="Type a message..." class="w-full bg-transparent resize-none focus:outline-none max-h-32 min-h-[36px] text-sm py-2 px-3 md:px-4" style="color: var(--color-text-primary)" oninput="autoResize(this); handleTyping()" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>

                    <div id="recording-ui" class="hidden absolute inset-0 z-50 flex items-center justify-between px-3 w-full h-full" style="background: var(--color-surface)">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                            <span class="text-sm font-mono" id="rec-time" style="color: var(--color-text-primary)">00:00</span>
                            <div class="voice-visualizer" id="recording-visualizer">
                                <div class="voice-bar" style="height: 4px"></div>
                                <div class="voice-bar" style="height: 8px"></div>
                                <div class="voice-bar" style="height: 4px"></div>
                                <div class="voice-bar" style="height: 12px"></div>
                                <div class="voice-bar" style="height: 6px"></div>
                            </div>
                        </div>
                        <span class="text-[10px] animate-pulse hidden md:block" style="color: var(--color-text-secondary)">Recording audio...</span>
                        <div class="flex items-center gap-2">
                             <button onclick="cancelRecording()" class="w-8 h-8 rounded-full bg-red-500/20 text-red-400 hover:bg-red-600 hover:text-white transition flex items-center justify-center" title="Cancel">
                                 <i class="fas fa-times"></i>
                             </button>
                             <button onclick="stopAndSendRecording()" class="w-8 h-8 rounded-full text-white transition flex items-center justify-center" style="background: var(--color-primary)" title="Send">
                                 <i class="fas fa-paper-plane"></i>
                             </button>
                        </div>
                    </div>
                </div>

                <button id="btn-record-toggle" onclick="startRecording()" class="w-10 h-10 md:w-11 md:h-11 rounded-full transition-all hover:scale-105 shadow-lg flex-shrink-0 flex items-center justify-center" style="background: var(--color-surface); color: var(--color-text-secondary); border: 1px solid var(--color-border)" title="Voice Message">
                    <i class="fas fa-microphone"></i>
                </button>
                <button id="btn-send-text" onclick="sendMessage()" class="w-10 h-10 md:w-11 md:h-11 rounded-full text-white transition-all hover:scale-105 shadow-lg flex-shrink-0 flex items-center justify-center" style="background: var(--color-primary)" title="Send Message">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </main>

    <script>
        // --- Configuration & State ---
        const MAX_CHUNK_SIZE = 64 * 1024; // 64KB chunks for reliable transfer
        const LINK_PREVIEW_API = 'https://api.linkpreview.net'; // Free tier available
        const TENOR_API_KEY = 'AIzaSyAyimkuYQYF_FXVALexPuGQctUWRURdCYQ'; // Free Tenor API
        
        // STUN/TURN Servers for Firewall Bypass
        const ICE_SERVERS = [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            { urls: 'stun:stun3.l.google.com:19302' },
            { urls: 'stun:stun4.l.google.com:19302' },
            { urls: 'stun:stun.stunprotocol.org:3478' },
            { urls: 'stun:stun.voip.blackberry.com:3478' },
            { urls: 'stun:stun.services.mozilla.com' },
            { urls: 'stun:stun.ekiga.net' },
            { urls: 'stun:stun.ideasip.com' },
            { urls: 'stun:stun.schlund.de' },
            { urls: 'stun:stun.voipbuster.com' },
            { urls: 'stun:stun.voipstunt.com' },
            // Free TURN servers (for symmetric NAT bypass)
            { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' },
            { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' },
            { urls: 'turn:openrelay.metered.ca:443?transport=tcp', username: 'openrelayproject', credential: 'openrelayproject' }
        ];

        // Video Quality Presets
        const VIDEO_QUALITY = {
            low: { width: 320, height: 240, frameRate: 15, bitrate: 150000 },
            medium: { width: 640, height: 480, frameRate: 24, bitrate: 500000 },
            high: { width: 1280, height: 720, frameRate: 30, bitrate: 1500000 }
        };

        // Emoji List
        const EMOJI_LIST = ['üòÄ', 'üòÇ', 'üòç', 'ü•∞', 'üòé', 'ü§î', 'üò¢', 'üò°', 'üëç', 'üëé', '‚ù§Ô∏è', 'üî•', '‚ú®', 'üéâ', 'üëè', 'üôè', 'üí™', 'ü§ù', 'üëã', '‚úåÔ∏è', 'ü§û', 'ü§ô', 'üëå', 'üëä', 'üéµ', 'üé∂', 'üé§', 'üéß', 'üì∑', 'üé•', 'üíª', 'üì±', 'üåü', '‚≠ê', 'üåà', '‚òÄÔ∏è', 'üåô', '‚ö°', 'üíØ', '‚úÖ', '‚ùå', '‚ö†Ô∏è', 'üí¨', 'üí≠', 'üó®Ô∏è', 'üëÄ', 'üôà', 'üôâ', 'üôä'];

        let peer, localStream;
        let localCamTrack = null;
        let myName = localStorage.getItem('uchat_name') || "User";
        let connectedPeerName = null; // Store connected peer's name for direct chat
        let myMode = 'idle'; 
        let connections = []; 
        let hostConn = null; 
        let calls = [];
        let isHost = false;
        let isScreenSharing = false;
        let mediaRecorder;
        let audioChunks = [];
        let recordingInterval;
        let recordingStartTime;
        let isRecordingCancelled = false;
        let pendingInvite = null;
        let currentTheme = localStorage.getItem('uchat_theme') || 'midnight';
        let currentVideoQuality = localStorage.getItem('uchat_quality') || 'medium';
        let typingTimeout = null;
        let statsInterval = null;
        let participants = {}; // Track all participants {peerId: {name, isVideo, isAudio}}
        let fileTransfers = {}; // Track ongoing file transfers
        let linkPreviewCache = {}; // Cache link previews
        let viewOnceMedia = {}; // Track view once media {id: {viewed: boolean, url, type}}
        let deletedMessages = new Set(); // Track deleted message IDs
        
        // === PRIVACY & GLOBAL ROOM SETTINGS ===
        let isPublicAccount = localStorage.getItem('uchat_public') === 'true'; // Default: Private
        let isInGlobalRoom = false; // UChat All global room state
        let globalRoomUsers = {}; // Track all users in global room {peerId: {name, joinTime}}
        let globalRoomConn = null; // Connection to global room coordinator
        const GLOBAL_ROOM_ID = 'uchat-global-room-2026'; // Fixed global room identifier
        
        // === ADVANCED PRIVACY SETTINGS ===
        let privacySettings = {
            blockUnknown: localStorage.getItem('uchat_block_unknown') === 'true', // Block unknown connections
            hideOnlineStatus: localStorage.getItem('uchat_hide_online') === 'true', // Hide online status
            disableReadReceipts: localStorage.getItem('uchat_no_read') === 'true', // Don't send read receipts
            disableTypingIndicator: localStorage.getItem('uchat_no_typing') === 'true', // Don't show typing
            autoDeleteMessages: localStorage.getItem('uchat_auto_delete') || 'never', // never, 1h, 24h, 7d
            blockScreenshots: localStorage.getItem('uchat_block_ss') === 'true', // Extra screenshot protection
            requireApproval: localStorage.getItem('uchat_require_approval') !== 'false', // Require approval for connections (default true)
            hideLastSeen: localStorage.getItem('uchat_hide_lastseen') === 'true' // Hide last seen time
        };
        
        // Theme names mapping
        const THEME_NAMES = {
            'midnight': 'Midnight Blue',
            'pearl': 'Pearl White',
            'emerald': 'Emerald Pro',
            'royal': 'Royal Purple',
            'coral': 'Coral Sunset'
        };
        
        // === NEW HIGH PERFORMANCE FEATURES ===
        let messageHistory = []; // Store all messages for search
        let messageIdCounter = 0; // Unique message IDs
        let replyingTo = null; // Current reply target
        let selectedMessageId = null; // For context menu
        let offlineQueue = []; // Messages to send when reconnected
        let reconnectAttempts = 0; // Auto-reconnect counter
        let audioContext = null; // For voice visualization
        let audioAnalyser = null; // Audio analyzer
        let voiceVisualizerInterval = null; // Voice viz animation
        let isPiPActive = false; // Picture in Picture state
        let unreadCount = 0; // Notification badge
        let notificationsEnabled = false; // Desktop notifications
        let encryptionKey = null; // E2E encryption key (derived from shared secret)

        // --- Init ---
        window.onload = () => {
            console.log('UChat initializing...');
            
            // Set name input
            document.getElementById('my-name-input').value = myName;
            updateProfileAvatar();
            
            // Apply saved theme (without toast)
            document.documentElement.setAttribute('data-theme', currentTheme);
            highlightCurrentTheme();
            
            // Set video quality UI
            setVideoQualityUI(currentVideoQuality);
            
            // Initialize PeerJS connection
            initPeer();
            
            // Load UI components
            loadFriends();
            loadEmojis();
            loadTrendingGifs();
            checkUrlParams();
            
            // Setup drag & drop
            setupDragAndDrop();
            
            // Setup context menu
            setupContextMenu();
            
            // Request notification permission
            requestNotificationPermission();
            
            // Generate encryption key
            generateEncryptionKey();
            
            // Initialize privacy settings UI
            updatePrivacyUI();
            
            console.log('UChat Pro initialized with high-performance features!');
        };
        
        // Highlight current theme button
        function highlightCurrentTheme() {
            const themeButtons = document.querySelectorAll('.theme-btn');
            const themeIndex = ['midnight', 'pearl', 'emerald', 'royal', 'coral'].indexOf(currentTheme);
            themeButtons.forEach((btn, i) => {
                if (i === themeIndex) {
                    btn.style.transform = 'scale(1.15)';
                    btn.style.borderColor = 'white';
                }
            });
            // Update theme name display
            const themeNameDisplay = document.getElementById('theme-name-display');
            if (themeNameDisplay) {
                themeNameDisplay.innerText = `Current: ${THEME_NAMES[currentTheme] || currentTheme}`;
            }
        }
        
        // --- Profile Avatar ---
        function updateProfileAvatar() {
            const nameInput = document.getElementById('my-name-input');
            const avatar = document.getElementById('profile-avatar');
            const localVideoName = document.getElementById('local-video-name');
            
            if (!nameInput || !avatar) return;
            
            const name = nameInput.value.trim() || 'User';
            
            // Get initials (up to 2 characters)
            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            avatar.innerText = initials || 'U';
            
            // Update local video name
            if (localVideoName) localVideoName.innerText = name;
            
            // Generate color from name
            const colors = [
                'linear-gradient(135deg, #6366f1, #8b5cf6)',
                'linear-gradient(135deg, #ec4899, #f43f5e)',
                'linear-gradient(135deg, #10b981, #059669)',
                'linear-gradient(135deg, #f59e0b, #d97706)',
                'linear-gradient(135deg, #3b82f6, #1d4ed8)',
                'linear-gradient(135deg, #8b5cf6, #7c3aed)',
            ];
            const colorIndex = name.charCodeAt(0) % colors.length;
            avatar.style.background = colors[colorIndex];
        }

        // --- Theme System ---
        function setTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('uchat_theme', theme);
            
            // Update theme button states
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.transform = '';
                btn.style.borderColor = 'transparent';
            });
            
            // Find and highlight the active theme button
            const themeButtons = document.querySelectorAll('.theme-btn');
            const themeIndex = ['midnight', 'pearl', 'emerald', 'royal', 'coral'].indexOf(theme);
            if (themeIndex >= 0 && themeButtons[themeIndex]) {
                themeButtons[themeIndex].classList.add('active');
                themeButtons[themeIndex].style.transform = 'scale(1.15)';
                themeButtons[themeIndex].style.borderColor = 'white';
            }
            
            // Update theme name display
            const themeNameDisplay = document.getElementById('theme-name-display');
            if (themeNameDisplay) {
                themeNameDisplay.innerText = `Current: ${THEME_NAMES[theme] || theme}`;
            }
            
            // Close theme selector after selection
            setTimeout(() => {
                document.getElementById('theme-selector').classList.add('hidden');
            }, 300);
            
            showToast(`Theme: ${THEME_NAMES[theme] || theme}`, 'success');
        }

        function openThemeModal() {
            const selector = document.getElementById('theme-selector');
            selector.classList.toggle('hidden');
            
            // Highlight current theme
            const themeButtons = document.querySelectorAll('.theme-btn');
            const themeIndex = ['midnight', 'pearl', 'emerald', 'royal', 'coral'].indexOf(currentTheme);
            themeButtons.forEach((btn, i) => {
                btn.style.transform = i === themeIndex ? 'scale(1.15)' : '';
                btn.style.borderColor = i === themeIndex ? 'white' : 'transparent';
            });
        }

        // --- Video Quality System ---
        function setVideoQuality(quality) {
            currentVideoQuality = quality;
            localStorage.setItem('uchat_quality', quality);
            setVideoQualityUI(quality);
            
            // Update quality badge
            const qualityBadge = document.getElementById('local-quality-badge');
            if (qualityBadge) {
                qualityBadge.innerText = quality === 'high' ? 'HD' : quality === 'medium' ? 'SD' : 'LD';
            }
            
            // If already streaming, update constraints
            if (localStream && localStream.getVideoTracks().length > 0) {
                applyVideoConstraints();
            }
            showToast(`Video quality set to ${quality.toUpperCase()}`, 'success');
        }

        function setVideoQualityUI(quality) {
            ['low', 'medium', 'high'].forEach(q => {
                const btn = document.getElementById(`quality-${q}`);
                if (btn) {
                    if (q === quality) {
                        btn.style.background = 'var(--color-primary)';
                        btn.style.color = 'white';
                        btn.style.borderColor = 'var(--color-primary)';
                    } else {
                        btn.style.background = 'var(--color-surface)';
                        btn.style.color = 'var(--color-text-secondary)';
                        btn.style.borderColor = 'var(--color-border)';
                    }
                }
            });
        }

        async function applyVideoConstraints() {
            const q = VIDEO_QUALITY[currentVideoQuality];
            const track = localStream.getVideoTracks()[0];
            if (track) {
                try {
                    await track.applyConstraints({
                        width: { ideal: q.width },
                        height: { ideal: q.height },
                        frameRate: { ideal: q.frameRate }
                    });
                } catch (e) { console.log('Could not apply constraints:', e); }
            }
        }

        // --- Emoji Picker ---
        function loadEmojis() {
            const grid = document.getElementById('emoji-grid');
            if (grid) {
                grid.innerHTML = EMOJI_LIST.map(e => 
                    `<div class="emoji-btn" onclick="insertEmoji('${e}')">${e}</div>`
                ).join('');
            }
        }

        function openEmojiPicker() {
            const modal = document.getElementById('emoji-modal');
            if (modal) modal.classList.remove('hidden');
        }

        function closeEmojiPicker() {
            const modal = document.getElementById('emoji-modal');
            if (modal) modal.classList.add('hidden');
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('msg-input');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            input.value = text.substring(0, start) + emoji + text.substring(end);
            input.focus();
            input.selectionStart = input.selectionEnd = start + emoji.length;
            closeEmojiPicker();
        }

        // --- Network Stats ---
        function openStatsModal() {
            const modal = document.getElementById('stats-modal');
            if (modal) {
                modal.classList.remove('hidden');
                startStatsMonitoring();
            }
        }

        function closeStatsModal() {
            const modal = document.getElementById('stats-modal');
            if (modal) modal.classList.add('hidden');
            if (statsInterval) clearInterval(statsInterval);
        }
        
        // --- Participants System ---
        function openParticipantsModal() {
            const modal = document.getElementById('participants-modal');
            if (modal) {
                modal.classList.remove('hidden');
                updateParticipantsList();
            }
        }
        
        function closeParticipantsModal() {
            const modal = document.getElementById('participants-modal');
            if (modal) modal.classList.add('hidden');
        }
        
        function updateParticipantsList() {
            const listEl = document.getElementById('participants-list');
            const countEl = document.getElementById('participants-count');
            
            if (!listEl) return;
            
            let html = '';
            const colors = ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#3b82f6', '#8b5cf6'];
            
            // Handle global room participants differently
            if (isInGlobalRoom) {
                // Show all global room users
                Object.entries(globalRoomUsers).forEach(([peerId, info]) => {
                    const isMe = peerId === peer.id;
                    const name = isMe ? myName : info.name;
                    const initial = name.charAt(0).toUpperCase();
                    const color = colors[name.charCodeAt(0) % colors.length];
                    html += `
                        <div class="participant-item">
                            <div class="participant-avatar" style="background: ${color}">${initial}</div>
                            <div class="participant-info">
                                <div class="participant-name">${name}${isMe ? ' (You)' : ''}</div>
                                <div class="participant-status"><div class="online-dot"></div> In UChat All</div>
                            </div>
                            <i class="fas fa-globe text-purple-400 text-xs"></i>
                        </div>`;
                });
                
                listEl.innerHTML = html || '<p class="text-xs text-center py-3" style="color: var(--color-text-secondary)">No users online</p>';
                countEl.innerText = Object.keys(globalRoomUsers).length;
                return;
            }
            
            // Add self first
            const selfInitial = myName.charAt(0).toUpperCase();
            const selfColor = colors[myName.charCodeAt(0) % colors.length];
            html += `
                <div class="participant-item">
                    <div class="participant-avatar" style="background: ${selfColor}">${selfInitial}</div>
                    <div class="participant-info">
                        <div class="participant-name">${myName} (You)</div>
                        <div class="participant-status"><div class="online-dot"></div> ${isHost ? 'Host' : 'Connected'}</div>
                    </div>
                    ${isHost ? '<span class="px-2 py-0.5 rounded-full text-[10px] font-bold" style="background: var(--color-primary); color: white">HOST</span>' : ''}
                </div>`;
            
            // Add other participants
            Object.entries(participants).forEach(([peerId, info]) => {
                const initial = (info.name || 'U').charAt(0).toUpperCase();
                const color = colors[(info.name || 'U').charCodeAt(0) % colors.length];
                html += `
                    <div class="participant-item">
                        <div class="participant-avatar" style="background: ${color}">${initial}</div>
                        <div class="participant-info">
                            <div class="participant-name">${info.name || peerId}</div>
                            <div class="participant-status">
                                <div class="online-dot"></div>
                                ${info.isVideo ? '<i class="fas fa-video text-green-400" style="font-size:10px"></i>' : ''}
                                ${info.isAudio ? '<i class="fas fa-microphone text-green-400" style="font-size:10px"></i>' : ''}
                                Online
                            </div>
                        </div>
                        <span class="text-[10px] font-mono" style="color: var(--color-text-secondary)">${peerId.substring(0,6)}</span>
                    </div>`;
            });
            
            listEl.innerHTML = html;
            countEl.innerText = Object.keys(participants).length + 1;
        }
        
        function addParticipant(peerId, name, isVideo = false, isAudio = false) {
            participants[peerId] = { name, isVideo, isAudio, joinedAt: Date.now() };
            updateParticipantsList();
            // Broadcast updated list to all if host
            if (isHost) {
                broadcastData({ type: 'meta', sub: 'participants-update', participants: getAllParticipantsInfo() });
            }
        }
        
        function removeParticipant(peerId) {
            delete participants[peerId];
            updateParticipantsList();
        }
        
        function getAllParticipantsInfo() {
            const all = { [peer.id]: { name: myName, isHost: isHost } };
            Object.entries(participants).forEach(([id, info]) => {
                all[id] = info;
            });
            return all;
        }
        
        // --- Link Preview System ---
        async function fetchLinkPreview(url) {
            // Check cache first
            if (linkPreviewCache[url]) return linkPreviewCache[url];
            
            try {
                // Use a simple meta tag extraction approach
                const preview = await extractMetaFromUrl(url);
                if (preview) {
                    linkPreviewCache[url] = preview;
                    return preview;
                }
            } catch (e) {
                console.log('Link preview failed:', e);
            }
            
            // Return basic preview
            return {
                title: new URL(url).hostname,
                description: url,
                image: null,
                domain: new URL(url).hostname
            };
        }
        
        async function extractMetaFromUrl(url) {
            // For same-origin or CORS-enabled URLs
            try {
                const domain = new URL(url).hostname;
                
                // Common site favicons/logos
                const knownSites = {
                    'youtube.com': { icon: 'fab fa-youtube', color: '#ff0000' },
                    'www.youtube.com': { icon: 'fab fa-youtube', color: '#ff0000' },
                    'youtu.be': { icon: 'fab fa-youtube', color: '#ff0000' },
                    'github.com': { icon: 'fab fa-github', color: '#333' },
                    'twitter.com': { icon: 'fab fa-twitter', color: '#1da1f2' },
                    'x.com': { icon: 'fab fa-x-twitter', color: '#000' },
                    'facebook.com': { icon: 'fab fa-facebook', color: '#1877f2' },
                    'instagram.com': { icon: 'fab fa-instagram', color: '#e4405f' },
                    'linkedin.com': { icon: 'fab fa-linkedin', color: '#0077b5' },
                    'reddit.com': { icon: 'fab fa-reddit', color: '#ff4500' },
                    'discord.com': { icon: 'fab fa-discord', color: '#5865f2' },
                    'google.com': { icon: 'fab fa-google', color: '#4285f4' },
                    'stackoverflow.com': { icon: 'fab fa-stack-overflow', color: '#f48024' },
                };
                
                const siteInfo = knownSites[domain] || knownSites[domain.replace('www.', '')];
                
                return {
                    title: domain,
                    description: url,
                    image: null,
                    domain: domain,
                    icon: siteInfo?.icon || 'fas fa-link',
                    iconColor: siteInfo?.color || 'var(--color-primary)'
                };
            } catch (e) {
                return null;
            }
        }
        
        function createLinkPreview(url, preview) {
            const domain = new URL(url).hostname;
            return `
                <a href="${url}" target="_blank" class="link-preview block mt-2" onclick="event.stopPropagation()">
                    <div class="link-preview-content">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0" style="background: ${preview.iconColor || 'var(--color-primary)'}20">
                                <i class="${preview.icon || 'fas fa-link'} text-lg" style="color: ${preview.iconColor || 'var(--color-primary)'}"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="link-preview-title">${preview.title || domain}</div>
                                <div class="link-preview-domain"><i class="fas fa-external-link-alt"></i> ${domain}</div>
                            </div>
                        </div>
                    </div>
                </a>`;
        }

        async function startStatsMonitoring() {
            const updateStats = async () => {
                if (calls.length === 0) {
                    document.getElementById('stat-connection').innerText = 'No active calls';
                    return;
                }
                
                const call = calls[0];
                if (!call.peerConnection) return;
                
                try {
                    const stats = await call.peerConnection.getStats();
                    stats.forEach(report => {
                        if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                            document.getElementById('stat-latency').innerText = Math.round(report.currentRoundTripTime * 1000) + ' ms';
                            document.getElementById('stat-connection').innerText = 'Connected';
                            updateQualityIndicator(report.currentRoundTripTime * 1000);
                        }
                        if (report.type === 'outbound-rtp' && report.kind === 'video') {
                            const bitrate = Math.round((report.bytesSent * 8) / 1000);
                            document.getElementById('stat-bitrate').innerText = bitrate + ' kbps';
                            document.getElementById('stat-fps').innerText = report.framesPerSecond ? report.framesPerSecond + ' fps' : '--';
                        }
                        if (report.type === 'track' && report.kind === 'video') {
                            document.getElementById('stat-resolution').innerText = `${report.frameWidth || '--'}x${report.frameHeight || '--'}`;
                        }
                    });
                } catch (e) { /* Stats not available */ }
            };
            
            updateStats();
            statsInterval = setInterval(updateStats, 2000);
        }

        function updateQualityIndicator(latency) {
            const bars = document.querySelectorAll('#quality-indicator .quality-bar');
            bars.forEach((bar, i) => {
                bar.classList.remove('active', 'warning', 'poor');
                if (latency < 100) {
                    bar.classList.add('active');
                } else if (latency < 200) {
                    if (i < 3) bar.classList.add('warning');
                } else {
                    if (i < 2) bar.classList.add('poor');
                }
            });
        }

        // --- Custom Alert/Confirm Logic ---
        function showCustomConfirm(title, message, onConfirm, onCancel = null) {
            const modal = document.getElementById('custom-modal');
            const content = document.getElementById('modal-content');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            
            const mIcon = document.getElementById('modal-icon');
            const mIconBg = document.getElementById('modal-icon-bg');
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');

            mIcon.className = "fas fa-question text-xl";
            mIcon.style.color = "var(--color-accent)";
            mIconBg.className = "w-12 h-12 rounded-full flex items-center justify-center";
            mIconBg.style.background = "rgba(139, 92, 246, 0.2)";
            confirmBtn.style.background = "var(--color-primary)";
            confirmBtn.innerText = "Confirm";
            cancelBtn.classList.remove('hidden');

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95'); content.classList.add('scale-100');
            }, 10);

            confirmBtn.onclick = () => { closeCustomModal(); if (onConfirm) onConfirm(); };
            cancelBtn.onclick = () => { closeCustomModal(); if (onCancel) onCancel(); };
        }

        function showCustomAlert(title, message) {
            const modal = document.getElementById('custom-modal');
            const content = document.getElementById('modal-content');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;

            const mIcon = document.getElementById('modal-icon');
            const mIconBg = document.getElementById('modal-icon-bg');
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');

            mIcon.className = "fas fa-info-circle text-xl";
            mIcon.style.color = "var(--color-primary)";
            mIconBg.className = "w-12 h-12 rounded-full flex items-center justify-center";
            mIconBg.style.background = "rgba(99, 102, 241, 0.2)";
            confirmBtn.style.background = "var(--color-secondary)";
            confirmBtn.innerText = "Close";
            cancelBtn.classList.add('hidden');

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95'); content.classList.add('scale-100');
            }, 10);

            confirmBtn.onclick = () => closeCustomModal();
        }

        function closeCustomModal() {
            const modal = document.getElementById('custom-modal');
            const content = document.getElementById('modal-content');
            if (!modal || !content) return;
            modal.classList.add('opacity-0'); 
            content.classList.remove('scale-100'); 
            content.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        // --- Persistent ID & Peer Init with STUN/TURN ---
        function initPeer() {
            let storedId = localStorage.getItem('uchat_id');
            if (!storedId) {
                storedId = Math.floor(100000 + Math.random() * 900000).toString();
                localStorage.setItem('uchat_id', storedId);
            }
            
            // Show stored ID immediately (before server connection)
            document.getElementById('my-id').innerText = storedId;

            // Initialize PeerJS with custom ICE servers for better NAT traversal
            try {
                peer = new Peer(storedId, { 
                    debug: 1,
                    config: {
                        iceServers: ICE_SERVERS,
                        iceCandidatePoolSize: 10,
                        bundlePolicy: 'max-bundle',
                        rtcpMuxPolicy: 'require'
                    }
                });
                
                peer.on('open', (id) => {
                    document.getElementById('my-id').innerText = id;
                    updateConnectionIndicator(true);
                    reconnectAttempts = 0; // Reset on successful connection
                    showToast(`Connected! ID: ${id}`, "success");
                    if(pendingInvite) processPendingInvite();
                    flushOfflineQueue(); // Send any queued messages
                });
                peer.on('connection', handleIncomingConnection);
                peer.on('call', handleIncomingCall);
                peer.on('disconnected', () => {
                    updateConnectionIndicator(false);
                    showToast("Disconnected from server. Reconnecting...", "warning");
                    smartReconnect(); // Use smart reconnect
                });
                peer.on('error', (err) => {
                    console.error('PeerJS Error:', err);
                    updateConnectionIndicator(false);
                    if(err.type === 'unavailable-id') { 
                        localStorage.removeItem('uchat_id'); 
                        showToast("ID unavailable. Generating new one...", "warning");
                        setTimeout(initPeer, 1000);
                    }
                    else if(err.type === 'network') {
                        showToast("Network error. Reconnecting...", "error");
                        smartReconnect();
                    }
                    else if(err.type === 'server-error') {
                        showToast("Server error. Retrying...", "error");
                        smartReconnect();
                    }
                    else if(err.type === 'peer-unavailable') {
                        showToast("Peer not found or offline.", "error");
                    }
                    else { showToast("Error: " + err.type, "error"); }
                });
            } catch (e) {
                console.error('Failed to initialize PeerJS:', e);
                showToast("Failed to initialize. Please refresh.", "error");
            }
        }
        
        // Update connection quality indicator
        function updateConnectionIndicator(connected) {
            const bars = document.querySelectorAll('#quality-indicator .quality-bar');
            bars.forEach((bar, i) => {
                bar.classList.remove('active', 'warning', 'poor');
                if (connected) {
                    bar.classList.add('active');
                } else {
                    bar.classList.add('poor');
                }
            });
        }

        function resetId() {
            showCustomConfirm("Reset Identity?", "Are you sure? Previous connections won't reach you anymore.", () => {
                localStorage.removeItem('uchat_id'); location.reload();
            });
        }

        // --- Invite Link Logic ---
        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const joinId = params.get('join');
            const type = params.get('type');
            if (joinId && type) {
                pendingInvite = { id: joinId, type: type };
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        function processPendingInvite() {
            const { id, type } = pendingInvite;
            showToast(`Joining invite for ID: ${id}...`, 'info');
            document.getElementById('remote-id').value = id;
            if (type === 'direct') connectDirect();
            else if (type === 'room' || type === 'group') joinPeer();
            pendingInvite = null;
        }

        function copyInviteLink() {
            if (myMode === 'idle') { showToast("Start a session first!", "error"); return; }
            let typeParam = myMode === 'direct' ? 'direct' : (myMode.includes('room') ? 'room' : 'group');
            const link = `${window.location.href.split('?')[0]}?join=${peer.id}&type=${typeParam}`;
            navigator.clipboard.writeText(link).then(() => showToast("Invite Link Copied!", "success"));
        }

        // --- Core Application Logic ---
        function setMode(mode) {
            if (connections.length > 0 || hostConn) { showCustomConfirm("Start New Session?", "Current connections will be lost.", () => { resetSession(); setupMode(mode); }); return; }
            setupMode(mode);
        }
        function setupMode(mode) {
            isHost = true; myMode = mode === 'room' ? 'host-room' : 'host-group';
            updateUIForMode(myMode); showToast(`${mode === 'room' ? 'Room' : 'Group'} Created! Share your ID.`, "success");
            if(myMode === 'host-room') startLocalVideo();
        }
        function joinPeer() {
            const id = document.getElementById('remote-id').value.trim();
            if(!id) return showToast("Enter ID", "error"); if(id === peer.id) return showToast("Cannot join self", "error");
            if(connections.length > 0 || hostConn) { showCustomConfirm("Join New Host?", "Current session will be closed.", () => { resetSession(); initJoin(id); }); return; }
            initJoin(id);
        }
        function initJoin(id) {
            isHost = false; document.getElementById('btn-join').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            hostConn = peer.connect(id, { metadata: { type: 'join-request' } }); setupDataConnection(hostConn);
        }
        function connectDirect() {
            const id = document.getElementById('remote-id').value.trim();
            if(!id) return showToast("Enter Peer ID", "error"); if(id === peer.id) return showToast("Cannot connect to self", "error");
            if(connections.length > 0 || hostConn) { showCustomConfirm("Start New Chat?", "Current session will be closed.", () => { resetSession(); initDirect(id); }); return; }
            initDirect(id);
        }
        function initDirect(id) {
            isHost = false; myMode = 'direct'; document.getElementById('btn-direct').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            const conn = peer.connect(id, { metadata: { type: 'direct' } });
            
            // Set timeout to detect if user is offline
            const connectionTimeout = setTimeout(() => {
                if (!conn.open) {
                    showToast("User appears to be offline. They may not receive your connection request.", "warning");
                    // Show alert modal
                    showCustomConfirm(
                        "User Offline", 
                        "The user you're trying to connect to appears to be offline. Would you like to wait for them to come online?",
                        () => {
                            // Continue waiting
                            showToast("Waiting for user to come online...", "info");
                        },
                        () => {
                            // Cancel connection
                            conn.close();
                            resetSession();
                            document.getElementById('btn-direct').innerHTML = '<i class="fas fa-comment-dots"></i><span class="text-[10px]">CHAT ONLY</span>';
                        }
                    );
                }
            }, 10000); // 10 second timeout
            
            conn.on('open', () => {
                clearTimeout(connectionTimeout);
            });
            
            setupDataConnection(conn); connections.push(conn); updateUIForMode('direct');
        }

        function handleIncomingConnection(conn) {
            const meta = conn.metadata || {};
            
            // Check if blocking unknown connections
            if (privacySettings.blockUnknown) {
                // Check if this peer is in saved friends
                const friends = JSON.parse(localStorage.getItem('uchat_friends') || '[]');
                const isFriend = friends.some(f => f.id === conn.peer);
                
                if (!isFriend && meta.type !== 'global-room' && !meta.isGlobalRoom) {
                    conn.on('open', () => { 
                        conn.send({type:'system', msg:'This user only accepts connections from friends'}); 
                        setTimeout(()=>conn.close(),500); 
                    });
                    showToast("Blocked connection from unknown user", "warning");
                    return;
                }
            }
            
            // Handle global room connections
            if (meta.type === 'global-room' || meta.isGlobalRoom) {
                if (isInGlobalRoom) {
                    conn.metadata = { ...meta, isGlobalRoom: true };
                    setupDataConnection(conn);
                    connections.push(conn);
                    
                    // Add to global users and notify
                    conn.on('open', () => {
                        const payload = { type: 'global-join', peerId: peer.id, name: myName };
                        conn.send(payload);
                    });
                    return;
                } else {
                    conn.on('open', () => { conn.send({type:'system', msg:'User not in global room'}); setTimeout(()=>conn.close(),500); });
                    return;
                }
            }
            
            if (isHost) {
                if (myMode === 'host-room' && connections.length >= 4) { conn.on('open', () => { conn.send({type:'system', msg:'Room Full'}); setTimeout(()=>conn.close(),500); }); return; }
                setupDataConnection(conn);
            } 
            else if (meta.type === 'direct') {
                if (myMode !== 'idle' && myMode !== 'direct') { conn.on('open', () => { conn.send({type:'system', msg:'User busy'}); setTimeout(()=>conn.close(),500); }); return; }
                
                // Determine call type from metadata
                const callType = meta.callType;
                let requestMessage = `Direct Chat request from ${conn.peer}. Accept?`;
                if (callType === 'voice') {
                    requestMessage = `üìû Incoming Voice Call from ${conn.peer}. Accept?`;
                } else if (callType === 'video') {
                    requestMessage = `üìπ Incoming Video Call from ${conn.peer}. Accept?`;
                }
                
                // Check if require approval is enabled
                if (privacySettings.requireApproval) {
                    showCustomConfirm("Incoming Request", requestMessage, () => {
                        resetSession(); myMode = 'direct'; isHost = false; connections.push(conn); setupDataConnection(conn); updateUIForMode('direct');
                    }, () => { 
                        conn.on('open', () => { 
                            conn.send({type:'system', msg:'Connection request declined'}); 
                            setTimeout(()=>conn.close(),500); 
                        }); 
                    });
                } else {
                    // Auto-accept connection
                    resetSession(); myMode = 'direct'; isHost = false; connections.push(conn); setupDataConnection(conn); updateUIForMode('direct');
                    let acceptMsg = "Direct connection accepted automatically";
                    if (callType === 'voice') acceptMsg = "üìû Voice call accepted automatically";
                    else if (callType === 'video') acceptMsg = "üìπ Video call accepted automatically";
                    showToast(acceptMsg, "info");
                }
            }
            else { conn.on('open', () => conn.close()); }
        }

        function setupDataConnection(conn) {
            conn.on('open', () => {
                const isStored = connections.find(c => c.peer === conn.peer);
                if((isHost || myMode === 'direct') && !isStored) connections.push(conn);
                conn.send({ type: 'meta', sub: 'handshake', name: myName, mode: myMode }); 
                updateConnectionStatus();
                if(isHost) {
                    broadcastData({ type: 'system', msg: 'New user joined' }, conn.peer);
                    if(myMode === 'host-room') {
                        const peerList = connections.map(c => c.peer).filter(id => id !== conn.peer);
                        conn.send({ type: 'meta', sub: 'peer-list', peers: peerList });
                    }
                }
                if(myMode === 'direct') { showToast("Direct Connection Established", "success"); document.getElementById('btn-direct').innerHTML = '<i class="fas fa-comment-dots mb-1"></i><span class="text-[10px]">CHAT ONLY</span>'; }
            });
            conn.on('data', (data) => handleData(data, conn));
            conn.on('close', () => handleDisconnect(conn.peer));
            conn.on('error', () => showToast("Connection Error", "error"));
        }

        function handleDisconnect(peerId) {
            connections = connections.filter(c => c.peer !== peerId);
            if(hostConn && hostConn.peer === peerId) hostConn = null;
            // Also remove from calls list if any
            calls = calls.filter(c => c.peer !== peerId);
            
            // Remove from participants
            removeParticipant(peerId);
            
            removeRemoteVideo(peerId);
            
            // Handle global room disconnect
            if (isInGlobalRoom) {
                // Find user name from globalRoomUsers
                const userName = globalRoomUsers[peerId]?.name || 'User';
                delete globalRoomUsers[peerId];
                appendSystemMessage(`üëã ${userName} left UChat All`);
                updateGlobalRoomUI();
                
                // Check if room is empty (only self remains)
                if (Object.keys(globalRoomUsers).length <= 1 && connections.length === 0) {
                    showToast("Everyone left. You're the last one in UChat All.", "info");
                }
                updateConnectionStatus();
                return;
            }
            
            if(isHost) broadcastData({ type: 'system', msg: 'User disconnected' });
            else if (myMode === 'direct') { showToast("User Disconnected", "warning"); resetSession(); }
            else { showToast("Host Disconnected", "error"); resetSession(); }
            updateConnectionStatus();
        }

        function handleData(data, conn) {
            // Handle global room messages separately
            if (isInGlobalRoom && (data.type?.startsWith('global-') || conn.metadata?.isGlobalRoom)) {
                handleGlobalRoomMessage(data, conn);
                return;
            }
            
            if (isHost) broadcastData(data, conn.peer); 
            switch (data.type) {
                case 'text': 
                    appendMessage(data.content, 'in', data.sender, data.replyTo, data.msgId);
                    // Send read receipt
                    if (data.msgId) sendReadReceipt(data.msgId);
                    break;
                case 'file': handleIncomingFile(data); break;
                case 'file-chunk': handleFileChunk(data); break;
                case 'file-start': handleFileStart(data); break;
                case 'file-end': handleFileEnd(data); break;
                case 'viewonce': handleIncomingViewOnce(data); break;
                case 'delete-for-everyone':
                    handleDeleteForEveryone(data.msgId, data.sender);
                    break;
                case 'gif': 
                    appendGifMessage(data.url, 'in', data.sender);
                    sendNotification(data.sender, 'üé¨ Sent a GIF', 'üé¨');
                    break;
                case 'reaction':
                    // Handle incoming reaction
                    const msg = messageHistory.find(m => m.id === data.msgId);
                    if (msg) {
                        if (!msg.reactions) msg.reactions = {};
                        if (!msg.reactions[data.emoji]) msg.reactions[data.emoji] = [];
                        if (!msg.reactions[data.emoji].includes(data.user)) {
                            msg.reactions[data.emoji].push(data.user);
                            updateMessageReactions(data.msgId, msg.reactions);
                        }
                    }
                    break;
                case 'read-receipt':
                    // Update read status
                    updateReadReceipt(data.msgId, 'read');
                    break;
                case 'meta':
                    if(data.sub === 'handshake') {
                        // Add to participants
                        addParticipant(conn.peer, data.name, false, false);
                        
                        // Flush offline queue on successful connection
                        reconnectAttempts = 0;
                        flushOfflineQueue();
                        
                        if(myMode === 'idle' && !isHost && !connections.length) { 
                            if(data.mode === 'host-room') myMode = 'client-room'; else if(data.mode === 'host-group') myMode = 'client-group';
                            updateUIForMode(myMode); if(myMode === 'client-room') startLocalVideo();
                            showToast(`Joined ${data.name}`, "success"); document.getElementById('btn-join').innerHTML = '<i class="fas fa-sign-in-alt mb-1"></i><span class="text-[10px]">JOIN HOST</span>';
                        }
                        if (myMode === 'direct') {
                            connectedPeerName = data.name; // Store peer name
                            document.getElementById('header-title').innerText = "ü§ù " + data.name;
                        }
                    } else if (data.sub === 'peer-list') { 
                        if(myMode === 'client-room') connectToPeersForVideo(data.peers); 
                    } else if (data.sub === 'participants-update') {
                        // Update participants from host
                        Object.entries(data.participants).forEach(([id, info]) => {
                            if (id !== peer.id) participants[id] = info;
                        });
                        updateParticipantsList();
                    } else if (data.sub === 'media-state') {
                        // Update participant media state
                        if (participants[conn.peer]) {
                            participants[conn.peer].isVideo = data.video;
                            participants[conn.peer].isAudio = data.audio;
                            updateParticipantsList();
                        }
                    }
                    break;
                case 'typing': showTypingIndicator(data.sender); break;
                case 'system': showToast(data.msg, "info"); break;
            }
        }
        
        // --- Typing Indicator ---
        let typingHideTimeout = null;
        function showTypingIndicator(sender) {
            const indicator = document.getElementById('typing-indicator');
            indicator.innerHTML = `<i class="fas fa-comment-dots mr-1"></i>${sender} is typing <span class="typing-dot">.</span><span class="typing-dot">.</span><span class="typing-dot">.</span>`;
            indicator.classList.remove('hidden');
            
            if (typingHideTimeout) clearTimeout(typingHideTimeout);
            typingHideTimeout = setTimeout(() => {
                indicator.classList.add('hidden');
            }, 3000);
        }

        function broadcastData(data, excludePeerId = null) { connections.forEach(c => { if (c.peer !== excludePeerId && c.open) c.send(data); }); }

        function sendMessage() {
            const text = document.getElementById('msg-input').value.trim(); 
            if(!text) return;
            
            // Handle global room messages separately
            if (isInGlobalRoom) {
                sendGlobalMessage();
                return;
            }
            
            // Create message ID
            const msgId = `msg-${++messageIdCounter}`;
            
            // Build payload with optional reply
            const payload = { 
                type: 'text', 
                content: text, 
                sender: myName, 
                timestamp: Date.now(),
                msgId: msgId,
                replyTo: replyingTo ? { id: replyingTo.id, sender: replyingTo.sender, text: replyingTo.text } : null
            };
            
            // Check connection and send
            if (isHost || myMode === 'direct') {
                broadcastData(payload);
            } else if (hostConn && hostConn.open) {
                hostConn.send(payload);
            } else {
                // Queue for offline sending
                queueOfflineMessage(payload);
                return;
            }
            
            // Append message locally
            appendMessage(text, 'out', 'Me', replyingTo, msgId);
            
            // Clear input and reply
            document.getElementById('msg-input').value = '';
            cancelReply();
            autoResize(document.getElementById('msg-input'));
        }

        // --- High-Speed Video / Screen Share Logic ---
        async function startLocalVideo() {
            try {
                const q = VIDEO_QUALITY[currentVideoQuality];
                
                // Get optimized stream with quality settings
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: {
                        width: { ideal: q.width, max: 1920 },
                        height: { ideal: q.height, max: 1080 },
                        frameRate: { ideal: q.frameRate, max: 60 },
                        facingMode: 'user'
                    }, 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 48000,
                        channelCount: 2
                    }
                });
                
                localStream = stream;
                localCamTrack = stream.getVideoTracks()[0];
                
                const videoEl = document.getElementById('local-video');
                videoEl.srcObject = localStream;
                videoEl.classList.add('mirror'); 
                document.getElementById('local-video-card').classList.remove('hidden');
                
                setVideoLayout(true);
                updateMediaIcons(true, true, false);
                document.getElementById('btn-stats').classList.remove('hidden');
                
                // Start voice activity visualization
                startVoiceVisualization(stream);

                // Call existing peers with optimized settings
                if(!isHost && hostConn && myMode === 'client-room') {
                    const call = peer.call(hostConn.peer, localStream, {
                        sdpTransform: optimizeSDP
                    });
                    handleCall(call);
                }
                if(myMode === 'direct' && connections.length > 0) {
                    const call = peer.call(connections[0].peer, localStream, {
                        sdpTransform: optimizeSDP
                    });
                    handleCall(call);
                }
            } catch (e) {
                console.error('Camera error:', e);
                showToast("Camera/Mic access denied. Check permissions.", "error");
            }
        }
        
        // Voice Call Only (Audio without Video)
        async function startVoiceCallDirect() {
            const id = document.getElementById('remote-id').value.trim();
            if(!id) return showToast("Enter Peer ID", "error");
            if(id === peer.id) return showToast("Cannot call yourself", "error");
            
            // First establish connection if not already connected
            if (myMode !== 'direct' || connections.length === 0) {
                if(connections.length > 0 || hostConn) { 
                    showCustomConfirm("Start New Call?", "Current session will be closed.", () => { 
                        resetSession(); 
                        initDirectWithVoiceCall(id); 
                    }); 
                    return; 
                }
                initDirectWithVoiceCall(id);
            } else {
                // Already connected, start voice call
                await startVoiceOnlyStream();
            }
        }
        
        function initDirectWithVoiceCall(id) {
            isHost = false; myMode = 'direct';
            document.getElementById('btn-voice-call').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            const conn = peer.connect(id, { metadata: { type: 'direct', callType: 'voice' } });
            
            // Set timeout to detect if user is offline
            const connectionTimeout = setTimeout(() => {
                if (!conn.open) {
                    showToast("User appears to be offline", "warning");
                    showCustomConfirm(
                        "User Offline", 
                        "The user you're trying to call appears to be offline. Would you like to wait?",
                        () => { showToast("Waiting for user...", "info"); },
                        () => {
                            conn.close();
                            resetSession();
                            document.getElementById('btn-voice-call').innerHTML = '<i class="fas fa-phone-alt"></i><span class="text-[10px]">VOICE CALL</span>';
                        }
                    );
                }
            }, 10000);
            
            conn.on('open', async () => {
                clearTimeout(connectionTimeout);
                document.getElementById('btn-voice-call').innerHTML = '<i class="fas fa-phone-alt"></i><span class="text-[10px]">VOICE CALL</span>';
                await startVoiceOnlyStream();
            });
            
            setupDataConnection(conn); 
            connections.push(conn); 
            updateUIForMode('direct');
        }
        
        async function startVoiceOnlyStream() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: false,
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 48000,
                        channelCount: 2
                    }
                });
                
                localStream = stream;
                
                // Don't show video area for voice only
                document.getElementById('media-controls').classList.remove('hidden');
                updateMediaIcons(true, false, false);
                
                // Call the peer with audio only
                if(connections.length > 0) {
                    const call = peer.call(connections[0].peer, localStream, {
                        sdpTransform: optimizeSDP
                    });
                    handleCall(call);
                }
                
                showToast("Voice call started", "success");
            } catch (e) {
                console.error('Microphone error:', e);
                showToast("Microphone access denied", "error");
            }
        }
        
        // Video Call (Audio + Video)
        async function startVideoCallDirect() {
            const id = document.getElementById('remote-id').value.trim();
            if(!id) return showToast("Enter Peer ID", "error");
            if(id === peer.id) return showToast("Cannot call yourself", "error");
            
            // First establish connection if not already connected
            if (myMode !== 'direct' || connections.length === 0) {
                if(connections.length > 0 || hostConn) { 
                    showCustomConfirm("Start New Call?", "Current session will be closed.", () => { 
                        resetSession(); 
                        initDirectWithVideoCall(id); 
                    }); 
                    return; 
                }
                initDirectWithVideoCall(id);
            } else {
                // Already connected, start video call
                await startLocalVideo();
            }
        }
        
        function initDirectWithVideoCall(id) {
            isHost = false; myMode = 'direct';
            document.getElementById('btn-video-call').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            const conn = peer.connect(id, { metadata: { type: 'direct', callType: 'video' } });
            
            // Set timeout to detect if user is offline
            const connectionTimeout = setTimeout(() => {
                if (!conn.open) {
                    showToast("User appears to be offline", "warning");
                    showCustomConfirm(
                        "User Offline", 
                        "The user you're trying to call appears to be offline. Would you like to wait?",
                        () => { showToast("Waiting for user...", "info"); },
                        () => {
                            conn.close();
                            resetSession();
                            document.getElementById('btn-video-call').innerHTML = '<i class="fas fa-video"></i><span class="text-[10px]">VIDEO CALL</span>';
                        }
                    );
                }
            }, 10000);
            
            conn.on('open', async () => {
                clearTimeout(connectionTimeout);
                document.getElementById('btn-video-call').innerHTML = '<i class="fas fa-video"></i><span class="text-[10px]">VIDEO CALL</span>';
                await startLocalVideo();
            });
            
            setupDataConnection(conn); 
            connections.push(conn); 
            updateUIForMode('direct');
        }

        // SDP Optimization for better bitrate
        function optimizeSDP(sdp) {
            const q = VIDEO_QUALITY[currentVideoQuality];
            // Modify video bitrate in SDP
            let modifiedSDP = sdp;
            
            // Set video bitrate
            const videoBitrate = q.bitrate;
            modifiedSDP = modifiedSDP.replace(/b=AS:.*\r\n/g, '');
            modifiedSDP = modifiedSDP.replace(/(m=video.*\r\n)/g, `$1b=AS:${Math.floor(videoBitrate / 1000)}\r\n`);
            
            // Set audio bitrate (128kbps for good quality)
            modifiedSDP = modifiedSDP.replace(/(m=audio.*\r\n)/g, `$1b=AS:128\r\n`);
            
            return modifiedSDP;
        }

        async function toggleScreenShare() {
            if(!localStream) { showToast("Start video first", "error"); return; }
            if(isScreenSharing) {
                stopScreenShare();
            } else {
                try {
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({ 
                        video: {
                            cursor: 'always',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 },
                            frameRate: { ideal: 30 }
                        },
                        audio: true // Include system audio if available
                    });
                    const screenTrack = screenStream.getVideoTracks()[0];
                    screenTrack.onended = () => stopScreenShare();

                    // Replace track in local stream (for view)
                    const currentVideoTrack = localStream.getVideoTracks()[0];
                    if(currentVideoTrack) localStream.removeTrack(currentVideoTrack);
                    localStream.addTrack(screenTrack);
                    
                    // Update Local Video Element
                    const videoEl = document.getElementById('local-video');
                    videoEl.srcObject = null; videoEl.srcObject = localStream;
                    videoEl.classList.remove('mirror');

                    // Replace track in all Peer Connections
                    calls.forEach(call => {
                        const sender = call.peerConnection.getSenders().find(s => s.track && s.track.kind === 'video');
                        if(sender) sender.replaceTrack(screenTrack);
                    });

                    isScreenSharing = true;
                    updateMediaIcons(localStream.getAudioTracks()[0]?.enabled, true, true);
                    showToast("Screen sharing started", "success");
                } catch(e) { 
                    console.error("Screen share error", e); 
                    if (e.name !== 'NotAllowedError') {
                        showToast("Screen share failed", "error");
                    }
                }
            }
        }

        function stopScreenShare() {
             if(!isScreenSharing || !localCamTrack) return;
             
             // Remove screen track
             const screenTrack = localStream.getVideoTracks()[0];
             if(screenTrack) {
                 screenTrack.stop();
                 localStream.removeTrack(screenTrack);
             }
             
             // Add back camera track
             localStream.addTrack(localCamTrack);
             
             // Update Local Video
             const videoEl = document.getElementById('local-video');
             videoEl.srcObject = null; videoEl.srcObject = localStream;
             videoEl.classList.add('mirror');

             // Replace track in Peers
             calls.forEach(call => {
                const sender = call.peerConnection.getSenders().find(s => s.track.kind === 'video');
                if(sender) sender.replaceTrack(localCamTrack);
             });

             isScreenSharing = false;
             updateMediaIcons(localStream.getAudioTracks()[0]?.enabled, true, false);
        }

        function connectToPeersForVideo(peerList) {
            peerList.forEach(pid => {
                if(pid !== peer.id) {
                    const call = peer.call(pid, localStream);
                    handleCall(call);
                }
            });
        }
        function handleIncomingCall(call) {
            if (myMode.includes('room') || myMode === 'direct') {
                setVideoLayout(true);
                if(!localStream) { call.answer(); handleCall(call); showToast("Incoming Video/Audio...", "info"); }
                else { call.answer(localStream); handleCall(call); }
            } else { call.close(); }
        }
        
        function handleCall(call) {
            calls.push(call);
            const videoId = `video-${call.peer}`;
            if(!document.getElementById(videoId)) addRemoteVideoElement(videoId, call.peer);
            
            call.on('stream', (remoteStream) => {
                const vid = document.getElementById(videoId); 
                if(vid) {
                    vid.srcObject = remoteStream;
                    vid.play().catch(e => console.log('Autoplay blocked'));
                }
            });
            call.on('close', () => { removeRemoteVideo(call.peer); calls = calls.filter(c => c.peer !== call.peer); });
            call.on('error', (err) => { console.error('Call error:', err); });
        }
        
        function addRemoteVideoElement(id, peerId) {
            const container = document.getElementById('video-grid');
            const card = document.createElement('div'); 
            card.className = "video-card animate-zoom-in"; 
            card.id = `card-${peerId}`;
            
            // Get participant name if available
            const participantInfo = participants[peerId];
            const displayName = participantInfo?.name || peerId.substring(0, 8);
            
            card.innerHTML = `
                <video id="${id}" autoplay playsinline></video>
                <div class="video-overlay"></div>
                <div class="stream-badge">
                    <div class="online-dot"></div>
                    <span>LIVE</span>
                </div>
                <div class="stream-quality-badge">${currentVideoQuality.toUpperCase()}</div>
                <div class="absolute bottom-2 left-2 bg-black/70 px-3 py-1.5 rounded-lg text-[11px] text-white flex items-center gap-2 backdrop-blur-sm">
                    <i class="fas fa-user-circle"></i> 
                    <span class="truncate max-w-[100px]" id="name-${peerId}">${displayName}</span>
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                </div>`;
            container.appendChild(card); 
            setVideoLayout(true);
        }
        
        // Update video card names when participant info is received
        function updateVideoCardName(peerId, name) {
            const nameEl = document.getElementById(`name-${peerId}`);
            if (nameEl) nameEl.innerText = name;
        }
        
        function removeRemoteVideo(peerId) { 
            const card = document.getElementById(`card-${peerId}`); 
            if(card) {
                card.style.opacity = '0';
                card.style.transform = 'scale(0.9)';
                setTimeout(() => card.remove(), 300);
            }
        }
        
        function setVideoLayout(showVideo) {
            const videoArea = document.getElementById('video-area'); 
            const chatBox = document.getElementById('chat-box');
            if(showVideo) { 
                videoArea.classList.remove('hidden'); 
                chatBox.style.maxHeight = "40%"; 
                chatBox.style.flex = "0 0 auto";
            } else { 
                videoArea.classList.add('hidden'); 
                chatBox.style.maxHeight = "none";
                chatBox.style.flex = "1";
            }
        }
        
        function toggleAudio() {
            if(!localStream) { startLocalVideo(); return; }
            const track = localStream.getAudioTracks()[0]; 
            if (track) {
                track.enabled = !track.enabled;
                updateMediaIcons(track.enabled, localStream.getVideoTracks()[0]?.enabled, isScreenSharing);
                // Update local mic indicator
                const indicator = document.getElementById('local-mic-indicator');
                if (indicator) {
                    indicator.style.background = track.enabled ? '#22c55e' : '#ef4444';
                }
            }
        }
        
        function toggleVideo() {
            if(!localStream) { startLocalVideo(); return; }
            if(isScreenSharing) { showToast("Stop screen share to toggle camera", "warning"); return; }
            const track = localStream.getVideoTracks()[0]; 
            if (track) {
                track.enabled = !track.enabled;
                updateMediaIcons(localStream.getAudioTracks()[0]?.enabled, track.enabled, isScreenSharing);
                
                // Hide/show local video card based on video state
                const localVideoCard = document.getElementById('local-video-card');
                if (localVideoCard) {
                    if (track.enabled) {
                        localVideoCard.classList.remove('hidden');
                    } else {
                        localVideoCard.classList.add('hidden');
                    }
                }
                
                // Check if all videos are off to hide video area
                checkAndHideVideoArea();
            }
        }
        
        function checkAndHideVideoArea() {
            const videoGrid = document.getElementById('video-grid');
            const localVideoCard = document.getElementById('local-video-card');
            const remoteCards = videoGrid.querySelectorAll('.video-card:not(#local-video-card)');
            
            const localVideoVisible = localVideoCard && !localVideoCard.classList.contains('hidden');
            const hasRemoteVideos = remoteCards.length > 0;
            
            // If no local video and no remote videos, hide the video area
            if (!localVideoVisible && !hasRemoteVideos) {
                setVideoLayout(false);
            } else {
                setVideoLayout(true);
            }
        }
        
        function updateMediaIcons(audioOn, videoOn, screenOn) {
            const btnMic = document.getElementById('btn-mic'); 
            const btnCam = document.getElementById('btn-cam'); 
            const btnScreen = document.getElementById('btn-screen');
            
            if(audioOn) { 
                btnMic.style.background = 'white';
                btnMic.style.color = 'black';
                btnMic.innerHTML = '<i class="fas fa-microphone"></i>'; 
            } else { 
                btnMic.style.background = 'var(--color-surface)';
                btnMic.style.color = 'var(--color-text-primary)';
                btnMic.innerHTML = '<i class="fas fa-microphone-slash"></i>'; 
            }
            
            if(videoOn) { 
                btnCam.style.background = 'white';
                btnCam.style.color = 'black';
                btnCam.innerHTML = '<i class="fas fa-video"></i>'; 
            } else { 
                btnCam.style.background = 'var(--color-surface)';
                btnCam.style.color = 'var(--color-text-primary)';
                btnCam.innerHTML = '<i class="fas fa-video-slash"></i>'; 
            }
            
            if(screenOn) {
                btnScreen.style.background = '#22c55e';
                btnScreen.style.color = 'white';
            } else {
                btnScreen.style.background = 'var(--color-surface)';
                btnScreen.style.color = 'var(--color-text-primary)';
            }
        }
        
        function leaveSession() { showCustomConfirm("End Session?", "Are you sure you want to disconnect?", () => { resetSession(); }); }

        // --- File/Media Handling ---
        function startRecording() {
            if (!isHost && (!hostConn || !hostConn.open) && myMode !== 'direct') return showToast("Connect to someone first!", "error");
            navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    sampleRate: 44100
                }
            }).then(stream => {
                    let mimeType = 'audio/webm';
                    if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) mimeType = 'audio/webm;codecs=opus';
                    else if (MediaRecorder.isTypeSupported('audio/mp4')) mimeType = 'audio/mp4';
                    mediaRecorder = new MediaRecorder(stream, { mimeType, audioBitsPerSecond: 128000 });
                    audioChunks = []; isRecordingCancelled = false;
                    mediaRecorder.ondataavailable = event => { if (event.data.size > 0) audioChunks.push(event.data); };
                    mediaRecorder.onstop = () => {
                        stream.getTracks().forEach(track => track.stop()); clearInterval(recordingInterval);
                        if (isRecordingCancelled || audioChunks.length === 0) return;
                        const audioBlob = new Blob(audioChunks, { type: mimeType });
                        const ext = mimeType.includes('mp4') ? 'mp4' : 'webm';
                        const voiceFile = new File([audioBlob], `voice_${Date.now()}.${ext}`, { type: mimeType });
                        const voiceMsgId = `msg-${++messageIdCounter}`;
                        const payload = { type: 'file', file: voiceFile, filename: voiceFile.name, filetype: voiceFile.type, filesize: voiceFile.size, previewType: 'voice', sender: myName, msgId: voiceMsgId };
                        if(isHost || myMode === 'direct') broadcastData(payload); else if(hostConn) hostConn.send(payload);
                        const url = URL.createObjectURL(audioBlob); appendVoiceMessage(url, 'out', 'Me', voiceMsgId);
                    };
                    mediaRecorder.start();
                    document.getElementById('recording-ui').classList.remove('hidden'); 
                    document.getElementById('msg-input').classList.add('opacity-0'); 
                    document.getElementById('btn-record-toggle').style.color = '#ef4444';
                    document.getElementById('btn-record-toggle').classList.add('animate-pulse');
                    recordingStartTime = Date.now();
                    recordingInterval = setInterval(() => { 
                        const diff = Date.now() - recordingStartTime; 
                        const seconds = Math.floor((diff / 1000) % 60); 
                        const minutes = Math.floor((diff / 1000 / 60)); 
                        document.getElementById('rec-time').innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`; 
                    }, 1000);
                }).catch(err => { showToast("Microphone access denied", "error"); });
        }
        
        function stopAndSendRecording() { 
            if (mediaRecorder && mediaRecorder.state !== 'inactive') { 
                isRecordingCancelled = false; 
                mediaRecorder.stop(); 
                resetRecordingUI(); 
            } 
        }
        
        function cancelRecording() { 
            if (mediaRecorder && mediaRecorder.state !== 'inactive') { 
                isRecordingCancelled = true; 
                mediaRecorder.stop(); 
                resetRecordingUI(); 
                showToast("Recording cancelled", "info"); 
            } 
        }
        
        function resetRecordingUI() { 
            document.getElementById('recording-ui').classList.add('hidden'); 
            document.getElementById('msg-input').classList.remove('opacity-0'); 
            document.getElementById('rec-time').innerText = "00:00"; 
            document.getElementById('btn-record-toggle').style.color = 'var(--color-text-secondary)';
            document.getElementById('btn-record-toggle').classList.remove('animate-pulse'); 
        }
        
        function triggerFileSelect(mode) { 
            toggleAttachmentMenu(); 
            if (mode === 'viewonce') {
                document.getElementById('file-input-viewonce').click();
            } else {
                document.getElementById(mode === 'media' ? 'file-input-media' : 'file-input-doc').click(); 
            }
        }
        
        // --- Chunked File Transfer System (Unlimited Size) ---
        function handleFileSelect(input, mode) {
            const file = input.files[0]; if(!file) return;
            
            let previewType = null;
            if (mode === 'media' || mode === 'viewonce') { 
                if (file.type.startsWith('image/')) previewType = 'image'; 
                else if (file.type.startsWith('video/')) previewType = 'video'; 
            }
            
            // Handle View Once media
            if (mode === 'viewonce') {
                sendViewOnceMedia(file, previewType);
                input.value = '';
                return;
            }
            
            // For small files (<5MB), send directly
            if (file.size < 5 * 1024 * 1024) {
                showToast("Sending file...", "info");
                const payload = { type: 'file', file: file, filename: file.name, filetype: file.type, filesize: file.size, previewType: previewType, sender: myName };
                if(isHost || myMode === 'direct') broadcastData(payload); else if(hostConn) hostConn.send(payload);
                const url = URL.createObjectURL(file);
                if (previewType === 'image') appendImageMessage(url, 'out', 'Me', file.name); 
                else if (previewType === 'video') appendVideoMessage(url, 'out', 'Me', file.name); 
                else appendFileMessage(file.name, file.size, 'out', url, file.type, 'Me');
            } else {
                // Large file - use chunked transfer
                sendChunkedFile(file, previewType);
            }
            input.value = '';
        }
        
        // --- View Once Media System ---
        function sendViewOnceMedia(file, previewType) {
            const viewOnceId = `vo-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            
            showToast("Sending view-once media...", "info");
            
            const payload = { 
                type: 'viewonce', 
                file: file, 
                filename: file.name, 
                filetype: file.type, 
                filesize: file.size, 
                previewType: previewType, 
                sender: myName,
                viewOnceId: viewOnceId
            };
            
            if(isHost || myMode === 'direct') broadcastData(payload); 
            else if(hostConn) hostConn.send(payload);
            
            // Show local view-once message
            appendViewOnceMessage(viewOnceId, previewType, 'out', 'Me', URL.createObjectURL(file), true);
        }
        
        function handleIncomingViewOnce(data) {
            const blob = new Blob([data.file], {type: data.filetype});
            const url = URL.createObjectURL(blob);
            
            // Store view once data
            viewOnceMedia[data.viewOnceId] = {
                viewed: false,
                url: url,
                type: data.previewType,
                sender: data.sender
            };
            
            appendViewOnceMessage(data.viewOnceId, data.previewType, 'in', data.sender, null, false);
            sendNotification(data.sender, `üì∏ Sent a view-once ${data.previewType}`, 'üì∏');
        }
        
        function appendViewOnceMessage(viewOnceId, mediaType, dir, sender, localUrl = null, isSender = false) {
            const chatBox = document.getElementById('chat-box'); 
            if(chatBox.querySelector('h3')) chatBox.innerHTML = ''; 
            
            const msgId = `msg-${++messageIdCounter}`;
            const div = document.createElement('div'); 
            div.id = msgId;
            div.dataset.msgId = msgId;
            div.dataset.viewOnceId = viewOnceId;
            div.className = `flex w-full ${dir === 'out' ? 'justify-end' : 'justify-start'} animate-fade-in`;
            
            const icon = mediaType === 'image' ? 'fa-camera' : 'fa-video';
            const mediaLabel = mediaType === 'image' ? 'Photo' : 'Video';
            
            if (isSender) {
                // Sender sees a confirmation that it was sent
                div.innerHTML = `
                    <div class="max-w-[70%] flex flex-col ${dir === 'out' ? 'items-end' : 'items-start'}">
                        <span class="text-[9px] mb-1 px-1" style="color: var(--color-text-secondary)">${sender}</span>
                        <div class="view-once-container w-48 h-32 rounded-2xl overflow-hidden" style="background: var(--color-surface); border: 1px solid var(--color-border)">
                            <div class="view-once-overlay" style="opacity: 0.9">
                                <div class="view-once-icon">
                                    <i class="fas ${icon} text-white text-xl"></i>
                                </div>
                                <span class="text-white text-sm font-medium">View Once ${mediaLabel}</span>
                                <span class="text-white/60 text-[10px]">Sent successfully</span>
                            </div>
                            <div class="view-once-badge"><i class="fas fa-eye-slash"></i> 1</div>
                        </div>
                        <span class="text-[9px] mt-1 px-1" style="color: var(--color-text-secondary)">${getTime()}</span>
                    </div>`;
            } else {
                // Receiver sees clickable view once
                div.innerHTML = `
                    <div class="max-w-[70%] flex flex-col ${dir === 'out' ? 'items-end' : 'items-start'}">
                        <span class="text-[9px] mb-1 px-1" style="color: var(--color-text-secondary)">${sender}</span>
                        <div class="view-once-container w-48 h-32 rounded-2xl overflow-hidden cursor-pointer" onclick="openViewOnce('${viewOnceId}')" style="background: var(--color-surface); border: 1px solid var(--color-border)">
                            <div class="view-once-overlay" id="vo-overlay-${viewOnceId}">
                                <div class="view-once-icon">
                                    <i class="fas ${icon} text-white text-xl"></i>
                                </div>
                                <span class="text-white text-sm font-medium">View Once ${mediaLabel}</span>
                                <span class="text-white/60 text-[10px]">Tap to view</span>
                            </div>
                            <div class="view-once-badge"><i class="fas fa-eye-slash"></i> 1</div>
                        </div>
                        <span class="text-[9px] mt-1 px-1" style="color: var(--color-text-secondary)">${getTime()}</span>
                    </div>`;
            }
            
            chatBox.appendChild(div);
            scrollToBottom();
            
            messageHistory.push({ id: msgId, type: 'viewonce', viewOnceId, sender, time: getTime(), dir });
        }
        
        let viewOnceTimer = null;
        let screenshotDetectionActive = false;
        
        function openViewOnce(viewOnceId) {
            const media = viewOnceMedia[viewOnceId];
            if (!media || media.viewed) {
                showToast("This media has already been viewed", "error");
                return;
            }
            
            // Mark as viewed
            media.viewed = true;
            
            // Update UI to show it's been opened
            const overlay = document.getElementById(`vo-overlay-${viewOnceId}`);
            if (overlay) {
                overlay.innerHTML = `
                    <div class="view-once-icon" style="background: rgba(255,255,255,0.1)">
                        <i class="fas fa-check text-white/50 text-xl"></i>
                    </div>
                    <span class="text-white/50 text-sm font-medium">Opened</span>`;
                overlay.style.background = 'rgba(0,0,0,0.7)';
                overlay.style.cursor = 'default';
                overlay.onclick = null;
            }
            
            // Show the modal
            const modal = document.getElementById('view-once-modal');
            const img = document.getElementById('view-once-image');
            const vid = document.getElementById('view-once-video');
            
            if (media.type === 'image') {
                img.src = media.url;
                img.classList.remove('hidden');
                vid.classList.add('hidden');
            } else {
                vid.src = media.url;
                vid.classList.remove('hidden');
                img.classList.add('hidden');
            }
            
            modal.classList.remove('hidden');
            
            // Enable screenshot protection
            enableScreenshotProtection();
            
            // Start countdown timer
            let countdown = media.type === 'video' ? 30 : 5;
            document.getElementById('view-once-timer').innerText = countdown;
            
            viewOnceTimer = setInterval(() => {
                countdown--;
                document.getElementById('view-once-timer').innerText = countdown;
                if (countdown <= 0) {
                    closeViewOnceModal();
                }
            }, 1000);
        }
        
        // Screenshot protection functions
        function enableScreenshotProtection() {
            screenshotDetectionActive = true;
            
            // Detect PrintScreen key
            document.addEventListener('keyup', handleScreenshotKey);
            document.addEventListener('keydown', handleScreenshotKeyDown);
            
            // Detect visibility change (possible screen recording)
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // Blur detection for screen capture tools
            window.addEventListener('blur', handleWindowBlur);
        }
        
        function disableScreenshotProtection() {
            screenshotDetectionActive = false;
            document.removeEventListener('keyup', handleScreenshotKey);
            document.removeEventListener('keydown', handleScreenshotKeyDown);
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            window.removeEventListener('blur', handleWindowBlur);
        }
        
        function handleScreenshotKey(e) {
            if (!screenshotDetectionActive) return;
            // Detect PrintScreen key
            if (e.key === 'PrintScreen' || e.keyCode === 44) {
                closeViewOnceModal();
                showToast('‚ö†Ô∏è Screenshot detected! Media closed for privacy.', 'warning');
            }
        }
        
        function handleScreenshotKeyDown(e) {
            if (!screenshotDetectionActive) return;
            // Block common screenshot shortcuts
            // Windows: Win+Shift+S, PrintScreen
            // Mac: Cmd+Shift+3, Cmd+Shift+4
            if (e.key === 'PrintScreen' || 
                (e.metaKey && e.shiftKey && (e.key === '3' || e.key === '4' || e.key === 's')) ||
                (e.ctrlKey && e.key === 'PrintScreen')) {
                e.preventDefault();
                closeViewOnceModal();
                showToast('‚ö†Ô∏è Screenshot attempt blocked!', 'warning');
                return false;
            }
        }
        
        function handleVisibilityChange() {
            if (!screenshotDetectionActive) return;
            if (document.hidden) {
                // Tab became hidden - possible screen capture
                closeViewOnceModal();
                showToast('‚ö†Ô∏è Media closed for privacy protection.', 'warning');
            }
        }
        
        function handleWindowBlur() {
            if (!screenshotDetectionActive) return;
            // Window lost focus - possible external capture tool
            setTimeout(() => {
                if (screenshotDetectionActive && !document.hasFocus()) {
                    closeViewOnceModal();
                    showToast('‚ö†Ô∏è Media closed - window lost focus.', 'warning');
                }
            }, 100);
        }
        
        function closeViewOnceModal() {
            if (viewOnceTimer) {
                clearInterval(viewOnceTimer);
                viewOnceTimer = null;
            }
            
            // Disable screenshot protection
            disableScreenshotProtection();
            
            const modal = document.getElementById('view-once-modal');
            const img = document.getElementById('view-once-image');
            const vid = document.getElementById('view-once-video');
            
            // Stop and clear media immediately
            vid.pause();
            vid.src = '';
            img.src = '';
            
            // Clear any URL objects
            URL.revokeObjectURL(vid.src);
            URL.revokeObjectURL(img.src);
            
            modal.classList.add('hidden');
        }
        
        async function sendChunkedFile(file, previewType) {
            const fileId = `file-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            const totalChunks = Math.ceil(file.size / MAX_CHUNK_SIZE);
            
            // Show progress in chat
            appendFileTransferProgress(fileId, file.name, file.size, 'out', 'Me');
            
            // Send file start notification
            const startPayload = {
                type: 'file-start',
                fileId: fileId,
                filename: file.name,
                filetype: file.type,
                filesize: file.size,
                totalChunks: totalChunks,
                previewType: previewType,
                sender: myName
            };
            if(isHost || myMode === 'direct') broadcastData(startPayload); 
            else if(hostConn) hostConn.send(startPayload);
            
            // Send chunks
            for (let i = 0; i < totalChunks; i++) {
                const start = i * MAX_CHUNK_SIZE;
                const end = Math.min(start + MAX_CHUNK_SIZE, file.size);
                const chunk = file.slice(start, end);
                const arrayBuffer = await chunk.arrayBuffer();
                
                const chunkPayload = {
                    type: 'file-chunk',
                    fileId: fileId,
                    chunkIndex: i,
                    data: arrayBuffer,
                    sender: myName
                };
                
                if(isHost || myMode === 'direct') broadcastData(chunkPayload); 
                else if(hostConn) hostConn.send(chunkPayload);
                
                // Update progress
                const progress = Math.round(((i + 1) / totalChunks) * 100);
                updateFileTransferProgress(fileId, progress);
                
                // Small delay to prevent overwhelming
                await new Promise(r => setTimeout(r, 10));
            }
            
            // Send file end notification
            const endPayload = {
                type: 'file-end',
                fileId: fileId,
                sender: myName
            };
            if(isHost || myMode === 'direct') broadcastData(endPayload); 
            else if(hostConn) hostConn.send(endPayload);
            
            // Complete local progress
            completeFileTransfer(fileId, URL.createObjectURL(file), file.name, file.size, file.type, previewType);
        }
        
        function handleFileStart(data) {
            fileTransfers[data.fileId] = {
                filename: data.filename,
                filetype: data.filetype,
                filesize: data.filesize,
                totalChunks: data.totalChunks,
                previewType: data.previewType,
                sender: data.sender,
                chunks: [],
                receivedChunks: 0
            };
            
            // Show progress
            appendFileTransferProgress(data.fileId, data.filename, data.filesize, 'in', data.sender);
        }
        
        function handleFileChunk(data) {
            const transfer = fileTransfers[data.fileId];
            if (!transfer) return;
            
            transfer.chunks[data.chunkIndex] = data.data;
            transfer.receivedChunks++;
            
            // Update progress
            const progress = Math.round((transfer.receivedChunks / transfer.totalChunks) * 100);
            updateFileTransferProgress(data.fileId, progress);
        }
        
        function handleFileEnd(data) {
            const transfer = fileTransfers[data.fileId];
            if (!transfer) return;
            
            // Combine chunks into final file
            const blob = new Blob(transfer.chunks, { type: transfer.filetype });
            const url = URL.createObjectURL(blob);
            
            // Complete transfer
            completeFileTransfer(data.fileId, url, transfer.filename, transfer.filesize, transfer.filetype, transfer.previewType, 'in', transfer.sender);
            
            // Clean up
            delete fileTransfers[data.fileId];
        }
        
        function appendFileTransferProgress(fileId, filename, filesize, dir, sender) {
            const chatBox = document.getElementById('chat-box'); 
            if(chatBox.querySelector('h3')) chatBox.innerHTML = ''; 
            
            const div = document.createElement('div');
            div.id = `transfer-${fileId}`;
            div.className = `flex w-full ${dir === 'out' ? 'justify-end' : 'justify-start'} animate-fade-in`;
            
            const bgStyle = dir === 'out' ? 'background: var(--color-outgoing);' : 'background: var(--color-incoming);';
            
            div.innerHTML = `
                <div class="max-w-[85%] flex flex-col ${dir === 'out' ? 'items-end' : 'items-start'}">
                    <span class="text-[9px] mb-1 px-1" style="color: var(--color-text-secondary)">${sender}</span>
                    <div class="file-transfer-progress w-64" style="${bgStyle}">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0" style="background: rgba(255,255,255,0.15)">
                                <i class="fas fa-file-upload text-white animate-pulse"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-sm truncate text-white">${filename}</h4>
                                <p class="text-[10px] text-white/70">${formatBytes(filesize)}</p>
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progress-${fileId}" style="width: 0%"></div>
                        </div>
                        <p class="text-[10px] text-center text-white/80" id="progress-text-${fileId}">0%</p>
                    </div>
                </div>`;
            
            chatBox.appendChild(div);
            scrollToBottom();
        }
        
        function updateFileTransferProgress(fileId, progress) {
            const progressBar = document.getElementById(`progress-${fileId}`);
            const progressText = document.getElementById(`progress-text-${fileId}`);
            if (progressBar) progressBar.style.width = `${progress}%`;
            if (progressText) progressText.innerText = `${progress}%`;
        }
        
        function completeFileTransfer(fileId, url, filename, filesize, filetype, previewType, dir = 'out', sender = 'Me') {
            // Remove progress element
            const progressEl = document.getElementById(`transfer-${fileId}`);
            if (progressEl) progressEl.remove();
            
            // Add final file message
            if (previewType === 'image') appendImageMessage(url, dir, sender, filename); 
            else if (previewType === 'video') appendVideoMessage(url, dir, sender, filename); 
            else appendFileMessage(filename, filesize, dir, url, filetype, sender);
            
            showToast("File transfer complete!", "success");
        }
        
        function handleIncomingFile(data) {
            // Safer Blob construction
            let blobData = data.file;
            // PeerJS sometimes sends file as ArrayBuffer or Uint8Array
            const blob = new Blob([blobData], {type: data.filetype});
            const url = URL.createObjectURL(blob);
            if (data.previewType === 'image') appendImageMessage(url, 'in', data.sender, data.filename);
            else if (data.previewType === 'video') appendVideoMessage(url, 'in', data.sender, data.filename, data.msgId);
            else if (data.previewType === 'voice') appendVoiceMessage(url, 'in', data.sender, data.msgId);
            else appendFileMessage(data.filename, data.filesize, 'in', url, data.filetype, data.sender);
        }

        // --- UI Helper ---
        function updateUIForMode(mode) {
            const title = document.getElementById('header-title');
            const mediaControls = document.getElementById('media-controls');
            mediaControls.classList.add('hidden'); 
            setVideoLayout(false); 
            updateMediaIcons(false, false, false);
            document.getElementById('local-video-card').classList.add('hidden');
            document.getElementById('btn-stats').classList.add('hidden');
            document.getElementById('btn-participants').classList.add('hidden');
            
            if (mode.includes('room')) { 
                title.innerText = isHost ? "üìπ My Room (Host)" : "üìπ Video Room"; 
                mediaControls.classList.remove('hidden'); 
                setVideoLayout(true);
                document.getElementById('btn-participants').classList.remove('hidden');
            } else if (mode.includes('group')) { 
                title.innerText = isHost ? "üí¨ My Group (Admin)" : "üí¨ Group Chat";
                document.getElementById('btn-participants').classList.remove('hidden');
            } else if (mode === 'direct') { 
                title.innerText = connectedPeerName ? "ü§ù " + connectedPeerName : "ü§ù Direct Chat"; 
                mediaControls.classList.remove('hidden'); 
            } else if (mode === 'global') {
                // UChat All - Global Room (NO video/voice/screen share)
                title.innerText = "üåç UChat All";
                mediaControls.classList.add('hidden'); // No media controls
                document.getElementById('btn-participants').classList.remove('hidden');
            }
            updateConnectionStatus();
        }
        
        function updateConnectionStatus() {
            let count = 0;
            if(myMode === 'direct') count = connections.length > 0 ? 1 : 0;
            else if(myMode === 'global') count = Object.keys(globalRoomUsers).length;
            else if(isHost) count = connections.length;
            else count = (hostConn && hostConn.open) ? 1 : 0; 
            
            document.getElementById('peer-count').innerText = myMode === 'global' ? count : count + (isHost || myMode === 'direct' ? 1 : 1);
            
            const dot = document.getElementById('header-status-dot'); 
            const txt = document.getElementById('header-status-text');
            const modeDisplay = document.getElementById('connection-mode-display');
            
            if (myMode !== 'idle') { 
                dot.className = "w-2 h-2 rounded-full bg-green-500";
                dot.style.boxShadow = "0 0 8px #22c55e";
                txt.innerText = "Online"; 
                document.getElementById('status-card').classList.remove('hidden'); 
                
                // Update mode display
                if (myMode.includes('room')) modeDisplay.innerText = isHost ? 'Video Room Host' : 'In Video Room';
                else if (myMode.includes('group')) modeDisplay.innerText = isHost ? 'Group Admin' : 'In Group';
                else if (myMode === 'direct') modeDisplay.innerText = 'Direct Connected';
                else if (myMode === 'global') modeDisplay.innerText = 'UChat All - Global';
            } else { 
                dot.className = "w-2 h-2 rounded-full bg-red-500 animate-pulse";
                dot.style.boxShadow = "none";
                txt.innerText = "Disconnected"; 
                document.getElementById('status-card').classList.add('hidden'); 
            }
        }
        
        function resetSession() {
            connections.forEach(c => c.close()); connections = []; 
            if(hostConn) hostConn.close(); hostConn = null;
            calls.forEach(c => c.close()); calls = [];
            if(localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
            if(statsInterval) clearInterval(statsInterval);
            localCamTrack = null; isScreenSharing = false;
            
            // Clear participants
            participants = {};
            fileTransfers = {};
            
            document.getElementById('video-grid').innerHTML = `
                <div class="video-card hidden" id="local-video-card">
                    <video id="local-video" autoplay muted playsinline></video>
                    <div class="video-overlay"></div>
                    <div class="stream-badge">
                        <div class="online-dot"></div>
                        <span>LIVE</span>
                    </div>
                    <div class="stream-quality-badge" id="local-quality-badge">HD</div>
                    <div class="absolute bottom-2 left-2 bg-black/70 px-3 py-1.5 rounded-lg text-[11px] text-white flex items-center gap-2 backdrop-blur-sm">
                        <i class="fas fa-user"></i> <span id="local-video-name">${myName}</span>
                        <div id="local-mic-indicator" class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    </div>
                </div>`;
            
            document.getElementById('chat-box').innerHTML = `
                <div class="flex flex-col items-center justify-center h-[80%] select-none px-6 text-center" style="color: var(--color-text-secondary); opacity: 0.5">
                    <div class="w-20 h-20 rounded-full flex items-center justify-center mb-4" style="background: var(--color-surface)">
                        <i class="fas fa-paper-plane text-3xl" style="color: var(--color-primary)"></i>
                    </div>
                    <h3 class="text-lg font-bold mb-1" style="color: var(--color-text-primary)">Ready to Connect</h3>
                    <p class="text-xs max-w-xs">Select a friend, enter an ID, or create a room to start chatting.</p>
                </div>`;
            
            setVideoLayout(false); 
            document.getElementById('media-controls').classList.add('hidden');
            document.getElementById('btn-stats').classList.add('hidden');
            document.getElementById('btn-participants').classList.add('hidden');
            document.getElementById('btn-join').innerHTML = '<i class="fas fa-sign-in-alt"></i><span class="text-[10px]">JOIN HOST</span>'; 
            document.getElementById('btn-direct').innerHTML = '<i class="fas fa-comment-dots"></i><span class="text-[10px]">CHAT ONLY</span>';
            document.getElementById('btn-voice-call').innerHTML = '<i class="fas fa-phone-alt"></i><span class="text-[10px]">VOICE CALL</span>';
            document.getElementById('btn-video-call').innerHTML = '<i class="fas fa-video"></i><span class="text-[10px]">VIDEO CALL</span>';
            isHost = false; myMode = 'idle'; connectedPeerName = null;
            isInGlobalRoom = false; globalRoomUsers = {};
            document.getElementById('header-title').innerText = "UChat"; 
            
            // Reset global room button
            document.getElementById('btn-global-room').innerHTML = '<i class="fas fa-door-open mr-2"></i>Join UChat All';
            document.getElementById('btn-global-room').style.background = 'linear-gradient(135deg, #6366f1, #a855f7)';
            document.getElementById('global-online-badge').classList.add('hidden');
            
            updateConnectionStatus();
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // --- Message UI Functions ---
        async function appendMessage(text, dir, sender, replyTo = null, msgId = null) { 
            const chatBox = document.getElementById('chat-box'); 
            if(chatBox.querySelector('h3')) chatBox.innerHTML = ''; 
            
            const id = msgId || `msg-${++messageIdCounter}`;
            const div = document.createElement('div'); 
            div.id = id;
            div.dataset.msgId = id;
            div.className = `flex w-full ${dir === 'out' ? 'justify-end' : 'justify-start'} animate-fade-in`;
            
            const bgStyle = dir === 'out' 
                ? 'background: var(--color-outgoing); color: white; border-bottom-right-radius: 4px;' 
                : 'background: var(--color-incoming); color: var(--color-text-primary); border-bottom-left-radius: 4px;';
            
            // Check for URLs in text
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const urls = text.match(urlRegex);
            let linkPreviewHtml = '';
            
            if (urls && urls.length > 0) {
                // Get preview for first URL
                const preview = await fetchLinkPreview(urls[0]);
                if (preview) {
                    linkPreviewHtml = createLinkPreview(urls[0], preview);
                }
            }
            
            // Reply preview HTML
            let replyHtml = '';
            if (replyTo) {
                replyHtml = `
                    <div class="reply-preview mb-1 cursor-pointer" onclick="scrollToMessage('${replyTo.id}')" style="max-width: 200px">
                        <p class="text-[10px] font-bold" style="color: var(--color-primary)">${replyTo.sender}</p>
                        <p class="reply-preview-text">${replyTo.text.substring(0, 40)}${replyTo.text.length > 40 ? '...' : ''}</p>
                    </div>`;
            }
            
            // Read receipt for outgoing messages
            const readReceiptHtml = dir === 'out' ? '<span class="read-receipt sent"><i class="fas fa-check"></i></span>' : '';
            
            div.innerHTML = `
                <div class="max-w-[80%] md:max-w-[70%] flex flex-col ${dir === 'out' ? 'items-end' : 'items-start'}">
                    <span class="text-[9px] mb-1 px-1" style="color: var(--color-text-secondary)">${sender}</span>
                    ${replyHtml}
                    <div class="px-4 py-2.5 rounded-2xl shadow-sm chat-bubble text-[15px] break-words relative" style="${bgStyle}">
                        ${linkify(text)}${readReceiptHtml}
                        <div class="message-reactions"></div>
                    </div>
                    ${linkPreviewHtml}
                    <span class="text-[9px] mt-1 px-1" style="color: var(--color-text-secondary)">${getTime()}</span>
                </div>`; 
            chatBox.appendChild(div); 
            scrollToBottom();
            
            // Store in message history for search
            messageHistory.push({ id, content: text, sender, time: getTime(), dir, replyTo, reactions: {} });
            
            // Send notification for incoming messages
            if (dir === 'in') {
                sendNotification(`${sender}`, text.substring(0, 100), 'üí¨');
                unreadCount++;
                updateUnreadBadge();
            }
        }
        
        function appendImageMessage(url, dir, sender, filename) { 
            const chatBox = document.getElementById('chat-box'); 
            if(chatBox.querySelector('h3')) chatBox.innerHTML = ''; 
            
            const msgId = `msg-${++messageIdCounter}`;
            const div = document.createElement('div'); 
            div.id = msgId;
            div.dataset.msgId = msgId;
            div.className = `flex w-full ${dir === 'out' ? 'justify-end' : 'justify-start'} animate-fade-in`; 
            div.innerHTML = `
                <div class="max-w-[70%] flex flex-col ${dir === 'out' ? 'items-end' : 'items-start'}">
                    <span class="text-[9px] mb-1 px-1" style="color: var(--color-text-secondary)">${sender}</span>
                    <div class="p-1 rounded-2xl shadow-md cursor-pointer hover:opacity-90 transition chat-bubble" style="background: var(--color-surface); border: 1px solid var(--color-border)" onclick="openMediaModal('${url}', 'image', '${filename}')">
                        <img src="${url}" class="rounded-xl w-full h-auto max-h-64 object-cover bg-black">
                    </div>
                    <span class="text-[9px] mt-1 px-1" style="color: var(--color-text-secondary)">${getTime()}</span>
                </div>`; 
            chatBox.appendChild(div); 
            scrollToBottom();
            
            messageHistory.push({ id: msgId, type: 'image', url, sender, time: getTime() });
            if (dir === 'in') sendNotification(`${sender}`, 'üì∑ Sent an image', 'üì∑');
        }
        
        function appendVideoMessage(url, dir, sender, filename, msgId = null) { 
            const chatBox = document.getElementById('chat-box'); 
            if(chatBox.querySelector('h3')) chatBox.innerHTML = ''; 
            
            const id = msgId || `msg-${++messageIdCounter}`;
            const div = document.createElement('div'); 
            div.id = id;
            div.dataset.msgId = id;
            div.className = `flex w-full ${dir === 'out' ? 'justify-end' : 'justify-start'} animate-fade-in`; 
            div.innerHTML = `
                <div class="max-w-[70%] flex flex-col ${dir === 'out' ? 'items-end' : 'items-start'}">
                    <span class="text-[9px] mb-1 px-1" style="color: var(--color-text-secondary)">${sender}</span>
                    <div class="p-1 rounded-2xl shadow-md relative cursor-pointer hover:opacity-90 transition chat-bubble" style="background: var(--color-surface); border: 1px solid var(--color-border)" onclick="openMediaModal('${url}', 'video', '${filename}')">
                        <video src="${url}" class="rounded-xl w-full h-auto max-h-64 object-cover bg-black"></video>
                        <div class="play-overlay"><i class="fas fa-play text-white text-xl ml-1"></i></div>
                    </div>
                    <span class="text-[9px] mt-1 px-1" style="color: var(--color-text-secondary)">${getTime()}</span>
                </div>`; 
            chatBox.appendChild(div); 
            scrollToBottom();
            
            // Store in message history for delete-for-everyone
            messageHistory.push({ id, type: 'video', url, sender, time: getTime(), dir });
        }
        
        function appendVoiceMessage(url, dir, sender, msgId = null) { 
            const chatBox = document.getElementById('chat-box'); 
            if(chatBox.querySelector('h3')) chatBox.innerHTML = ''; 
            
            const id = msgId || `msg-${++messageIdCounter}`;
            const div = document.createElement('div'); 
            div.id = id;
            div.dataset.msgId = id;
            div.className = `flex w-full ${dir === 'out' ? 'justify-end' : 'justify-start'} animate-fade-in`; 
            const bgStyle = dir === 'out' ? 'background: var(--color-outgoing);' : 'background: var(--color-incoming);';
            div.innerHTML = `
                <div class="max-w-[85%] flex flex-col ${dir === 'out' ? 'items-end' : 'items-start'}">
                    <span class="text-[9px] mb-1 px-1" style="color: var(--color-text-secondary)">${sender}</span>
                    <div class="p-2.5 rounded-2xl shadow-sm chat-bubble flex items-center gap-3" style="${bgStyle}">
                        <div class="w-9 h-9 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255,255,255,0.15)">
                            <i class="fas fa-microphone text-white"></i>
                        </div>
                        <audio controls src="${url}"></audio>
                    </div>
                    <span class="text-[9px] mt-1 px-1" style="color: var(--color-text-secondary)">${getTime()}</span>
                </div>`; 
            chatBox.appendChild(div); 
            scrollToBottom();
            
            // Store in message history for delete-for-everyone
            messageHistory.push({ id, type: 'voice', url, sender, time: getTime(), dir });
        }
        
        function appendFileMessage(name, size, dir, url, type, sender) { 
            const chatBox = document.getElementById('chat-box'); 
            if(chatBox.querySelector('h3')) chatBox.innerHTML = ''; 
            const div = document.createElement('div'); 
            div.className = `flex w-full ${dir === 'out' ? 'justify-end' : 'justify-start'} animate-fade-in`; 
            const bgStyle = dir === 'out' ? 'background: var(--color-outgoing);' : 'background: var(--color-incoming);';
            div.innerHTML = `
                <div class="max-w-[85%] flex flex-col ${dir === 'out' ? 'items-end' : 'items-start'}">
                    <span class="text-[9px] mb-1 px-1" style="color: var(--color-text-secondary)">${sender}</span>
                    <div class="p-3 rounded-2xl shadow-md flex items-center gap-3 cursor-pointer hover:opacity-90 transition" style="${bgStyle}; border: 1px solid var(--color-border)" onclick="directDownload('${url}', '${name}')">
                        <div class="w-11 h-11 rounded-xl flex items-center justify-center flex-shrink-0" style="background: rgba(255,255,255,0.15)">
                            <i class="fas fa-file-alt text-white text-lg"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-sm truncate text-white">${name}</h4>
                            <p class="text-[10px] text-white/70">${formatBytes(size)}</p>
                        </div>
                        ${dir === 'in' ? `<div class="w-9 h-9 rounded-full flex items-center justify-center" style="background: rgba(255,255,255,0.2)"><i class="fas fa-arrow-down text-white text-sm"></i></div>` : ''}
                    </div>
                    <span class="text-[9px] mt-1 px-1" style="color: var(--color-text-secondary)">${getTime()}</span>
                </div>`; 
            chatBox.appendChild(div); 
            scrollToBottom(); 
        }
        
        function toggleSidebar() { 
            const sb = document.getElementById('sidebar'); 
            const bd = document.getElementById('sidebar-backdrop'); 
            if(sb.classList.contains('-translate-x-full')) { 
                sb.classList.remove('-translate-x-full'); 
                bd.classList.remove('hidden'); 
            } else { 
                sb.classList.add('-translate-x-full'); 
                bd.classList.add('hidden'); 
            } 
        }
        
        function toggleAttachmentMenu() { 
            const menu = document.getElementById('attachment-menu'); 
            const overlay = document.getElementById('attachment-overlay'); 
            const icon = document.getElementById('plus-icon'); 
            if(menu.classList.contains('hidden')) { 
                menu.classList.remove('hidden'); 
                overlay.classList.remove('hidden'); 
                icon.classList.add('rotate-45'); 
            } else { 
                menu.classList.add('hidden'); 
                overlay.classList.add('hidden'); 
                icon.classList.remove('rotate-45'); 
            } 
        }
        
        function openMediaModal(url, type, filename) { 
            const modal = document.getElementById('media-modal'); 
            const img = document.getElementById('modal-image'); 
            const vid = document.getElementById('modal-video'); 
            const dlBtn = document.getElementById('modal-download'); 
            if(type === 'image') { 
                img.src = url; 
                img.classList.remove('hidden'); 
                vid.src = ""; 
                vid.classList.add('hidden'); 
            } else { 
                vid.src = url; 
                vid.classList.remove('hidden'); 
                img.src = ""; 
                img.classList.add('hidden'); 
                vid.play().catch(e => console.log('Autoplay blocked')); 
            } 
            dlBtn.href = url; 
            dlBtn.download = filename || 'download'; 
            modal.classList.remove('hidden'); 
        }
        
        function closeMediaModal() { 
            const video = document.getElementById('modal-video');
            const modal = document.getElementById('media-modal');
            if (video) video.pause(); 
            if (modal) modal.classList.add('hidden'); 
        }
        
        function directDownload(url, filename) { 
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = filename; 
            document.body.appendChild(a); 
            a.click(); 
            document.body.removeChild(a); 
            showToast("Download started", "success");
        }
        
        function autoResize(el) { 
            el.style.height = 'auto'; 
            el.style.height = Math.min(el.scrollHeight, 120) + 'px'; 
        }
        
        function scrollToBottom() { 
            const b = document.getElementById('chat-box'); 
            b.scrollTo({ top: b.scrollHeight, behavior: 'smooth' }); 
        }
        
        function getTime() { 
            return new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); 
        }
        
        function linkify(t) { 
            // Convert URLs to clickable links
            return t.replace(/(https?:\/\/[^\s]+)/g, url => 
                `<a href="${url}" target="_blank" class="underline hover:opacity-80 transition" style="color: #93c5fd">${url}</a>`
            ); 
        }
        
        // === PRIVACY & GLOBAL ROOM FUNCTIONS ===
        function togglePrivacy() {
            isPublicAccount = document.getElementById('privacy-toggle')?.checked || false;
            localStorage.setItem('uchat_public', isPublicAccount);
            updatePrivacyUI();
            updateSettingsModalUI();
            showToast(isPublicAccount ? "Account is now Public" : "Account is now Private", "success");
        }
        
        function updatePrivacyUI() {
            const badge = document.getElementById('privacy-badge');
            const uchatAllSection = document.getElementById('uchat-all-section');
            const accountTypeInfo = document.getElementById('account-type-info');
            
            if (isPublicAccount) {
                // Update badge
                if (badge) {
                    badge.style.background = 'rgba(34, 197, 94, 0.2)';
                    badge.style.color = '#22c55e';
                    badge.innerText = 'PUBLIC';
                }
                
                // Show UChat All section
                if (uchatAllSection) {
                    uchatAllSection.classList.remove('hidden');
                }
                
                // Update account info in settings modal
                if (accountTypeInfo) {
                    accountTypeInfo.style.background = 'rgba(34, 197, 94, 0.1)';
                    accountTypeInfo.style.color = '#86efac';
                    accountTypeInfo.innerHTML = '<i class="fas fa-globe mr-1"></i> Public: Can join UChat All & visible to others';
                }
            } else {
                // Update badge
                if (badge) {
                    badge.style.background = 'rgba(239, 68, 68, 0.2)';
                    badge.style.color = '#ef4444';
                    badge.innerText = 'PRIVATE';
                }
                
                // Hide UChat All section
                if (uchatAllSection) {
                    uchatAllSection.classList.add('hidden');
                }
                
                // Update account info in settings modal
                if (accountTypeInfo) {
                    accountTypeInfo.style.background = 'rgba(239, 68, 68, 0.1)';
                    accountTypeInfo.style.color = '#fca5a5';
                    accountTypeInfo.innerHTML = '<i class="fas fa-lock mr-1"></i> Private: Only direct connections with ID sharing';
                }
            }
        }
        
        // === SETTINGS MODAL FUNCTIONS ===
        function openSettingsModal() {
            const modal = document.getElementById('settings-modal');
            modal.classList.remove('hidden');
            updateSettingsModalUI();
        }
        
        function closeSettingsModal() {
            const modal = document.getElementById('settings-modal');
            modal.classList.add('hidden');
        }
        
        function updateSettingsModalUI() {
            // Update all toggles to match current settings
            const publicToggle = document.getElementById('settings-public-toggle');
            if (publicToggle) publicToggle.checked = isPublicAccount;
            
            const blockUnknown = document.getElementById('setting-block-unknown');
            if (blockUnknown) blockUnknown.checked = privacySettings.blockUnknown;
            
            const requireApproval = document.getElementById('setting-require-approval');
            if (requireApproval) requireApproval.checked = privacySettings.requireApproval;
            
            const hideOnline = document.getElementById('setting-hide-online');
            if (hideOnline) hideOnline.checked = privacySettings.hideOnlineStatus;
            
            const hideLastSeen = document.getElementById('setting-hide-lastseen');
            if (hideLastSeen) hideLastSeen.checked = privacySettings.hideLastSeen;
            
            const noRead = document.getElementById('setting-no-read');
            if (noRead) noRead.checked = privacySettings.disableReadReceipts;
            
            const noTyping = document.getElementById('setting-no-typing');
            if (noTyping) noTyping.checked = privacySettings.disableTypingIndicator;
            
            const blockSS = document.getElementById('setting-block-ss');
            if (blockSS) blockSS.checked = privacySettings.blockScreenshots;
            
            const autoDelete = document.getElementById('setting-auto-delete');
            if (autoDelete) autoDelete.value = privacySettings.autoDeleteMessages;
        }
        
        function toggleSettingPublic() {
            isPublicAccount = document.getElementById('settings-public-toggle').checked;
            localStorage.setItem('uchat_public', isPublicAccount);
            updatePrivacyUI();
            showToast(isPublicAccount ? "Account is now Public" : "Account is now Private", "success");
        }
        
        function updatePrivacySetting(setting, value) {
            privacySettings[setting] = value;
            
            // Save to localStorage
            const storageKeys = {
                blockUnknown: 'uchat_block_unknown',
                hideOnlineStatus: 'uchat_hide_online',
                disableReadReceipts: 'uchat_no_read',
                disableTypingIndicator: 'uchat_no_typing',
                autoDeleteMessages: 'uchat_auto_delete',
                blockScreenshots: 'uchat_block_ss',
                requireApproval: 'uchat_require_approval',
                hideLastSeen: 'uchat_hide_lastseen'
            };
            
            if (storageKeys[setting]) {
                localStorage.setItem(storageKeys[setting], value.toString());
            }
            
            // Show feedback
            const settingNames = {
                blockUnknown: 'Block Unknown Connections',
                hideOnlineStatus: 'Hide Online Status',
                disableReadReceipts: 'Read Receipts',
                disableTypingIndicator: 'Typing Indicator',
                autoDeleteMessages: 'Auto-Delete',
                blockScreenshots: 'Screenshot Protection',
                requireApproval: 'Connection Approval',
                hideLastSeen: 'Last Seen'
            };
            
            if (setting === 'autoDeleteMessages') {
                showToast(`Auto-delete: ${value === 'never' ? 'Off' : value}`, 'success');
            } else {
                showToast(`${settingNames[setting]}: ${value ? 'Enabled' : 'Disabled'}`, 'success');
            }
        }
        
        function resetPrivacySettings() {
            showCustomConfirm("Reset Privacy Settings?", "All privacy settings will be restored to defaults.", () => {
                // Reset to defaults
                isPublicAccount = false;
                privacySettings = {
                    blockUnknown: false,
                    hideOnlineStatus: false,
                    disableReadReceipts: false,
                    disableTypingIndicator: false,
                    autoDeleteMessages: 'never',
                    blockScreenshots: false,
                    requireApproval: true,
                    hideLastSeen: false
                };
                
                // Clear localStorage
                localStorage.setItem('uchat_public', 'false');
                localStorage.removeItem('uchat_block_unknown');
                localStorage.removeItem('uchat_hide_online');
                localStorage.removeItem('uchat_no_read');
                localStorage.removeItem('uchat_no_typing');
                localStorage.removeItem('uchat_auto_delete');
                localStorage.removeItem('uchat_block_ss');
                localStorage.setItem('uchat_require_approval', 'true');
                localStorage.removeItem('uchat_hide_lastseen');
                
                // Update UI
                updatePrivacyUI();
                updateSettingsModalUI();
                
                showToast("Privacy settings reset to defaults", "success");
            });
        }
        
        // UChat All - Global Room Functions
        function joinGlobalRoom() {
            if (isInGlobalRoom) {
                leaveGlobalRoom();
                return;
            }
            
            // Block private accounts from joining UChat All
            if (!isPublicAccount) {
                showCustomAlert(
                    "üîí Private Account",
                    "Private accounts cannot join UChat All. Please switch to a Public account in Privacy Settings to access the global chat room."
                );
                return;
            }
            
            if (connections.length > 0 || hostConn) {
                showCustomConfirm("Join UChat All?", "Current session will be closed to join the global room.", () => {
                    resetSession();
                    initGlobalRoom();
                });
                return;
            }
            
            initGlobalRoom();
        }
        
        function initGlobalRoom() {
            isInGlobalRoom = true;
            myMode = 'global';
            globalRoomUsers = {};
            
            // Add self to global users
            globalRoomUsers[peer.id] = { name: myName, joinTime: Date.now() };
            
            // Update UI
            updateUIForMode('global');
            document.getElementById('btn-global-room').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Connecting...';
            
            // Try to connect to existing global room users or become coordinator
            tryConnectToGlobalRoom();
        }
        
        function tryConnectToGlobalRoom() {
            // Use a simple broadcast mechanism - try to find other users
            // In a real implementation, you'd use a signaling server
            // For now, we simulate with local peer discovery
            
            showToast("üåç Welcome to UChat All!", "success");
            document.getElementById('btn-global-room').innerHTML = '<i class="fas fa-sign-out-alt mr-2"></i>Leave UChat All';
            document.getElementById('btn-global-room').style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
            
            updateGlobalRoomUI();
            
            // Listen for incoming global room connections
            // The peer 'connection' event already handles this
        }
        
        function leaveGlobalRoom() {
            if (!isInGlobalRoom) return;
            
            // Notify other users
            const payload = { type: 'global-leave', peerId: peer.id, name: myName };
            broadcastToGlobalRoom(payload);
            
            // Disconnect from all global room connections
            connections.forEach(conn => {
                if (conn.open) conn.close();
            });
            connections = [];
            
            isInGlobalRoom = false;
            globalRoomUsers = {};
            
            resetSession();
            
            // Reset button
            document.getElementById('btn-global-room').innerHTML = '<i class="fas fa-door-open mr-2"></i>Join UChat All';
            document.getElementById('btn-global-room').style.background = 'linear-gradient(135deg, #6366f1, #a855f7)';
            document.getElementById('global-online-badge').classList.add('hidden');
            
            showToast("Left UChat All", "info");
        }
        
        function broadcastToGlobalRoom(data) {
            connections.forEach(conn => {
                if (conn.open && conn.metadata?.isGlobalRoom) {
                    conn.send(data);
                }
            });
        }
        
        function handleGlobalRoomMessage(data, conn) {
            switch(data.type) {
                case 'global-join':
                    // New user joined
                    globalRoomUsers[data.peerId] = { name: data.name, joinTime: Date.now() };
                    updateGlobalRoomUI();
                    appendSystemMessage(`üåç ${data.name} joined UChat All`);
                    
                    // Send current user list to new user
                    conn.send({ type: 'global-users', users: globalRoomUsers });
                    break;
                    
                case 'global-leave':
                    // User left
                    if (globalRoomUsers[data.peerId]) {
                        appendSystemMessage(`üëã ${data.name} left UChat All`);
                        delete globalRoomUsers[data.peerId];
                        updateGlobalRoomUI();
                    }
                    break;
                    
                case 'global-users':
                    // Received user list
                    Object.assign(globalRoomUsers, data.users);
                    updateGlobalRoomUI();
                    break;
                    
                case 'global-text':
                    // Chat message
                    appendMessage(data.content, 'in', data.sender, data.replyTo, data.msgId);
                    if (data.msgId) sendReadReceipt(data.msgId);
                    break;
            }
        }
        
        function updateGlobalRoomUI() {
            const onlineCount = Object.keys(globalRoomUsers).length;
            const onlineBadge = document.getElementById('global-online-badge');
            const countSpan = document.getElementById('global-online-count');
            
            if (isInGlobalRoom) {
                onlineBadge.classList.remove('hidden');
                countSpan.innerText = onlineCount;
                
                // Update header
                document.getElementById('header-title').innerText = `üåç UChat All`;
                document.getElementById('peer-count').innerText = onlineCount;
            }
        }
        
        function appendSystemMessage(text) {
            const chatBox = document.getElementById('chat-box');
            if(chatBox.querySelector('h3')) chatBox.innerHTML = '';
            
            const div = document.createElement('div');
            div.className = 'flex justify-center my-2 animate-fade-in';
            div.innerHTML = `
                <span class="px-3 py-1 rounded-full text-[10px] font-medium" style="background: var(--color-surface); color: var(--color-text-secondary)">
                    ${text}
                </span>
            `;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        function sendGlobalMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text || !isInGlobalRoom) return;
            
            const msgId = `global-msg-${++messageIdCounter}`;
            
            // Send to all global room users
            const payload = {
                type: 'global-text',
                content: text,
                sender: myName,
                msgId: msgId,
                replyTo: replyingTo
            };
            
            broadcastToGlobalRoom(payload);
            appendMessage(text, 'out', myName, replyingTo, msgId);
            
            input.value = '';
            cancelReply();
        }
        
        function updateMyName() { 
            myName = document.getElementById('my-name-input').value.trim() || 'User'; 
            localStorage.setItem('uchat_name', myName);
            updateProfileAvatar();
            
            // Update local video name
            const localVideoName = document.getElementById('local-video-name');
            if (localVideoName) localVideoName.innerText = myName;
            
            // Broadcast name update to peers
            const payload = { type: 'meta', sub: 'name-update', name: myName };
            if (isHost || myMode === 'direct') broadcastData(payload); 
            else if (hostConn && hostConn.open) hostConn.send(payload);
            
            showToast("Name updated!", "success");
        }
        
        function copyId() { 
            navigator.clipboard.writeText(document.getElementById('my-id').innerText); 
            showToast("ID Copied to clipboard!", "success"); 
        }
        
        function formatBytes(bytes) { 
            if(bytes === 0) return '0 B'; 
            const i = Math.floor(Math.log(bytes)/Math.log(1024)); 
            return parseFloat((bytes/Math.pow(1024, i)).toFixed(2)) + ' ' + ['B','KB','MB','GB','TB'][i]; 
        }
        
        function handleTyping() {
            // Check if typing indicator is disabled
            if (privacySettings.disableTypingIndicator) return;
            
            // Typing indicator functionality
            if (typingTimeout) clearTimeout(typingTimeout);
            
            // Send typing indicator
            const payload = { type: 'typing', sender: myName };
            if (isHost || myMode === 'direct') {
                broadcastData(payload);
            } else if (hostConn && hostConn.open) {
                hostConn.send(payload);
            }
            
            typingTimeout = setTimeout(() => {
                // Send stopped typing
            }, 3000);
        }
        
        function showToast(msg, type) { 
            const colors = { 
                error: 'background: #ef4444; color: white;', 
                success: 'background: #22c55e; color: white;', 
                info: 'background: var(--color-primary); color: white;', 
                warning: 'background: #f59e0b; color: white;' 
            }; 
            const icons = { 
                error: 'fa-exclamation-circle', 
                success: 'fa-check-circle', 
                info: 'fa-info-circle', 
                warning: 'fa-exclamation-triangle' 
            }; 
            
            const t = document.createElement('div'); 
            t.className = 'px-4 py-3 rounded-xl text-sm font-medium shadow-2xl mb-2 animate-slide-in flex items-center gap-3 min-w-[200px] max-w-[90vw] md:max-w-sm pointer-events-auto'; 
            t.style.cssText = colors[type] || colors.info;
            t.innerHTML = `<i class="fas ${icons[type] || icons.info} text-lg flex-shrink-0"></i><span class="truncate">${msg}</span>`; 
            
            document.getElementById('toast-container').appendChild(t); 
            
            setTimeout(() => { 
                t.style.opacity = '0'; 
                t.style.transform = 'translateY(-10px)'; 
                t.style.transition = 'all 0.3s'; 
                setTimeout(() => t.remove(), 300); 
            }, 3500); 
        }
        
        // Load friends list with theme-aware styling
        function loadFriends() {
            const listEl = document.getElementById('friends-list');
            const friends = JSON.parse(localStorage.getItem('uchat_friends') || '[]');
            if (friends.length === 0) { 
                listEl.innerHTML = '<p class="text-xs text-center py-3" style="color: var(--color-text-secondary)">No friends saved yet.</p>'; 
                return; 
            }
            listEl.innerHTML = '';
            friends.forEach(friend => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-2.5 rounded-xl transition group cursor-pointer hover:scale-[1.02]";
                div.style.cssText = "background: var(--color-dark); border: 1px solid var(--color-border);";
                div.innerHTML = `
                    <div class="overflow-hidden flex-1" onclick="fillId('${friend.id}')">
                        <p class="text-xs font-bold truncate" style="color: var(--color-text-primary)">${friend.name}</p>
                        <p class="text-[10px] font-mono" style="color: var(--color-text-secondary)">${friend.id}</p>
                    </div>
                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition">
                        <button onclick="fillId('${friend.id}')" class="w-7 h-7 rounded-full flex items-center justify-center transition hover:scale-110" style="background: var(--color-primary); color: white" title="Use ID">
                            <i class="fas fa-arrow-up text-xs"></i>
                        </button>
                        <button onclick="deleteFriend('${friend.id}')" class="w-7 h-7 rounded-full flex items-center justify-center transition hover:scale-110" style="background: #ef4444; color: white" title="Delete">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>`;
                listEl.appendChild(div);
            });
        }
        
        function toggleFriendForm() { 
            const form = document.getElementById('friend-form'); 
            form.classList.toggle('hidden'); 
            if(!form.classList.contains('hidden')) {
                document.getElementById('friend-name').focus();
            }
        }
        
        function saveFriend() {
            const name = document.getElementById('friend-name').value.trim(); 
            const id = document.getElementById('friend-id').value.trim();
            if (!name || !id) return showToast("Name and ID required", "error");
            let friends = JSON.parse(localStorage.getItem('uchat_friends') || '[]');
            if (friends.some(f => f.id === id)) { 
                showCustomConfirm("Duplicate Friend", "Friend with this ID exists. Overwrite?", () => { 
                    friends = friends.filter(f => f.id !== id); 
                    pushFriend(friends, name, id); 
                }); 
                return; 
            }
            pushFriend(friends, name, id);
        }
        
        function pushFriend(friends, name, id) {
            friends.push({ name, id }); 
            localStorage.setItem('uchat_friends', JSON.stringify(friends));
            document.getElementById('friend-name').value = ''; 
            document.getElementById('friend-id').value = '';
            toggleFriendForm(); 
            loadFriends(); 
            showToast("Friend Saved!", "success");
        }
        
        function deleteFriend(id) {
            showCustomConfirm("Remove Friend?", "Are you sure you want to delete this friend?", () => {
                let friends = JSON.parse(localStorage.getItem('uchat_friends') || '[]'); 
                friends = friends.filter(f => f.id !== id);
                localStorage.setItem('uchat_friends', JSON.stringify(friends)); 
                loadFriends(); 
                showToast("Friend Removed", "info");
            });
        }
        
        function fillId(id) { 
            document.getElementById('remote-id').value = id; 
            document.getElementById('btn-direct').style.animation = 'pulse 0.5s ease-in-out 2';
            setTimeout(() => {
                document.getElementById('btn-direct').style.animation = '';
            }, 1000);
            showToast("ID filled! Choose connection type.", "info");
        }
        
        // ============================================
        // HIGH PERFORMANCE FEATURES
        // ============================================
        
        // --- E2E Encryption ---
        async function generateEncryptionKey() {
            try {
                const key = await crypto.subtle.generateKey(
                    { name: 'AES-GCM', length: 256 },
                    true,
                    ['encrypt', 'decrypt']
                );
                encryptionKey = key;
                console.log('E2E Encryption ready');
            } catch (e) {
                console.log('Encryption not available:', e);
            }
        }
        
        async function encryptMessage(text) {
            if (!encryptionKey) return text;
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(text);
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const encrypted = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv: iv },
                    encryptionKey,
                    data
                );
                return {
                    encrypted: true,
                    iv: Array.from(iv),
                    data: Array.from(new Uint8Array(encrypted))
                };
            } catch (e) {
                return text;
            }
        }
        
        async function decryptMessage(encData) {
            if (!encryptionKey || !encData.encrypted) return encData;
            try {
                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: new Uint8Array(encData.iv) },
                    encryptionKey,
                    new Uint8Array(encData.data)
                );
                return new TextDecoder().decode(decrypted);
            } catch (e) {
                return '[Encrypted Message]';
            }
        }
        
        // --- Message Search ---
        function openSearchModal() {
            document.getElementById('search-modal').classList.remove('hidden');
            document.getElementById('search-input').focus();
        }
        
        function closeSearchModal() {
            document.getElementById('search-modal').classList.add('hidden');
            document.getElementById('search-input').value = '';
            document.getElementById('search-results').innerHTML = '<p class="text-center py-6 text-sm" style="color: var(--color-text-secondary)">Type to search...</p>';
        }
        
        function searchMessages(query) {
            const resultsEl = document.getElementById('search-results');
            if (!query.trim()) {
                resultsEl.innerHTML = '<p class="text-center py-6 text-sm" style="color: var(--color-text-secondary)">Type to search...</p>';
                return;
            }
            
            const matches = messageHistory.filter(m => 
                m.content && m.content.toLowerCase().includes(query.toLowerCase())
            );
            
            if (matches.length === 0) {
                resultsEl.innerHTML = '<p class="text-center py-6 text-sm" style="color: var(--color-text-secondary)">No messages found</p>';
                return;
            }
            
            resultsEl.innerHTML = matches.map(m => {
                const highlightedText = m.content.replace(
                    new RegExp(`(${query})`, 'gi'),
                    '<span class="search-highlight">$1</span>'
                );
                return `
                    <div class="search-result-item" onclick="scrollToMessage('${m.id}')">
                        <p class="text-[10px] mb-1" style="color: var(--color-text-secondary)">${m.sender} ‚Ä¢ ${m.time}</p>
                        <p class="text-sm" style="color: var(--color-text-primary)">${highlightedText}</p>
                    </div>`;
            }).join('');
        }
        
        // --- Reply System ---
        function setReplyTo(msgId, sender, text) {
            replyingTo = { id: msgId, sender, text };
            document.getElementById('reply-to-name').innerText = `Replying to ${sender}`;
            document.getElementById('reply-to-text').innerText = text.substring(0, 50) + (text.length > 50 ? '...' : '');
            document.getElementById('reply-bar').classList.remove('hidden');
            document.getElementById('msg-input').focus();
        }
        
        function cancelReply() {
            replyingTo = null;
            document.getElementById('reply-bar').classList.add('hidden');
        }
        
        function replyToMessage() {
            hideContextMenu();
            const msg = messageHistory.find(m => m.id === selectedMessageId);
            if (msg) {
                const content = msg.content || msg.type || '[Media]';
                setReplyTo(msg.id, msg.sender, content);
            }
        }
        
        function scrollToMessage(msgId) {
            closeSearchModal();
            const msgEl = document.getElementById(msgId);
            if (msgEl) {
                msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                msgEl.classList.add('message-highlight');
                setTimeout(() => msgEl.classList.remove('message-highlight'), 2000);
            }
        }
        
        // --- Message Reactions ---
        function showReactionPicker(msgId, x, y) {
            selectedMessageId = msgId;
            const picker = document.getElementById('reaction-picker');
            picker.style.left = `${Math.min(x, window.innerWidth - 200)}px`;
            picker.style.top = `${y - 50}px`;
            picker.classList.remove('hidden');
        }
        
        function hideReactionPicker() {
            document.getElementById('reaction-picker').classList.add('hidden');
        }
        
        function addReaction(emoji) {
            hideReactionPicker();
            hideContextMenu();
            
            if (!selectedMessageId) return;
            
            // Find message and add reaction
            const msg = messageHistory.find(m => m.id === selectedMessageId);
            if (msg) {
                if (!msg.reactions) msg.reactions = {};
                if (!msg.reactions[emoji]) msg.reactions[emoji] = [];
                
                if (!msg.reactions[emoji].includes(myName)) {
                    msg.reactions[emoji].push(myName);
                    updateMessageReactions(selectedMessageId, msg.reactions);
                    
                    // Broadcast reaction
                    const payload = { type: 'reaction', msgId: selectedMessageId, emoji, user: myName };
                    if (isHost || myMode === 'direct') broadcastData(payload);
                    else if (hostConn && hostConn.open) hostConn.send(payload);
                }
            }
        }
        
        function addReactionFromMenu() {
            hideContextMenu();
            const msgEl = document.getElementById(selectedMessageId);
            if (msgEl) {
                const rect = msgEl.getBoundingClientRect();
                showReactionPicker(selectedMessageId, rect.left, rect.top);
            }
        }
        
        function updateMessageReactions(msgId, reactions) {
            const msgEl = document.getElementById(msgId);
            if (!msgEl) return;
            
            let reactionsEl = msgEl.querySelector('.message-reactions');
            if (!reactionsEl) {
                const bubble = msgEl.querySelector('.chat-bubble');
                if (bubble) {
                    reactionsEl = document.createElement('div');
                    reactionsEl.className = 'message-reactions';
                    bubble.appendChild(reactionsEl);
                }
            }
            
            if (reactionsEl) {
                reactionsEl.innerHTML = Object.entries(reactions).map(([emoji, users]) => 
                    `<span class="reaction-badge ${users.includes(myName) ? 'active' : ''}" onclick="addReaction('${emoji}')">${emoji} ${users.length}</span>`
                ).join('');
            }
        }
        
        // --- Context Menu ---
        function setupContextMenu() {
            document.addEventListener('contextmenu', (e) => {
                const msgEl = e.target.closest('[data-msg-id]');
                if (msgEl) {
                    e.preventDefault();
                    selectedMessageId = msgEl.id; // Use the element's id directly
                    showContextMenu(e.clientX, e.clientY);
                }
            });
            
            // Also allow long press on mobile
            let longPressTimer = null;
            document.addEventListener('touchstart', (e) => {
                const msgEl = e.target.closest('[data-msg-id]');
                if (msgEl) {
                    longPressTimer = setTimeout(() => {
                        selectedMessageId = msgEl.id;
                        const touch = e.touches[0];
                        showContextMenu(touch.clientX, touch.clientY);
                    }, 500);
                }
            });
            
            document.addEventListener('touchend', () => {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            });
            
            document.addEventListener('click', () => {
                hideContextMenu();
                hideReactionPicker();
            });
        }
        
        function showContextMenu(x, y) {
            const menu = document.getElementById('context-menu');
            menu.style.left = `${Math.min(x, window.innerWidth - 180)}px`;
            menu.style.top = `${Math.min(y, window.innerHeight - 200)}px`;
            
            // Show/hide "Delete for everyone" based on message ownership
            const deleteEveryoneOption = document.getElementById('delete-everyone-option');
            const msg = messageHistory.find(m => m.id === selectedMessageId);
            
            if (msg && msg.dir === 'out') {
                // Show delete for everyone only for own messages
                deleteEveryoneOption.classList.remove('hidden');
            } else {
                deleteEveryoneOption.classList.add('hidden');
            }
            
            menu.classList.remove('hidden');
        }
        
        function hideContextMenu() {
            document.getElementById('context-menu').classList.add('hidden');
        }
        
        function copyMessageText() {
            hideContextMenu();
            const msg = messageHistory.find(m => m.id === selectedMessageId);
            if (msg && msg.content) {
                navigator.clipboard.writeText(msg.content);
                showToast('Message copied!', 'success');
            } else {
                // Try to get text from the element
                const msgEl = document.getElementById(selectedMessageId);
                if (msgEl) {
                    const bubble = msgEl.querySelector('.chat-bubble');
                    if (bubble) {
                        navigator.clipboard.writeText(bubble.innerText);
                        showToast('Message copied!', 'success');
                    }
                }
            }
        }
        
        function forwardMessage() {
            hideContextMenu();
            const msg = messageHistory.find(m => m.id === selectedMessageId);
            if (msg && msg.content) {
                document.getElementById('msg-input').value = `[Forwarded] ${msg.content}`;
                document.getElementById('msg-input').focus();
            }
        }
        
        // --- Delete Message Functions ---
        function deleteForMe() {
            hideContextMenu();
            closeDeleteModal();
            
            const msgEl = document.getElementById(selectedMessageId);
            if (msgEl) {
                // Add to deleted set
                deletedMessages.add(selectedMessageId);
                
                // Animate and remove
                msgEl.style.opacity = '0';
                msgEl.style.transform = 'scale(0.9)';
                setTimeout(() => msgEl.remove(), 300);
                
                // Remove from message history
                messageHistory = messageHistory.filter(m => m.id !== selectedMessageId);
                showToast('Message deleted', 'info');
            }
        }
        
        function showDeleteForEveryoneConfirm() {
            hideContextMenu();
            document.getElementById('delete-modal').classList.remove('hidden');
        }
        
        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.add('hidden');
        }
        
        function deleteForEveryone() {
            closeDeleteModal();
            
            const msgEl = document.getElementById(selectedMessageId);
            if (!msgEl) return;
            
            // Check if message is from current user (can only delete own messages for everyone)
            const msg = messageHistory.find(m => m.id === selectedMessageId);
            if (msg && msg.dir !== 'out') {
                showToast("You can only delete your own messages for everyone", "error");
                return;
            }
            
            // Send delete command to all peers
            const payload = { 
                type: 'delete-for-everyone', 
                msgId: selectedMessageId,
                sender: myName,
                timestamp: Date.now()
            };
            
            if (isHost || myMode === 'direct') broadcastData(payload);
            else if (hostConn && hostConn.open) hostConn.send(payload);
            
            // Replace message content locally
            replaceWithDeletedMessage(selectedMessageId);
            showToast('Message deleted for everyone', 'success');
        }
        
        function handleDeleteForEveryone(msgId, sender) {
            replaceWithDeletedMessage(msgId);
            showToast(`${sender} deleted a message`, 'info');
        }
        
        function replaceWithDeletedMessage(msgId) {
            const msgEl = document.getElementById(msgId);
            if (!msgEl) return;
            
            // Find the chat bubble or message container and replace content
            const bubble = msgEl.querySelector('.chat-bubble');
            const container = msgEl.querySelector('.max-w-\\[85\\%\\], .max-w-\\[70\\%\\], .max-w-\\[80\\%\\]') || msgEl.querySelector('[class*="max-w-"]');
            
            if (bubble) {
                // Standard text/voice message with chat-bubble
                bubble.innerHTML = `
                    <span class="deleted-message">
                        <i class="fas fa-ban mr-1"></i> This message was deleted
                    </span>`;
                bubble.style.background = 'var(--color-surface)';
                bubble.style.opacity = '0.7';
                // Remove audio if it's a voice message
                const audio = msgEl.querySelector('audio');
                if (audio) audio.remove();
            } else if (container) {
                // For image/video messages without chat-bubble class, find and replace the media element
                const media = msgEl.querySelector('img, video, audio');
                const mediaContainer = media ? media.closest('div[onclick]') || media.parentElement : null;
                
                if (mediaContainer) {
                    mediaContainer.innerHTML = `
                        <div class="p-4 rounded-2xl flex items-center justify-center gap-2" style="background: var(--color-surface); opacity: 0.7; min-width: 150px;">
                            <span class="deleted-message">
                                <i class="fas fa-ban mr-1"></i> This message was deleted
                            </span>
                        </div>`;
                    mediaContainer.onclick = null;
                    mediaContainer.style.cursor = 'default';
                }
            }
            
            // Update message history
            const msgIndex = messageHistory.findIndex(m => m.id === msgId);
            if (msgIndex !== -1) {
                messageHistory[msgIndex].deleted = true;
                messageHistory[msgIndex].content = '[Message deleted]';
            }
        }
        
        function deleteMessage() {
            // Kept for backwards compatibility - now shows modal
            showDeleteForEveryoneConfirm();
        }
        
        // --- Drag & Drop ---
        function setupDragAndDrop() {
            const body = document.body;
            const overlay = document.getElementById('drag-overlay');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
                body.addEventListener(event, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });
            
            body.addEventListener('dragenter', () => {
                overlay.classList.add('active');
            });
            
            body.addEventListener('dragleave', (e) => {
                if (e.target === body || e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
            
            body.addEventListener('drop', (e) => {
                overlay.classList.remove('active');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleDroppedFiles(files);
                }
            });
        }
        
        function handleDroppedFiles(files) {
            if (!isHost && (!hostConn || !hostConn.open) && myMode !== 'direct' && connections.length === 0) {
                showToast('Connect to someone first!', 'error');
                return;
            }
            
            Array.from(files).forEach(file => {
                let previewType = null;
                if (file.type.startsWith('image/')) previewType = 'image';
                else if (file.type.startsWith('video/')) previewType = 'video';
                
                if (file.size < 5 * 1024 * 1024) {
                    const payload = { type: 'file', file, filename: file.name, filetype: file.type, filesize: file.size, previewType, sender: myName };
                    if (isHost || myMode === 'direct') broadcastData(payload);
                    else if (hostConn) hostConn.send(payload);
                    
                    const url = URL.createObjectURL(file);
                    if (previewType === 'image') appendImageMessage(url, 'out', 'Me', file.name);
                    else if (previewType === 'video') appendVideoMessage(url, 'out', 'Me', file.name);
                    else appendFileMessage(file.name, file.size, 'out', url, file.type, 'Me');
                } else {
                    sendChunkedFile(file, previewType);
                }
            });
            
            showToast(`${files.length} file(s) uploaded`, 'success');
        }
        
        // --- Picture in Picture ---
        async function togglePiP() {
            const video = document.getElementById('local-video');
            if (!video || !video.srcObject) {
                showToast('Start video first', 'error');
                return;
            }
            
            try {
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                    isPiPActive = false;
                    showToast('PiP closed', 'info');
                } else if (document.pictureInPictureEnabled) {
                    await video.requestPictureInPicture();
                    isPiPActive = true;
                    showToast('Picture-in-Picture active', 'success');
                }
            } catch (e) {
                console.error('PiP error:', e);
                showToast('PiP not supported', 'error');
            }
        }
        
        // --- Voice Activity Visualization ---
        function startVoiceVisualization(stream) {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioAnalyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(audioAnalyser);
                audioAnalyser.fftSize = 32;
                
                const dataArray = new Uint8Array(audioAnalyser.frequencyBinCount);
                
                voiceVisualizerInterval = setInterval(() => {
                    audioAnalyser.getByteFrequencyData(dataArray);
                    updateVoiceBars('local-voice-viz', dataArray);
                    updateVoiceBars('recording-visualizer', dataArray);
                }, 50);
            } catch (e) {
                console.log('Voice visualization not available:', e);
            }
        }
        
        function updateVoiceBars(vizId, dataArray) {
            const viz = document.getElementById(vizId);
            if (!viz) return;
            
            const bars = viz.querySelectorAll('.voice-bar');
            bars.forEach((bar, i) => {
                const value = dataArray[i % dataArray.length] || 0;
                const height = Math.max(4, (value / 255) * 20);
                bar.style.height = `${height}px`;
            });
        }
        
        function stopVoiceVisualization() {
            if (voiceVisualizerInterval) clearInterval(voiceVisualizerInterval);
            if (audioContext) audioContext.close();
            audioContext = null;
            audioAnalyser = null;
        }
        
        // --- Desktop Notifications ---
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    notificationsEnabled = permission === 'granted';
                });
            } else if (Notification.permission === 'granted') {
                notificationsEnabled = true;
            }
        }
        
        function sendNotification(title, body, icon = 'üì±') {
            if (!notificationsEnabled || document.hasFocus()) return;
            
            try {
                const notification = new Notification(title, {
                    body: body,
                    icon: icon,
                    badge: icon,
                    tag: 'uchat-notification',
                    renotify: true
                });
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
                
                setTimeout(() => notification.close(), 5000);
            } catch (e) {
                console.log('Notification error:', e);
            }
        }
        
        // --- GIF Picker ---
        function openGifPicker() {
            document.getElementById('gif-modal').classList.remove('hidden');
            document.getElementById('gif-search').focus();
        }
        
        function closeGifPicker() {
            document.getElementById('gif-modal').classList.add('hidden');
        }
        
        async function loadTrendingGifs() {
            // Using placeholder GIFs (in production, use Tenor/Giphy API)
            const trendingGifs = [
                'https://media.giphy.com/media/l0HlQ7LRalQqdWfao/giphy.gif',
                'https://media.giphy.com/media/3o7TKSjRrfIPjeiVyM/giphy.gif',
                'https://media.giphy.com/media/xT9IgG50Fb7Mi0prBC/giphy.gif',
                'https://media.giphy.com/media/3o6Zt6KHxJTbXCnSvu/giphy.gif',
                'https://media.giphy.com/media/l41YtZOb9EUABnuqA/giphy.gif',
                'https://media.giphy.com/media/xT0xeJpnrWC4XWblEk/giphy.gif'
            ];
            
            const grid = document.getElementById('gif-grid');
            grid.innerHTML = trendingGifs.map(url => 
                `<div class="gif-item" onclick="sendGif('${url}')"><img src="${url}" loading="lazy" alt="GIF"></div>`
            ).join('');
        }
        
        async function searchGifs(query) {
            if (!query.trim()) {
                loadTrendingGifs();
                return;
            }
            
            // Placeholder search - in production, call Tenor/Giphy API
            const grid = document.getElementById('gif-grid');
            grid.innerHTML = '<p class="col-span-2 text-center py-4 text-sm" style="color: var(--color-text-secondary)">Searching...</p>';
            
            // Simulate search delay
            setTimeout(() => loadTrendingGifs(), 500);
        }
        
        function sendGif(url) {
            closeGifPicker();
            
            const payload = { type: 'gif', url, sender: myName, timestamp: Date.now() };
            if (isHost || myMode === 'direct') broadcastData(payload);
            else if (hostConn && hostConn.open) hostConn.send(payload);
            
            appendGifMessage(url, 'out', 'Me');
        }
        
        function appendGifMessage(url, dir, sender) {
            const chatBox = document.getElementById('chat-box');
            if (chatBox.querySelector('h3')) chatBox.innerHTML = '';
            
            const msgId = `msg-${++messageIdCounter}`;
            const div = document.createElement('div');
            div.id = msgId;
            div.dataset.msgId = msgId;
            div.className = `flex w-full ${dir === 'out' ? 'justify-end' : 'justify-start'} animate-fade-in`;
            
            div.innerHTML = `
                <div class="max-w-[70%] flex flex-col ${dir === 'out' ? 'items-end' : 'items-start'}">
                    <span class="text-[9px] mb-1 px-1" style="color: var(--color-text-secondary)">${sender}</span>
                    <div class="p-1 rounded-2xl shadow-md cursor-pointer hover:opacity-90 transition" style="background: var(--color-surface); border: 1px solid var(--color-border)">
                        <img src="${url}" class="rounded-xl max-w-[200px] max-h-[200px] object-cover" loading="lazy">
                    </div>
                    <span class="text-[9px] mt-1 px-1" style="color: var(--color-text-secondary)">${getTime()}</span>
                </div>`;
            
            chatBox.appendChild(div);
            scrollToBottom();
            
            messageHistory.push({ id: msgId, type: 'gif', url, sender, time: getTime() });
        }
        
        // --- Smart Auto-Reconnect ---
        function smartReconnect() {
            if (reconnectAttempts >= 5) {
                showToast('Connection failed. Please refresh.', 'error');
                return;
            }
            
            reconnectAttempts++;
            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
            
            showToast(`Reconnecting in ${delay/1000}s... (Attempt ${reconnectAttempts}/5)`, 'warning');
            
            setTimeout(() => {
                if (peer && !peer.destroyed) {
                    peer.reconnect();
                } else {
                    initPeer();
                }
            }, delay);
        }
        
        // --- Offline Message Queue ---
        function queueOfflineMessage(payload) {
            offlineQueue.push({ payload, timestamp: Date.now() });
            showToast('Message queued for when connection is restored', 'info');
        }
        
        function flushOfflineQueue() {
            if (offlineQueue.length === 0) return;
            
            showToast(`Sending ${offlineQueue.length} queued message(s)...`, 'info');
            
            offlineQueue.forEach(item => {
                if (isHost || myMode === 'direct') broadcastData(item.payload);
                else if (hostConn && hostConn.open) hostConn.send(item.payload);
            });
            
            offlineQueue = [];
        }
        
        // --- Read Receipts ---
        function sendReadReceipt(msgId) {
            // Check if read receipts are disabled
            if (privacySettings.disableReadReceipts) return;
            
            const payload = { type: 'read-receipt', msgId, reader: myName, timestamp: Date.now() };
            if (isHost || myMode === 'direct') broadcastData(payload);
            else if (hostConn && hostConn.open) hostConn.send(payload);
        }
        
        function updateReadReceipt(msgId, status) {
            const msgEl = document.getElementById(msgId);
            if (!msgEl) return;
            
            const bubble = msgEl.querySelector('.chat-bubble');
            if (!bubble) return;
            
            let receiptEl = msgEl.querySelector('.read-receipt');
            if (!receiptEl) {
                receiptEl = document.createElement('span');
                receiptEl.className = 'read-receipt';
                bubble.appendChild(receiptEl);
            }
            
            if (status === 'read') {
                receiptEl.className = 'read-receipt read';
                receiptEl.innerHTML = '<i class="fas fa-check-double"></i>';
            } else if (status === 'delivered') {
                receiptEl.className = 'read-receipt delivered';
                receiptEl.innerHTML = '<i class="fas fa-check-double"></i>';
            } else {
                receiptEl.className = 'read-receipt sent';
                receiptEl.innerHTML = '<i class="fas fa-check"></i>';
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Escape to close modals
            if (e.key === 'Escape') {
                closeMediaModal();
                closeEmojiPicker();
                closeStatsModal();
                closeParticipantsModal();
                closeCustomModal();
                closeSearchModal();
                closeGifPicker();
                closeDeleteModal();
                closeViewOnceModal();
                cancelReply();
                hideContextMenu();
                hideReactionPicker();
            }
            // Ctrl+F to search
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                openSearchModal();
            }
            // Ctrl+G for GIF
            if (e.ctrlKey && e.key === 'g') {
                e.preventDefault();
                openGifPicker();
            }
            // P to open participants
            if (e.key === 'p' && !e.ctrlKey && !e.altKey && myMode !== 'idle') {
                if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                    openParticipantsModal();
                }
            }
            // M to toggle mute
            if (e.key === 'm' && !e.ctrlKey && !e.altKey) {
                if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                    toggleAudio();
                }
            }
            // V to toggle video
            if (e.key === 'v' && !e.ctrlKey && !e.altKey) {
                if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                    toggleVideo();
                }
            }
        });
        
        // Handle visibility change (pause/resume)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // Reset unread count when tab becomes visible
                unreadCount = 0;
                document.title = 'UChat | Connect Freely';
            }
        });
        
        // Update page title with unread count
        function updateUnreadBadge() {
            if (document.hidden && unreadCount > 0) {
                document.title = `(${unreadCount}) UChat | New Messages`;
            }
        }
    </script>
</body>
</html>
